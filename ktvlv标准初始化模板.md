# ktvlv æ ‡å‡†åˆå§‹åŒ–æ¨¡æ¿

## ğŸ¯ é€‚ç”¨äº Windows SDL & F133 é€šç”¨åˆå§‹åŒ–æµç¨‹

æœ¬æ–‡æ¡£æä¾› ktvlv é¡¹ç›®çš„æ ‡å‡†åˆå§‹åŒ–æ¨¡æ¿ï¼Œç¡®ä¿ UI åˆå§‹åŒ–é¡ºåºæ­£ç¡®ï¼Œé¿å… 0xC0000005 å´©æºƒå’Œé¦–å¸§åˆ·æ–°é—®é¢˜ã€‚

---

## ğŸ“‹ å®Œæ•´çš„åˆå§‹åŒ–é¡ºåº

```cpp
// ============================================================
// 1ï¸âƒ£ LVGL åˆå§‹åŒ–
// ============================================================
lv_init();

// ============================================================
// 2ï¸âƒ£ æ˜¾ç¤ºé©±åŠ¨åˆå§‹åŒ–ï¼ˆSDL/FBï¼‰
// ============================================================
lv_disp_draw_buf_t draw_buf;
lv_color_t buf1[LV_HOR_RES_MAX * 100];
lv_color_t buf2[LV_HOR_RES_MAX * 100];
lv_disp_draw_buf_init(&draw_buf, buf1, buf2, LV_HOR_RES_MAX * 100);

lv_disp_drv_t disp_drv;
lv_disp_drv_init(&disp_drv);
disp_drv.flush_cb = sdl_display_flush;  // æˆ– fbdev_display_flush (F133)
disp_drv.draw_buf = &draw_buf;
disp_drv.hor_res = LV_HOR_RES_MAX;
disp_drv.ver_res = LV_VER_RES_MAX;
lv_disp_t* disp = lv_disp_drv_register(&disp_drv);

// ============================================================
// 3ï¸âƒ£ è¾“å…¥é©±åŠ¨åˆå§‹åŒ–
// ============================================================
lv_indev_drv_t indev_drv;
lv_indev_drv_init(&indev_drv);
indev_drv.type = LV_INDEV_TYPE_POINTER;  // æˆ– LV_INDEV_TYPE_KEYPAD
indev_drv.read_cb = sdl_mouse_read;      // æˆ– evdev_read (F133)
lv_indev_drv_register(&indev_drv);

// ============================================================
// 4ï¸âƒ£ UI ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆä¸»é¢˜ã€ç¼©æ”¾ã€ç„¦ç‚¹ï¼‰
// ============================================================
ktv::ui::init_ui_system(LV_HOR_RES_MAX, LV_VER_RES_MAX);

// ============================================================
// 5ï¸âƒ£ æœåŠ¡åˆå§‹åŒ–
// ============================================================
ktv::services::HttpService::getInstance().initialize(base_url, timeout);
ktv::services::LicenceService::getInstance().initialize();
ktv::services::HistoryService::getInstance().setCapacity(50);
ktv::services::M3u8DownloadService::getInstance().initialize();

// ============================================================
// 6ï¸âƒ£ åˆ›å»ºä¸»å±å¹•
// ============================================================
lv_obj_t* scr = ktv::ui::create_main_screen();
if (!scr || !lv_obj_is_valid(scr)) {
    // é”™è¯¯å¤„ç†
    return -1;
}

// ============================================================
// 7ï¸âƒ£ åŠ è½½å±å¹•å¹¶è®¾ç½®å°ºå¯¸
// ============================================================
lv_scr_load(scr);
lv_obj_set_size(scr, LV_HOR_RES_MAX, LV_VER_RES_MAX);

// çŸ­æš‚å»¶è¿Ÿï¼Œè®©å¯¹è±¡åˆ›å»ºå®Œæˆï¼ˆä½†ä¸è§¦å‘åˆ·æ–°ï¼‰
SDL_Delay(20);  // æˆ– usleep(20000) (F133)

// ============================================================
// 8ï¸âƒ£ ä¸»å¾ªç¯ï¼ˆå¸¦é¦–æ¬¡åˆ·æ–°ä¿æŠ¤ï¼‰
// ============================================================
bool first_refresh_done = false;
int ready_check_count = 0;

while (!quit) {
    // âœ… é¦–æ¬¡åˆ·æ–°ä¿æŠ¤ï¼šç¡®ä¿å±å¹•å®Œå…¨readyåå†åˆ·æ–°
    if (!first_refresh_done) {
        ready_check_count++;
        if (is_screen_ready_for_refresh(ready_check_count)) {
            first_refresh_done = true;
            fprintf(stderr, "ğŸ”¥ First refresh: Screen is READY, entering normal cycle\n");
        } else {
            if (ready_check_count <= 5) {
                fprintf(stderr, "First refresh: screen not ready yet (check #%d), skipping...\n", 
                        ready_check_count);
            }
            SDL_Delay(10);  // æˆ– usleep(10000) (F133)
            continue;
        }
    }
    
    // æ­£å¸¸åˆ·æ–°æµç¨‹
    uint32_t delay = lv_timer_handler();
    SDL_Delay(delay > 5 ? delay : 5);  // æˆ– usleep((delay > 5 ? delay : 5) * 1000) (F133)
    
    // å¤„ç†è¾“å…¥äº‹ä»¶
    // ...
}
```

---

## ğŸ” READY åˆ¤å®šæ ‡å‡†ï¼ˆä¸‰é¡¹å¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰

```cpp
/**
 * @brief æ£€æŸ¥å±å¹•æ˜¯å¦readyï¼Œå¯ä»¥å®‰å…¨åˆ·æ–°
 * 
 * READY åˆ¤å®šæ ‡å‡†ï¼š
 * 1. âœ… å±å¹•å¯¹è±¡å­˜åœ¨ä¸”æœ‰æ•ˆ
 * 2. âœ… å±å¹•å°ºå¯¸æ­£å¸¸ï¼ˆwidth > 0 && height > 0ï¼‰
 * 3. âœ… å±å¹•æœ‰è‡³å°‘ä¸€ä¸ªå­å¯¹è±¡ï¼ˆKTVç•Œé¢ä¸åº”è¯¥ä¸ºç©ºå±ï¼‰
 */
static bool is_screen_ready_for_refresh(int check_count = 0) {
    // 1. æ£€æŸ¥å±å¹•æ˜¯å¦å­˜åœ¨
    lv_obj_t* scr = lv_scr_act();
    if (scr == NULL) {
        if (check_count < 3) {
            fprintf(stderr, "Screen ready check #%d: Screen not exist yet\n", check_count);
        }
        return false;
    }
    
    // 2. æ£€æŸ¥å±å¹•å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
    if (!lv_obj_is_valid(scr)) {
        if (check_count < 3) {
            fprintf(stderr, "Screen ready check #%d: Screen object is invalid\n", check_count);
        }
        return false;
    }
    
    // 3. æ£€æŸ¥å±å¹•å°ºå¯¸æ˜¯å¦æ­£å¸¸
    lv_coord_t width = lv_obj_get_width(scr);
    lv_coord_t height = lv_obj_get_height(scr);
    if (width <= 0 || height <= 0) {
        if (check_count < 3) {
            fprintf(stderr, "Screen ready check #%d: Screen size invalid (width=%d, height=%d)\n", 
                    check_count, (int)width, (int)height);
        }
        return false;
    }
    
    // 4. æ£€æŸ¥æ˜¯å¦æœ‰è‡³å°‘ä¸€ä¸ªå¯è§å­å¯¹è±¡ï¼ˆKTVç•Œé¢ä¸åº”è¯¥ä¸ºç©ºå±ï¼‰
    uint32_t child_cnt = lv_obj_get_child_cnt(scr);
    if (child_cnt == 0) {
        if (check_count < 3) {
            fprintf(stderr, "Screen ready check #%d: Screen empty (no children)\n", check_count);
        }
        return false;
    }
    
    // å…¨éƒ¨æ¡ä»¶æ»¡è¶³ï¼Œå±å¹•å·²READY
    if (check_count < 3) {
        fprintf(stderr, "Screen ready check #%d: âœ… All conditions met (size=%dx%d, children=%u), READY!\n", 
                check_count, (int)width, (int)height, (unsigned)child_cnt);
    }
    return true;
}
```

---

## âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹

### 1. ä¸è¦åœ¨åˆå§‹åŒ–é˜¶æ®µç«‹å³åˆ·æ–°

âŒ **é”™è¯¯åšæ³•ï¼š**
```cpp
lv_scr_load(scr);
lv_obj_update_layout(scr);  // âŒ è¿‡æ—©
lv_obj_invalidate(scr);      // âŒ è¿‡æ—©
lv_timer_handler();          // âŒ è¿‡æ—©
```

âœ… **æ­£ç¡®åšæ³•ï¼š**
```cpp
lv_scr_load(scr);
lv_obj_set_size(scr, LV_HOR_RES_MAX, LV_VER_RES_MAX);  // âœ… å®‰å…¨æ“ä½œ
SDL_Delay(20);  // âœ… è®©å¯¹è±¡åˆ›å»ºå®Œæˆ
// è¿›å…¥ä¸»å¾ªç¯åå†åˆ·æ–°
```

### 2. é¦–æ¬¡åˆ·æ–°å¿…é¡»åœ¨ä¸»å¾ªç¯ä¸­è¿›è¡Œ

âœ… **æ­£ç¡®æµç¨‹ï¼š**
```
åˆ›å»ºå±å¹• â†’ åŠ è½½å±å¹• â†’ è®¾ç½®å°ºå¯¸ â†’ å»¶è¿Ÿ â†’ è¿›å…¥ä¸»å¾ªç¯ â†’ æ£€æŸ¥READY â†’ é¦–æ¬¡åˆ·æ–°
```

### 3. READY æ£€æŸ¥çš„ä¸‰é¡¹æ ‡å‡†

å¿…é¡»åŒæ—¶æ»¡è¶³ï¼š
- å±å¹•å¯¹è±¡å­˜åœ¨ä¸”æœ‰æ•ˆ
- å±å¹•å°ºå¯¸æ­£å¸¸ï¼ˆwidth > 0 && height > 0ï¼‰
- å±å¹•æœ‰è‡³å°‘ä¸€ä¸ªå­å¯¹è±¡

---

## ğŸš€ å¹³å°é€‚é…

### Windows SDL
```cpp
SDL_Delay(ms);  // å»¶è¿Ÿ
SDL_Event e;    // äº‹ä»¶å¤„ç†
```

### F133 Linux
```cpp
usleep(ms * 1000);  // å»¶è¿Ÿï¼ˆå¾®ç§’ï¼‰
// evdev äº‹ä»¶å¤„ç†
```

---

## ğŸ“Š åˆå§‹åŒ–æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   lv_init()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  init_display()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   init_input()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ init_ui_system() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  init_services() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚create_main_screenâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  lv_scr_load()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  set_size + delay â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»å¾ªç¯å¼€å§‹      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥READYæ¡ä»¶     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚  READY? â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ é¦–æ¬¡åˆ·æ–° â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­£å¸¸åˆ·æ–°å¾ªç¯     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… éªŒè¯æ¸…å•

åˆå§‹åŒ–å®Œæˆåï¼Œæ£€æŸ¥ä»¥ä¸‹é¡¹ï¼š

- [ ] å±å¹•å¯¹è±¡åˆ›å»ºæˆåŠŸ
- [ ] å±å¹•å·²åŠ è½½ï¼ˆ`lv_scr_act()` è¿”å›æœ‰æ•ˆå¯¹è±¡ï¼‰
- [ ] å±å¹•å°ºå¯¸å·²è®¾ç½®ï¼ˆwidth > 0 && height > 0ï¼‰
- [ ] å±å¹•æœ‰å­å¯¹è±¡ï¼ˆ`lv_obj_get_child_cnt() > 0`ï¼‰
- [ ] é¦–æ¬¡åˆ·æ–°åœ¨ä¸»å¾ªç¯ä¸­è¿›è¡Œ
- [ ] æ—  0xC0000005 å´©æºƒ
- [ ] UI æ­£å¸¸æ˜¾ç¤º

---

## ğŸ“ æ€»ç»“

> **ktvlv æ ‡å‡†åˆå§‹åŒ–åŸåˆ™ï¼š**
> 
> 1. ä¸¥æ ¼æŒ‰ç…§é¡ºåºåˆå§‹åŒ–ï¼šLVGL â†’ æ˜¾ç¤º â†’ è¾“å…¥ â†’ UIç³»ç»Ÿ â†’ æœåŠ¡ â†’ å±å¹•åˆ›å»º
> 2. å±å¹•åŠ è½½åä¸ç«‹å³åˆ·æ–°ï¼Œå»¶è¿Ÿåˆ°ä¸»å¾ªç¯
> 3. é¦–æ¬¡åˆ·æ–°å‰å¿…é¡»é€šè¿‡ READY æ£€æŸ¥ï¼ˆä¸‰é¡¹æ ‡å‡†ï¼‰
> 4. è®© LVGL è‡ªç„¶å¤„ç†å¸ƒå±€è®¡ç®—å’Œåˆ·æ–°

éµå¾ªæ­¤æ¨¡æ¿ï¼Œå¯ä»¥ç¡®ä¿ Windows SDL å’Œ F133 å¹³å°éƒ½èƒ½ç¨³å®šè¿è¡Œï¼Œé¿å…åˆå§‹åŒ–é˜¶æ®µçš„å´©æºƒå’Œåˆ·æ–°é—®é¢˜ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2025-12-29  
**é€‚ç”¨å¹³å°ï¼š** Windows SDL, F133 Linux

