# KTV应用项目架构设计总览

> **文档版本**：v1.0  
> **最后更新**：2024  
> **技术栈**：C++17 + LVGL + TPlayer

## 文档索引

> **维护规范**：详见 [文档维护规范.md](./文档维护规范.md) - 确保文档和代码的唯一性、一致性

本项目架构设计文档分为以下几个部分：

### 核心架构文档

1. **[项目架构设计总览.md](./项目架构设计总览.md)**（本文档）
   - 项目概述
   - 文档索引
   - 架构总览
   - 快速开始

2. **[F133_KTV移植方案总结.md](./F133_KTV移植方案总结.md)**
   - F133平台SDK文档分析
   - TPlayer播放器API说明
   - m3u8多音轨支持方案
   - 硬件解码和显示系统

3. **[MVP版本UI设计说明.md](./MVP版本UI设计说明.md)**
   - MVP版本功能清单
   - 顶部菜单栏设计（首页/历史记录）
   - 历史记录功能详细设计（50首限制）
   - UI布局和交互设计

4. **[页面架构分析与复用方案.md](./页面架构分析与复用方案.md)**
   - 页面总览（10个页面）
   - 可复用框架分析（4个框架）
   - 框架复用度统计
   - 开发优先级建议

5. **[C++架构设计-预分配内存版本.md](./C++架构设计-预分配内存版本.md)** ⭐ **主要实现文档（推荐）**
   - 预分配内存设计原则
   - 零动态内存分配
   - 单例页面（静态存储）
   - 固定大小数组和字符串
   - **所有页面预分配，避免内存泄漏**

6. **[开源库选型指南.md](./开源库选型指南.md)** ⭐ **库选型文档**
   - 开源库选型原则
   - 推荐库清单（libcurl、cJSON、inih等）
   - 库集成方案
   - **尽量不造轮子，使用现成库，低代码实现**

7. **[HTTP_REST_API客户端设计.md](./HTTP_REST_API客户端设计.md)** ⭐ **网络层设计**
   - HTTP REST API客户端设计（libcurl）
   - 歌曲数据服务（SongService）
   - API接口定义和调用示例
   - **服务器端使用HTTP REST API + JSON，客户端实现即可**

11. **[线程与事件系统设计.md](./线程与事件系统设计.md)** ⭐ **线程与事件设计**
   - 线程设计（2-3个线程，最小化）
   - 事件系统设计（事件类型、事件处理）
   - 无锁消息队列（moodycamel::ConcurrentQueue开源库）
   - **尽量少线程、尽量无锁、解耦合、避免造轮子（使用开源库）**

12. **[C++架构设计-页面管理系统.md](./C++架构设计-页面管理系统.md)** - 参考文档（智能指针版本）
   - 智能指针版本（仅供参考）
   - 实际项目应使用预分配内存版本

13. **[C++编码规范与避坑指南.md](./C++编码规范与避坑指南.md)**
   - C++编码最佳实践（预分配内存版本）
   - 简化设计原则（单线程、无锁、简单状态）
   - 开源库优先原则
   - 资源管理（预分配内存、静态存储）
   - 常见陷阱和解决方案

14. **[文档维护规范.md](./文档维护规范.md)**
    - 文档维护规范
    - 确保文档和代码的唯一性、一致性

15. **[文档更新记录.md](./文档更新记录.md)**
    - 文档更新历史记录
    - 版本变更说明

16. **[文档合并更新总结.md](./文档合并更新总结.md)**
    - 文档合并更新总结
    - 一致性检查结果

### 已废弃文档

- ~~`SPA单例页面管理架构.md`~~ - **已废弃**，内容已合并到`C++架构设计-页面管理系统.md`
  - 原因：使用C语言实现，项目已统一采用C++实现

---

## 一、项目概述

### 1.1 项目目标

将KTV Android应用精简并移植到全志F133平台，保留核心功能：
- 歌曲浏览、搜索、点歌
- m3u8流媒体播放（支持双音轨：原唱/伴奏切换）
- 播放控制（播放、暂停、切歌、重唱）
- 历史记录（最多50首）

### 1.2 技术栈

- **平台**：全志F133（ARM Cortex-A7）
- **操作系统**：Tina Linux（基于OpenWrt/Buildroot）
- **UI框架**：LVGL 8.x（开源库）
- **播放器**：TPlayer（全志官方播放中间件）
- **编程语言**：C++17
- **媒体格式**：m3u8（HLS流媒体）
- **输入设备**：触摸屏 + HDMI智能TV遥控器（LVGL输入设备接口）
- **开源库**：
  - libcurl（HTTP REST API客户端）⭐ 必需
  - cJSON（JSON解析）⭐ 必需
  - moodycamel::ConcurrentQueue（消息队列）⭐ 必需
  - inih（配置文件，可选）
- **服务器协议**：HTTP REST API + JSON（已确定，客户端实现即可）
- **设计原则**：尽量不造轮子，使用现成开源库，低代码实现

### 1.3 MVP版本功能

**保留功能：**
- ✅ 首页（歌曲浏览、分类、排行榜）
- ✅ 历史记录（最近50首播放记录）
- ✅ 搜索（歌名、歌手）
- ✅ 点歌（添加到播放列表）
- ✅ 播放控制（播放、暂停、切歌、重唱）
- ✅ 音轨切换（原唱/伴奏）
- ✅ 音量控制

**移除功能：**
- ❌ VIP会员中心
- ❌ 微信扫码点歌
- ❌ 猜你喜欢
- ❌ 我的收藏

---

## 二、架构总览

### 2.1 系统架构

```
┌─────────────────────────────────────────┐
│         应用层（C++ + LVGL）              │
│  - 页面管理系统（SPA单例模式）            │
│  - UI组件（列表、搜索、控制栏）            │
│  - 数据模型和服务层                       │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│         网络层（libcurl + cJSON）         │
│  - HTTP REST API客户端（libcurl）        │
│  - JSON解析（cJSON）                     │
│  - 歌曲数据服务（SongService）           │
└─────────────────────────────────────────┘
           ↓ HTTP REST API
┌─────────────────────────────────────────┐
│         服务器端（HTTP REST API）         │
│  - GET /api/songs（获取歌曲列表）        │
│  - GET /api/search（搜索）                │
│  - GET /api/rankings（排行榜）            │
│  - POST /api/queue/add（点歌）           │
│  - 响应格式：JSON                         │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│         播放器层（TPlayer）               │
│  - m3u8流媒体播放                         │
│  - 硬件解码（VE引擎）                     │
│  - 音轨切换（原唱/伴奏）                   │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│         系统层（Tina Linux）             │
│  - Display Engine（显示引擎）            │
│  - ALSA（音频输出）                       │
│  - 网络（HTTP/HLS）                       │
└─────────────────────────────────────────┘
```

### 2.2 页面架构（SPA单例模式 + 预分配内存）

```
PageManager（单例）
├── BaseLayout（主框架，静态实例）
│   ├── 顶部菜单栏（首页/历史记录）
│   ├── 主内容区（动态切换）
│   └── 底部控制栏（固定）
│
└── Pages（页面实例，预分配静态存储）
    ├── HomeTab（首页Tab，静态实例）
    ├── HistoryTab（历史记录Tab，静态实例）
    ├── SongListPage（歌曲列表，静态实例）
    ├── SearchPage（搜索页面，静态实例）
    ├── CategoryPage（分类浏览，静态实例）
    ├── RankingPage（排行榜，静态实例）
    ├── ArtistPage（歌手页面，静态实例）
    ├── QueueListPage（已点列表，弹窗，静态实例）
    ├── TunePage（调音页面，弹窗，静态实例）
    └── SettingsPage（设置页面，静态实例）

所有页面都是单例，使用静态存储，零动态内存分配
```

### 2.3 核心设计模式（简化设计）

1. **单例模式**：PageManager、HistoryService等服务类，页面和控件单例化
2. **SPA模式**：页面只创建一次，通过显示/隐藏切换
3. **预分配内存**：所有内存预分配，零动态分配
4. **静态存储**：页面实例使用静态存储，单例模式
5. **固定大小数组**：使用`std::array`替代动态容器
6. **单线程设计**：主线程处理所有逻辑，尽量少线程
7. **无锁设计**：单线程设计，避免锁竞争和死锁
8. **简单状态**：使用简单枚举，避免复杂状态机
9. **无状态结构**：函数式风格，最小化状态管理
10. **简化设计**：降低整体复杂度，减少资源泄露

---

## 三、核心组件

### 3.1 页面管理系统

**核心类：**
- `Page` - 页面基类（抽象类）
- `PageManager` - 页面管理器（单例）
- `BaseLayout` - 主框架布局

**特性：**
- 预分配：所有页面在启动时预分配（静态存储）
- 单例模式：每个页面只有一个实例
- 状态保持：页面切换时保持状态
- 零动态分配：所有内存预分配，避免内存泄漏
- 单线程：主线程处理所有逻辑，无锁设计
- 简单状态：使用简单枚举，避免复杂状态机
- 无状态结构：函数式风格，最小化状态管理

### 3.2 播放器集成

**TPlayer API：**
- `TPlayerCreate()` - 创建播放器
- `TPlayerSetDataSource()` - 设置m3u8 URL
- `TPlayerStart()` / `TPlayerPause()` - 播放控制
- `TPlayerSwitchAudio()` - **切换音轨（关键）**
- `TPlayerSetVolume()` - 音量控制

### 3.3 数据服务

**服务类：**
- `HttpService` - HTTP REST API客户端（单例，libcurl）
- `SongService` - 歌曲数据服务（单例，通过HTTP API获取数据）
- `LicenceService` - Licence许可证管理服务（单例，licence验证、试用期管理、过期检查）
- `M3u8DownloadService` - M3u8下载服务（单例，后台下载ts文件到本地hash目录）
- `HistoryService` - 历史记录服务（单例，FIFO队列，最多50条，包含本地文件路径）
- `PlayerService` - 播放器服务封装

**数据流程：**
```
UI层 → SongService → HttpService → HTTP REST API → JSON响应 → cJSON解析 → 数据模型 → UI更新
```

**播放流程：**
```
播放器 → 直接播放m3u8 → 后台下载ts文件 → 存储到本地hash目录 → 更新历史记录（最多50首，超过删除最早的）
```

---

## 四、页面列表

### 4.1 页面统计

| 序号 | 页面名称 | 类型 | 框架复用 |
|------|---------|------|---------|
| 1 | 主框架页面 | 容器 | BaseLayout |
| 2 | 首页Tab | Tab页 | BaseLayout + ListPageLayout |
| 3 | 历史记录Tab | Tab页 | BaseLayout + ListPageLayout |
| 4 | 歌曲列表页面 | 子页面 | ListPageLayout |
| 5 | 搜索页面 | 子页面 | SearchPageLayout |
| 6 | 分类浏览页面 | 子页面 | ListPageLayout |
| 7 | 排行榜页面 | 子页面 | ListPageLayout |
| 8 | 歌手页面 | 子页面 | ListPageLayout |
| 9 | 已点列表页面 | 弹窗 | DialogLayout + ListPageLayout |
| 10 | 调音页面 | 弹窗 | DialogLayout |
| 11 | 设置页面 | 页面 | BaseLayout |

**框架复用率：60-100%**

### 4.2 页面框架

1. **BaseLayout** - 主框架（100%复用）
2. **ListPageLayout** - 列表页面框架（60%复用）
3. **DialogLayout** - 弹窗框架（20-30%复用）
4. **SearchPageLayout** - 搜索页面框架（10%复用）

---

## 五、开发指南

### 5.1 快速开始

1. **阅读核心文档**：
   - `F133_KTV移植方案总结.md` - 了解平台和播放器
   - `C++架构设计-页面管理系统.md` - 了解代码架构
   - `C++编码规范与避坑指南.md` - 了解编码规范

2. **环境搭建**：
   - 配置Tina Linux SDK
   - 编译TPlayer库
   - 集成LVGL

3. **开发顺序**：
   - Phase 1: BaseLayout（主框架）
   - Phase 2: ListPageLayout（列表框架）
   - Phase 3: 具体页面实现
   - Phase 4: 播放器集成
   - Phase 5: 测试和优化

### 5.2 代码示例

**初始化应用：**
```cpp
#include "page_manager.h"
#include "history_service.h"

int main() {
    // 初始化LVGL
    lv_init();
    
    // 加载历史记录（使用固定大小缓冲区）
    HistoryService::getInstance().loadFromFile("/data/ktv_history.json");
    
    // 初始化页面管理器（预分配所有页面）
    PageManager::getInstance().initialize();
    
    // 主循环
    while (1) {
        lv_timer_handler();
        usleep(5000);
    }
    
    // 清理（只清理状态，不释放内存）
    PageManager::getInstance().cleanup();
    return 0;
}
```

**页面切换（零动态分配）：**
```cpp
// 切换到搜索页面（使用预分配的页面实例）
PageManager::getInstance().switchTo(PageType::Search);

// 切换到分类页面（带参数，使用栈内存）
PageParams params;  // 栈分配
params.param1 = 1;
PageManager::getInstance().switchTo(PageType::Category, &params);

// 返回上一页
PageManager::getInstance().back();
```

---

## 六、关键技术点

### 6.1 m3u8多音轨支持

- **格式要求**：m3u8文件需正确声明多个音轨
- **切换API**：`TPlayerSwitchAudio(player, track_index)`
- **实现方式**：0=原唱，1=伴奏

### 6.2 显示叠加

- **视频层**：TPlayer输出到Display Engine视频图层
- **UI层**：LVGL输出到framebuffer（UI图层）
- **合成**：Display Engine自动叠加显示

### 6.3 历史记录管理

- **数据结构**：FIFO队列（`std::array`，固定大小50）
- **数量限制**：最多50条（预分配）
- **持久化**：JSON格式保存到本地文件（使用固定大小缓冲区）
- **去重**：同一首歌只保留最新记录
- **零动态分配**：所有内存预分配

---

## 七、文档维护说明

### 7.1 文档更新记录

- **v1.0** (2024) - 初始版本
  - 合并C语言和C++版本文档
  - 统一采用C++实现方案
  - 创建文档索引

### 7.2 文档冲突解决

**已解决的冲突：**
- ✅ `SPA单例页面管理架构.md`（C语言版本）已废弃
- ✅ `C++架构设计-页面管理系统.md`（C++版本）作为主要实现文档
- ✅ `页面架构分析与复用方案.md`已更新，移除C语言引用

**文档一致性：**
- 所有架构设计统一使用C++实现
- 所有代码示例使用C++17标准
- 统一使用智能指针和RAII原则

---

## 八、参考资源

### 8.1 SDK文档

- `Tina_Linux_多媒体解码_开发指南.pdf`
- `Tina_Linux_各平台多媒体格式_支持列表.pdf`
- `Linux_Display_开发指南.pdf`
- `Linux_Audio_开发指南.pdf`

### 8.2 示例代码

- `package/allwinner/tina_multimedia_demo/tplayerdemo` - TPlayer使用示例

### 8.3 测试工具

- `tplayerdemo` - 命令行播放器测试工具

---

**总结**：本项目采用现代C++（C++17）实现，使用SPA单例模式管理页面，**所有页面预分配（静态存储），零动态内存分配**，通过固定大小数组和预分配内存确保零内存泄漏，**严格遵循避免造轮子原则，优先使用开源库（libcurl、cJSON、moodycamel::ConcurrentQueue、inih等），低代码实现**，通过框架复用提高开发效率。采用**简化设计**（单线程、无锁、简单状态、无状态结构、单例化）降低整体复杂度，减少资源泄露风险。所有设计文档已统一，可直接参考实现。

**核心设计原则**：
- ✅ 预分配内存：零动态分配，避免内存泄漏
- ✅ 简化设计：单线程、无锁、简单状态、无状态结构、单例化
- ✅ **避免造轮子**：严格遵循避免造轮子原则，优先使用开源库（libcurl、cJSON、moodycamel::ConcurrentQueue、inih等），低代码实现
- ✅ 服务器协议：HTTP REST API + JSON（已确定，客户端实现即可）

**相关文档**：
- [C++架构设计-预分配内存版本.md](./C++架构设计-预分配内存版本.md) ⭐ **主要实现文档**
- [HTTP_REST_API客户端设计.md](./HTTP_REST_API客户端设计.md) ⭐ **网络层设计**
- [M3u8下载与本地存储设计.md](./M3u8下载与本地存储设计.md) ⭐ **M3u8下载与存储设计**
- [线程与事件系统设计.md](./线程与事件系统设计.md) ⭐ **线程与事件设计**
- [开源库选型指南.md](./开源库选型指南.md) - 推荐使用的开源库清单和集成方案
- [C++编码规范与避坑指南.md](./C++编码规范与避坑指南.md) - 编码规范和最佳实践
- [文档维护规范.md](./文档维护规范.md) - 文档维护规范

