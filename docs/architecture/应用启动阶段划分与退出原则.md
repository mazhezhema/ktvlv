# åº”ç”¨å¯åŠ¨é˜¶æ®µåˆ’åˆ†ä¸é€€å‡ºåŸåˆ™

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
> **æœ€åæ›´æ–°**ï¼š2025-12-30  
> **çŠ¶æ€**ï¼šâœ… æ ¸å¿ƒæ–‡æ¡£ï¼ˆæ¶æ„è®¾è®¡ï¼‰  
> **é€‚ç”¨å¹³å°**ï¼šF133 / Tina Linux  
> **ç›®æ ‡**ï¼šæ˜ç¡®åº”ç”¨å¯åŠ¨é˜¶æ®µåˆ’åˆ†å’Œç»Ÿä¸€é€€å‡ºåŸåˆ™ï¼Œç¡®ä¿é—®é¢˜å¯å®šä½ã€é€€å‡ºå¯æ§

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼ˆä¸€å¥è¯ï¼‰

> **å¯åŠ¨åˆ†4ä¸ªæ˜ç¡®é˜¶æ®µï¼Œé€€å‡ºå¿…é¡»ä¸å¯åŠ¨é¡ºåºç›¸åï¼Œåªæœ‰ AppRuntime æœ‰æƒè§¦å‘é€€å‡ºã€‚**

---

## ğŸ“‹ ç›®å½•

1. [å¯åŠ¨é˜¶æ®µåˆ’åˆ†](#ä¸€-å¯åŠ¨é˜¶æ®µåˆ’åˆ†)
2. [é€€å‡ºåŸåˆ™](#äºŒ-é€€å‡ºåŸåˆ™)
3. [é˜¶æ®µè¯Šæ–­](#ä¸‰-é˜¶æ®µè¯Šæ–­)
4. [å®ç°ç¤ºä¾‹](#å››-å®ç°ç¤ºä¾‹)

---

## ä¸€ã€å¯åŠ¨é˜¶æ®µåˆ’åˆ†

### é˜¶æ®µè¯­ä¹‰

åº”ç”¨å¯åŠ¨åˆ†ä¸º **4 ä¸ªæ˜ç¡®é˜¶æ®µ**ï¼Œæ¯ä¸ªé˜¶æ®µæœ‰æ˜ç¡®çš„èŒè´£å’Œå®Œæˆæ ‡å¿—ã€‚

### Stage 1ï¼šPlatform Readyï¼ˆå¹³å°å°±ç»ªï¼‰

**èŒè´£**ï¼šç¡®ä¿åº•å±‚å¹³å°èµ„æºå¯ç”¨

**æ£€æŸ¥é¡¹**ï¼š
- âœ… æ–‡ä»¶ç³»ç»ŸæŒ‚è½½å®Œæˆ
- âœ… ç½‘ç»œæ¥å£å¯ç”¨ï¼ˆ`/sys/class/net/eth0` æˆ– `/sys/class/net/wlan0`ï¼‰
- âœ… æ˜¾ç¤ºè®¾å¤‡å¯ç”¨ï¼ˆ`/dev/fb0` å¯è¯»å†™ï¼‰
- âœ… è¾“å…¥è®¾å¤‡å¯ç”¨ï¼ˆ`/dev/input/eventX` å¯è¯»å†™ï¼‰

**å®Œæˆæ ‡å¿—**ï¼šæ‰€æœ‰å¹³å°èµ„æºæ£€æŸ¥é€šè¿‡

**å¤±è´¥å¤„ç†**ï¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼Œé€€å‡ºåº”ç”¨ï¼ˆè¿”å›ç  1ï¼‰

---

### Stage 2ï¼šCore Runtimeï¼ˆæ ¸å¿ƒè¿è¡Œæ—¶ï¼‰

**èŒè´£**ï¼šåˆå§‹åŒ–æ ¸å¿ƒè¿è¡Œæ—¶ç»„ä»¶

**æ£€æŸ¥é¡¹**ï¼š
- âœ… AppRuntime åˆå§‹åŒ–å®Œæˆ
- âœ… EventBus å¯åŠ¨å®Œæˆ
- âœ… æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼ˆsyslog å¯ç”¨ï¼‰
- âœ… é…ç½®ç³»ç»ŸåŠ è½½å®Œæˆ

**å®Œæˆæ ‡å¿—**ï¼šæ‰€æœ‰æ ¸å¿ƒè¿è¡Œæ—¶ç»„ä»¶åˆå§‹åŒ–æˆåŠŸ

**å¤±è´¥å¤„ç†**ï¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼Œé€€å‡ºåº”ç”¨ï¼ˆè¿”å›ç  2ï¼‰

---

### Stage 3ï¼šService Initï¼ˆæœåŠ¡åˆå§‹åŒ–ï¼‰

**èŒè´£**ï¼šåˆå§‹åŒ–ä¸šåŠ¡æœåŠ¡

**æ£€æŸ¥é¡¹**ï¼š
- âœ… NetworkWorker å¯åŠ¨å®Œæˆ
- âœ… PlayerAdapter å¯åŠ¨å®Œæˆï¼ˆTPlayer åˆå§‹åŒ–ï¼‰
- âœ… StorageService åˆå§‹åŒ–å®Œæˆï¼ˆSQLite å¯ç”¨ï¼‰
- âœ… HistoryService åˆå§‹åŒ–å®Œæˆ

**å®Œæˆæ ‡å¿—**ï¼šæ‰€æœ‰ä¸šåŠ¡æœåŠ¡åˆå§‹åŒ–æˆåŠŸ

**å¤±è´¥å¤„ç†**ï¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼Œå°è¯•å›é€€åˆ° Stage 2ï¼Œå¦‚æœå¤±è´¥åˆ™é€€å‡ºåº”ç”¨ï¼ˆè¿”å›ç  3ï¼‰

---

### Stage 4ï¼šUI Readyï¼ˆUIå°±ç»ªï¼‰

**èŒè´£**ï¼šåˆå§‹åŒ– UI ç³»ç»Ÿå¹¶æ˜¾ç¤ºé¦–å±

**æ£€æŸ¥é¡¹**ï¼š
- âœ… LVGL åˆå§‹åŒ–å®Œæˆ
- âœ… æ˜¾ç¤ºé©±åŠ¨åˆå§‹åŒ–å®Œæˆ
- âœ… è¾“å…¥é©±åŠ¨åˆå§‹åŒ–å®Œæˆ
- âœ… é¦–å±æ¸²æŸ“å®Œæˆ

**å®Œæˆæ ‡å¿—**ï¼šUI ç³»ç»Ÿå¯ç”¨ï¼Œé¦–å±æ˜¾ç¤ºæ­£å¸¸

**å¤±è´¥å¤„ç†**ï¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼Œå°è¯•å›é€€åˆ° Stage 3ï¼Œå¦‚æœå¤±è´¥åˆ™é€€å‡ºåº”ç”¨ï¼ˆè¿”å›ç  4ï¼‰

---

## äºŒã€é€€å‡ºåŸåˆ™

### æ ¸å¿ƒåŸåˆ™

1. **UI ä¸ç›´æ¥ exit**
   - UI å±‚åªèƒ½å‘é€é€€å‡ºäº‹ä»¶
   - ç¦æ­¢ç›´æ¥è°ƒç”¨ `exit()` æˆ– `abort()`

2. **æ¨¡å—ä¸ç›´æ¥ exit**
   - ä¸šåŠ¡æ¨¡å—åªèƒ½é€šçŸ¥ AppRuntime
   - ç¦æ­¢ç›´æ¥è°ƒç”¨ `exit()` æˆ– `abort()`

3. **åªæœ‰ AppRuntime æœ‰æƒè§¦å‘é€€å‡º**
   - æ‰€æœ‰é€€å‡ºè¯·æ±‚å¿…é¡»é€šè¿‡ AppRuntime
   - AppRuntime ç»Ÿä¸€å¤„ç†é€€å‡ºé€»è¾‘

4. **é€€å‡ºé¡ºåºå¿…é¡»ä¸å¯åŠ¨é¡ºåºç›¸å**
   - Stage 4 â†’ Stage 3 â†’ Stage 2 â†’ Stage 1
   - ç¡®ä¿èµ„æºæŒ‰ä¾èµ–å…³ç³»æ­£ç¡®é‡Šæ”¾

### é€€å‡ºæµç¨‹

```
é€€å‡ºè¯·æ±‚
    â†“
AppRuntime::requestExit()
    â†“
Stage 4 æ¸…ç†ï¼ˆUI ç³»ç»Ÿï¼‰
    â†“
Stage 3 æ¸…ç†ï¼ˆä¸šåŠ¡æœåŠ¡ï¼‰
    â†“
Stage 2 æ¸…ç†ï¼ˆæ ¸å¿ƒè¿è¡Œæ—¶ï¼‰
    â†“
Stage 1 æ¸…ç†ï¼ˆå¹³å°èµ„æºï¼‰
    â†“
exit(0)
```

---

## ä¸‰ã€é˜¶æ®µè¯Šæ–­

### é—®é¢˜å®šä½

**å‡ºäº†é—®é¢˜ï¼Œèƒ½ä¸€çœ¼åˆ¤æ–­"æ­»åœ¨å“ªä¸ªé˜¶æ®µ"**

| é˜¶æ®µ | è¿”å›ç  | å…¸å‹é—®é¢˜ | è¯Šæ–­æ–¹æ³• |
|------|--------|---------|---------|
| **Stage 1** | 1 | æ–‡ä»¶ç³»ç»ŸæœªæŒ‚è½½ã€ç½‘ç»œæ¥å£ä¸å¯ç”¨ | æ£€æŸ¥ `/sys/class/net/` |
| **Stage 2** | 2 | EventBus å¯åŠ¨å¤±è´¥ã€æ—¥å¿—ç³»ç»Ÿä¸å¯ç”¨ | æ£€æŸ¥ syslog |
| **Stage 3** | 3 | TPlayer åˆå§‹åŒ–å¤±è´¥ã€SQLite ä¸å¯ç”¨ | æ£€æŸ¥æœåŠ¡æ—¥å¿— |
| **Stage 4** | 4 | LVGL åˆå§‹åŒ–å¤±è´¥ã€æ˜¾ç¤ºé©±åŠ¨ä¸å¯ç”¨ | æ£€æŸ¥ framebuffer |

### æ—¥å¿—è®°å½•

æ¯ä¸ªé˜¶æ®µå¼€å§‹å’Œç»“æŸæ—¶è®°å½•æ—¥å¿—ï¼š

```cpp
syslog(LOG_INFO, "[ktv][startup] Stage 1: Platform Ready - Starting...");
// ... åˆå§‹åŒ–é€»è¾‘ ...
syslog(LOG_INFO, "[ktv][startup] Stage 1: Platform Ready - Completed");

syslog(LOG_INFO, "[ktv][startup] Stage 2: Core Runtime - Starting...");
// ... åˆå§‹åŒ–é€»è¾‘ ...
syslog(LOG_INFO, "[ktv][startup] Stage 2: Core Runtime - Completed");
```

---

## å››ã€å®ç°ç¤ºä¾‹

### å¯åŠ¨æµç¨‹

```cpp
class AppRuntime {
public:
    enum class StartupStage {
        PLATFORM_READY = 1,
        CORE_RUNTIME = 2,
        SERVICE_INIT = 3,
        UI_READY = 4
    };

    int startup() {
        // Stage 1: Platform Ready
        syslog(LOG_INFO, "[ktv][startup] Stage 1: Platform Ready - Starting...");
        if (!initPlatform()) {
            syslog(LOG_ERR, "[ktv][startup] Stage 1 failed");
            return 1;
        }
        syslog(LOG_INFO, "[ktv][startup] Stage 1: Platform Ready - Completed");

        // Stage 2: Core Runtime
        syslog(LOG_INFO, "[ktv][startup] Stage 2: Core Runtime - Starting...");
        if (!initCoreRuntime()) {
            syslog(LOG_ERR, "[ktv][startup] Stage 2 failed");
            cleanupPlatform();
            return 2;
        }
        syslog(LOG_INFO, "[ktv][startup] Stage 2: Core Runtime - Completed");

        // Stage 3: Service Init
        syslog(LOG_INFO, "[ktv][startup] Stage 3: Service Init - Starting...");
        if (!initServices()) {
            syslog(LOG_ERR, "[ktv][startup] Stage 3 failed");
            cleanupCoreRuntime();
            cleanupPlatform();
            return 3;
        }
        syslog(LOG_INFO, "[ktv][startup] Stage 3: Service Init - Completed");

        // Stage 4: UI Ready
        syslog(LOG_INFO, "[ktv][startup] Stage 4: UI Ready - Starting...");
        if (!initUI()) {
            syslog(LOG_ERR, "[ktv][startup] Stage 4 failed");
            cleanupServices();
            cleanupCoreRuntime();
            cleanupPlatform();
            return 4;
        }
        syslog(LOG_INFO, "[ktv][startup] Stage 4: UI Ready - Completed");

        syslog(LOG_INFO, "[ktv][startup] All stages completed successfully");
        return 0;
    }

    void requestExit() {
        syslog(LOG_INFO, "[ktv][shutdown] Exit requested, starting cleanup...");

        // Stage 4 æ¸…ç†ï¼ˆUI ç³»ç»Ÿï¼‰
        cleanupUI();

        // Stage 3 æ¸…ç†ï¼ˆä¸šåŠ¡æœåŠ¡ï¼‰
        cleanupServices();

        // Stage 2 æ¸…ç†ï¼ˆæ ¸å¿ƒè¿è¡Œæ—¶ï¼‰
        cleanupCoreRuntime();

        // Stage 1 æ¸…ç†ï¼ˆå¹³å°èµ„æºï¼‰
        cleanupPlatform();

        syslog(LOG_INFO, "[ktv][shutdown] Cleanup completed, exiting...");
        exit(0);
    }

private:
    bool initPlatform() {
        // æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ
        if (access("/tmp", F_OK) != 0) {
            syslog(LOG_ERR, "[ktv][platform] Filesystem not ready");
            return false;
        }

        // æ£€æŸ¥ç½‘ç»œæ¥å£
        if (access("/sys/class/net/eth0", F_OK) != 0 &&
            access("/sys/class/net/wlan0", F_OK) != 0) {
            syslog(LOG_ERR, "[ktv][platform] Network interface not available");
            return false;
        }

        // æ£€æŸ¥æ˜¾ç¤ºè®¾å¤‡
        if (access("/dev/fb0", R_OK | W_OK) != 0) {
            syslog(LOG_ERR, "[ktv][platform] Display device not available");
            return false;
        }

        return true;
    }

    bool initCoreRuntime() {
        // åˆå§‹åŒ– AppRuntime
        // åˆå§‹åŒ– EventBus
        EventBus::getInstance().start();

        // åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿï¼ˆsyslog å·²ç”±ç³»ç»Ÿæä¾›ï¼‰
        openlog("ktvlv", LOG_PID | LOG_CONS, LOG_USER);

        // åŠ è½½é…ç½®
        Config::instance().load();

        return true;
    }

    bool initServices() {
        // å¯åŠ¨ NetworkWorker
        NetworkWorker::instance().start();

        // å¯åŠ¨ PlayerAdapter
        PlayerAdapter::instance().start();

        // åˆå§‹åŒ– StorageService
        StorageService::instance().init();

        // åˆå§‹åŒ– HistoryService
        HistoryService::instance().init();

        return true;
    }

    bool initUI() {
        // åˆå§‹åŒ– LVGL
        lv_init();

        // åˆå§‹åŒ–æ˜¾ç¤ºé©±åŠ¨
        if (!initDisplayDriver()) {
            return false;
        }

        // åˆå§‹åŒ–è¾“å…¥é©±åŠ¨
        if (!initInputDriver()) {
            return false;
        }

        // æ¸²æŸ“é¦–å±
        renderFirstScreen();

        return true;
    }

    void cleanupUI() {
        syslog(LOG_INFO, "[ktv][shutdown] Cleaning up UI...");
        // UI æ¸…ç†é€»è¾‘
    }

    void cleanupServices() {
        syslog(LOG_INFO, "[ktv][shutdown] Cleaning up services...");
        PlayerAdapter::instance().stop();
        NetworkWorker::instance().stop();
    }

    void cleanupCoreRuntime() {
        syslog(LOG_INFO, "[ktv][shutdown] Cleaning up core runtime...");
        EventBus::getInstance().stop();
    }

    void cleanupPlatform() {
        syslog(LOG_INFO, "[ktv][shutdown] Cleaning up platform...");
        closelog();
    }
};
```

### ä½¿ç”¨ç¤ºä¾‹

```cpp
int main() {
    int ret = AppRuntime::instance().startup();
    if (ret != 0) {
        syslog(LOG_ERR, "[ktv] Startup failed at stage %d", ret);
        return ret;
    }

    // ä¸»å¾ªç¯
    while (!AppRuntime::instance().shouldQuit()) {
        lv_timer_handler();
        usleep(5000);
    }

    // é€€å‡ºï¼ˆç”± AppRuntime ç»Ÿä¸€å¤„ç†ï¼‰
    AppRuntime::instance().requestExit();
    return 0;
}
```

---

## äº”ã€å…³é”®è§„åˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰

### ğŸš« ç¦æ­¢äº‹é¡¹

1. **ç¦æ­¢ UI ç›´æ¥ exit**
   - âŒ ç¦æ­¢åœ¨ UI å›è°ƒä¸­è°ƒç”¨ `exit()`
   - âœ… å¿…é¡»å‘é€é€€å‡ºäº‹ä»¶åˆ° AppRuntime

2. **ç¦æ­¢æ¨¡å—ç›´æ¥ exit**
   - âŒ ç¦æ­¢åœ¨ä¸šåŠ¡æ¨¡å—ä¸­è°ƒç”¨ `exit()`
   - âœ… å¿…é¡»é€šçŸ¥ AppRuntime

3. **ç¦æ­¢è·³è¿‡é˜¶æ®µ**
   - âŒ ç¦æ­¢è·³è¿‡æŸä¸ªå¯åŠ¨é˜¶æ®µ
   - âœ… å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰é˜¶æ®µ

4. **ç¦æ­¢é€€å‡ºé¡ºåºé”™è¯¯**
   - âŒ ç¦æ­¢ä¸æŒ‰ç›¸åé¡ºåºé€€å‡º
   - âœ… å¿…é¡»æŒ‰ Stage 4 â†’ 3 â†’ 2 â†’ 1 é¡ºåºé€€å‡º

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [AppRuntimeçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸæ€»æ§è®¾è®¡.md](./AppRuntimeçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸæ€»æ§è®¾è®¡.md) â­â­â­ **å¿…è¯»**
- [å¼‚å¸¸æ€å¤„ç†æ€»åˆ™.md](./å¼‚å¸¸æ€å¤„ç†æ€»åˆ™.md) â­â­â­ **å¿…è¯»**
- [KTV_Appç¨³å®šæ€§ä¸è‡ªæ„ˆè®¾è®¡è¯´æ˜.md](../sdk/KTV_Appç¨³å®šæ€§ä¸è‡ªæ„ˆè®¾è®¡è¯´æ˜.md)

---

**æœ€åæ›´æ–°**: 2025-12-30  
**ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ  
**çŠ¶æ€**: âœ… æ ¸å¿ƒæ–‡æ¡£ï¼ˆæ¶æ„è®¾è®¡ï¼‰

