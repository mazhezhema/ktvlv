# KTVLV 项目架构图（完整版）

> **文档版本**：v1.0  
> **最后更新**：2025-12-30  
> **状态**：✅ 核心架构文档  
> **用途**：完整项目架构可视化，包含系统架构、线程模型、消息流向、模块结构、启动流程等

---

## 📋 目录

1. [系统架构总览](#一-系统架构总览)
2. [线程模型架构](#二-线程模型架构)
3. [消息流向架构](#三-消息流向架构)
4. [模块结构架构](#四-模块结构架构)
5. [启动流程架构](#五-启动流程架构)
6. [数据流向架构](#六-数据流向架构)
7. [核心设计原则](#七-核心设计原则)

---

## 一、系统架构总览

### 1.1 分层架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        应用层（Application Layer）                │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  UI层（LVGL 8.x）                                          │ │
│  │  • 页面管理（PageManager）                                  │ │
│  │  • UI组件（列表、搜索、控制栏）                              │ │
│  │  • 事件处理（UI事件回调）                                   │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  业务层（Business Layer）                                   │ │
│  │  • 歌曲服务（SongService）                                  │ │
│  │  • 搜索服务（SearchService）                                │ │
│  │  • 历史记录服务（HistoryService）                           │ │
│  │  • VIP服务（VIPService）                                    │ │
│  └───────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  服务层（Service Layer）                                    │ │
│  │  • HTTP服务（HttpService - libcurl）                        │ │
│  │  • WebSocket服务（WebSocketService - libwebsockets）        │ │
│  │  • 播放器服务（PlayerService - TPlayer）                    │ │
│  │  • 下载服务（DownloadService）                               │ │
│  │  • 缓存服务（CacheService）                                 │ │
│  │  • 日志服务（LoggingService - syslog）                      │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      平台抽象层（Platform Layer）                  │
│  • 显示驱动（Display Driver - Framebuffer）                      │
│  • 输入驱动（Input Driver - evdev）                             │
│  • 音频驱动（Audio Driver - ALSA）                               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      系统层（System Layer）                       │
│  • Tina Linux（嵌入式Linux）                                     │
│  • F133 SoC（ARM Cortex-A7）                                    │
│  • Display Engine（显示引擎）                                    │
│  • ALSA（音频输出）                                              │
│  • 网络（HTTP/HLS）                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        应用层技术栈                               │
│  • C++17（编程语言）                                             │
│  • LVGL 8.x（UI框架）                                            │
│  • std::queue + std::mutex（消息队列）                           │
│  • std::thread（线程管理）                                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        网络层技术栈                               │
│  • libcurl（HTTP客户端）                                         │
│  • libwebsockets（WebSocket客户端）                              │
│  • cJSON（JSON解析）                                             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        播放器技术栈                               │
│  • TPlayer（全志官方播放器SDK）                                  │
│  • m3u8（HLS流媒体）                                              │
│  • 硬件解码（VE引擎）                                            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        系统层技术栈                               │
│  • Framebuffer（显示）                                           │
│  • evdev（输入）                                                 │
│  • ALSA（音频）                                                  │
│  • SQLite3（本地数据）                                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、线程模型架构

### 2.1 线程拓扑图

```
┌─────────────────────────────────────────────────────────────────┐
│                      AppRuntime（线程生命周期总控）                 │
│  • 统一启动/停止所有线程                                          │
│  • 异常退出兜底                                                   │
│  • 线程状态监控                                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│  UI主线程     │   │  Event Loop   │   │ Network Worker│
│  (UISystem)   │   │  (EventBus)   │   │  (Network)    │
│               │   │               │   │               │
│ • LVGL渲染    │   │ • 事件分发     │   │ • HTTP请求     │
│ • UI更新      │   │ • 队列消费     │   │ • JSON解析     │
│ • 控件逻辑    │   │ • 事件派发     │   │ • WebSocket    │
└───────────────┘   └───────────────┘   └───────────────┘
        │                     │                     │
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │  Player Worker    │
                    │  (PlayerAdapter) │
                    │                   │
                    │ • 播放器控制      │
                    │ • TPlayer调用     │
                    │ • 状态管理        │
                    └───────────────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │  LogUpload        │
                    │  (LogUploadService)│
                    │                   │
                    │ • 日志上传        │
                    │ • 定时触发        │
                    └───────────────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │  Upgrade Checker │
                    │  (UpgradeService) │
                    │                   │
                    │ • 升级检测        │
                    │ • 定时检查        │
                    └───────────────────┘
```

### 2.2 线程分类与职责

#### ① 核心常驻线程（App生命周期）

```
┌─────────────────────────────────────────────────────────────────┐
│  UI主线程（UISystem）                                            │
│  • 职责：LVGL渲染、控件逻辑、UI更新                               │
│  • 阻塞：❌不能阻塞（必须保持响应）                               │
│  • 交互：消费 UiEventQueue                                       │
│  • 状态：✅ 必须常驻                                             │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  Event Loop（EventBus）                                         │
│  • 职责：事件分发、UiEventQueue消费                             │
│  • 阻塞：✔️ 阻塞OK（queue.wait()）                               │
│  • 交互：所有线程 → UI                                           │
│  • 状态：✅ 必须常驻                                             │
└─────────────────────────────────────────────────────────────────┘
```

#### ② 工作线程池（常驻，但可空转）

```
┌─────────────────────────────────────────────────────────────────┐
│  Network Worker（NetworkWorker）                                 │
│  • 职责：HTTP请求、WebSocket、网络IO                             │
│  • 阻塞：✔️ 阻塞OK（queue.wait()）                               │
│  • 交互：UI → Network                                           │
│  • 状态：✅ 必须常驻                                             │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  Player Worker（PlayerAdapter）                                  │
│  • 职责：播放器控制、TPlayer调用                                 │
│  • 阻塞：✔️ 阻塞OK（PlayerCmdQueue.wait()）                      │
│  • 交互：UI → Player                                            │
│  • 状态：✅ 必须常驻                                             │
└─────────────────────────────────────────────────────────────────┘
```

#### ③ 低频守护线程（常驻 + 定时唤醒）

```
┌─────────────────────────────────────────────────────────────────┐
│  LogUpload（LogUploadService）                                   │
│  • 职责：日志上传                                                 │
│  • 阻塞：✔️ 阻塞OK（sleep() / timerfd）                          │
│  • 交互：独立运行                                                 │
│  • 状态：✅ 必须常驻（低优先级）                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  Upgrade Checker（UpgradeService）                               │
│  • 职责：升级检测                                                 │
│  • 阻塞：✔️ 阻塞OK（sleep() / timerfd）                          │
│  • 交互：独立运行                                                 │
│  • 状态：✅ 必须常驻（低优先级）                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 线程启动/停止顺序

```
启动顺序（由 AppRuntime 控制）：
┌─────────────────────────────────────────────────────────────────┐
│  1. EventBus（事件总线，所有模块依赖）                            │
│  2. UISystem（UI主线程，所有UI操作依赖）                          │
│  3. NetworkWorker（网络线程，业务模块可能依赖）                   │
│  4. PlayerAdapter（播放器线程，播放功能依赖）                     │
│  5. LogUploadService（日志上传，低优先级）                       │
│  6. UpgradeService（升级检测，低优先级）                          │
└─────────────────────────────────────────────────────────────────┘

停止顺序（由 AppRuntime 控制，与启动顺序相反）：
┌─────────────────────────────────────────────────────────────────┐
│  1. UpgradeService（升级检测，低优先级）                          │
│  2. LogUploadService（日志上传，低优先级）                       │
│  3. PlayerAdapter（播放器线程，依赖者先停止）                     │
│  4. NetworkWorker（网络线程，依赖者先停止）                      │
│  5. EventBus（事件总线，被依赖者后停止）                          │
│  6. UISystem（UI主线程，最后停止）                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、消息流向架构

### 3.1 Command Down / Event Up 架构

```
💡 Command Down / Event Up —— 核心规则

┌─────────────────────────────────────────────────────────────────┐
│  UI点击/业务需求                                                  │
│  • 用户点击播放按钮                                               │
│  • 用户搜索歌曲                                                   │
│  • 用户点歌                                                       │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  PlayerCmdQueue（命令队列）                                       │
│  • 流向：UI/业务 → 播放器                                         │
│  • 实现：std::queue + std::mutex                                 │
│  • 作用：串行化所有播放器操作                                     │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  Player Worker（播放器线程）                                     │
│  • 消费 PlayerCmdQueue                                           │
│  • 调用 tplayer_*() API                                          │
│  • 执行播放器命令                                                 │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  TPlayer SDK（内部线程）                                          │
│  • SDK内部线程                                                    │
│  • 回调返回（播放状态、错误等）                                   │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  UiEventQueue（事件队列）                                         │
│  • 流向：播放器/网络/SDK → UI                                     │
│  • 实现：std::queue + std::mutex                                 │
│  • 作用：把后台事件回主线程更新UI                                 │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  UI主线程（LVGL + UiDispatcher）                                 │
│  • 消费 UiEventQueue                                              │
│  • 更新UI控件                                                     │
│  • 显示播放状态                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 消息队列详细架构

```
┌─────────────────────────────────────────────────────────────────┐
│  PlayerCmdQueue（命令队列）                                       │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │  生产者（多生产者）                                         │   │
│  │  • UI主线程（用户点击）                                     │   │
│  │  • Network Worker（网络请求结果）                           │   │
│  │  • 业务逻辑（自动播放等）                                   │   │
│  └───────────────────────────────────────────────────────────┘   │
│                    │                                             │
│                    ▼                                             │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │  队列实现（std::queue + std::mutex）                       │   │
│  │  • 线程安全                                                 │   │
│  │  • 阻塞等待（condition_variable）                           │   │
│  │  • 对外透明（不暴露mutex）                                   │   │
│  └───────────────────────────────────────────────────────────┘   │
│                    │                                             │
│                    ▼                                             │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │  消费者（单消费者）                                         │   │
│  │  • Player Worker（播放器线程）                              │   │
│  └───────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  UiEventQueue（事件队列）                                         │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │  生产者（多生产者）                                         │   │
│  │  • Player Worker（播放状态、错误）                          │   │
│  │  • Network Worker（网络请求结果）                           │   │
│  │  • TPlayer SDK（播放器回调）                                │   │
│  └───────────────────────────────────────────────────────────┘   │
│                    │                                             │
│                    ▼                                             │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │  队列实现（std::queue + std::mutex）                       │   │
│  │  • 线程安全                                                 │   │
│  │  • 非阻塞（try_dequeue）                                    │   │
│  │  • 对外透明（不暴露mutex）                                   │   │
│  └───────────────────────────────────────────────────────────┘   │
│                    │                                             │
│                    ▼                                             │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │  消费者（单消费者）                                         │   │
│  │  • UI主线程（通过 EventBus）                                │   │
│  └───────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 典型数据流场景

#### 场景1：用户点击播放按钮

```
用户点击播放按钮
    │
    ▼
UI主线程（LVGL事件回调）
    │
    ▼
PlayerCmdQueue.enqueue(PLAY_CMD)
    │
    ▼
Player Worker（消费命令）
    │
    ▼
tplayer_play(url)
    │
    ▼
TPlayer SDK（内部线程回调）
    │
    ▼
UiEventQueue.enqueue(PLAY_STARTED_EVENT)
    │
    ▼
UI主线程（消费事件）
    │
    ▼
更新UI（播放按钮状态、进度条等）
```

#### 场景2：用户搜索歌曲

```
用户输入搜索关键词
    │
    ▼
UI主线程（LVGL输入事件）
    │
    ▼
Network Worker.post([keyword]() {
    HttpService.get("/api/search?q=" + keyword)
})
    │
    ▼
Network Worker（HTTP请求 + JSON解析）
    │
    ▼
UiEventQueue.enqueue(SEARCH_RESULT_EVENT, data)
    │
    ▼
UI主线程（消费事件）
    │
    ▼
更新UI（显示搜索结果列表）
```

#### 场景3：播放器状态更新

```
TPlayer SDK（播放进度回调）
    │
    ▼
Player Worker（接收回调）
    │
    ▼
UiEventQueue.enqueue(PLAY_PROGRESS_EVENT, progress)
    │
    ▼
UI主线程（消费事件）
    │
    ▼
更新UI（进度条、时间显示等）
```

---

## 四、模块结构架构

### 4.1 目录结构架构

```
ktvlv/
├── src/
│   ├── app/                    # 应用层（启动和路由）
│   │   ├── AppController.h/.cpp      # 应用控制器（启动入口）
│   │   ├── AppRuntime.h/.cpp         # 应用运行时（线程生命周期总控）
│   │   └── routes/
│   │       └── RouteManager.h/.cpp  # 路由管理
│   │
│   ├── services/               # 服务层（框架层，不修改）
│   │   ├── PlayerService.h/.cpp       # 播放器服务
│   │   ├── WebSocketService.h/.cpp    # WebSocket服务
│   │   ├── HttpService.h/.cpp         # HTTP服务
│   │   ├── DownloadService.h/.cpp     # 下载服务
│   │   ├── CacheService.h/.cpp        # 缓存服务
│   │   ├── LoggingService.h/.cpp      # 日志服务
│   │   └── UiEventBus.h/.cpp          # UI事件总线
│   │
│   ├── features/               # 业务层（业务逻辑）
│   │   ├── home/               # 首页功能
│   │   ├── search/             # 搜索功能
│   │   ├── history/            # 历史记录功能
│   │   ├── vip/                # VIP功能
│   │   └── player/             # 播放器功能
│   │
│   ├── core/                   # 核心层（基础组件）
│   │   ├── thread_base.h       # 线程基类
│   │   ├── worker_thread.h      # 工作线程模板
│   │   └── event_bus.h          # 事件总线
│   │
│   ├── platform/               # 平台抽象层
│   │   └── f133_linux/
│   │       ├── display_fbdev.c
│   │       ├── input_evdev.c
│   │       └── audio_alsa.c
│   │
│   └── main.cpp                # 主入口
│
├── docs/                       # 文档目录
├── CMakeLists.txt             # CMake构建配置
└── README.md                   # 项目README
```

### 4.2 模块依赖关系

```
┌─────────────────────────────────────────────────────────────────┐
│  应用层（app/）                                                  │
│  • AppController（应用控制器）                                    │
│  • AppRuntime（线程生命周期总控）                                 │
│  • RouteManager（路由管理）                                       │
└─────────────────────────────────────────────────────────────────┘
        │
        │ 依赖
        ▼
┌─────────────────────────────────────────────────────────────────┐
│  业务层（features/）                                             │
│  • home/（首页）                                                 │
│  • search/（搜索）                                                │
│  • history/（历史记录）                                           │
│  • vip/（VIP）                                                    │
│  • player/（播放器）                                              │
└─────────────────────────────────────────────────────────────────┘
        │
        │ 依赖
        ▼
┌─────────────────────────────────────────────────────────────────┐
│  服务层（services/）                                             │
│  • PlayerService（播放器服务）                                   │
│  • HttpService（HTTP服务）                                       │
│  • WebSocketService（WebSocket服务）                             │
│  • DownloadService（下载服务）                                    │
│  • CacheService（缓存服务）                                       │
│  • LoggingService（日志服务）                                     │
│  • UiEventBus（UI事件总线）                                      │
└─────────────────────────────────────────────────────────────────┘
        │
        │ 依赖
        ▼
┌─────────────────────────────────────────────────────────────────┐
│  核心层（core/）                                                 │
│  • thread_base.h（线程基类）                                    │
│  • worker_thread.h（工作线程模板）                               │
│  • event_bus.h（事件总线）                                       │
└─────────────────────────────────────────────────────────────────┘
        │
        │ 依赖
        ▼
┌─────────────────────────────────────────────────────────────────┐
│  平台层（platform/）                                             │
│  • display_fbdev.c（显示驱动）                                   │
│  • input_evdev.c（输入驱动）                                     │
│  • audio_alsa.c（音频驱动）                                      │
└─────────────────────────────────────────────────────────────────┘
        │
        │ 依赖
        ▼
┌─────────────────────────────────────────────────────────────────┐
│  系统层（Tina Linux + F133）                                     │
│  • Framebuffer（显示）                                           │
│  • evdev（输入）                                                 │
│  • ALSA（音频）                                                  │
│  • TPlayer SDK（播放器）                                        │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 Singleton 模块列表

```
┌─────────────────────────────────────────────────────────────────┐
│  Singleton 模块（必须全局唯一）                                   │
│                                                                   │
│  ✅ UISystem::instance()          UI主线程                       │
│  ✅ EventBus::getInstance()       事件总线                       │
│  ✅ NetworkWorker::instance()     网络线程                       │
│  ✅ PlayerAdapter::instance()     播放器线程                     │
│  ✅ LogUploadService::instance()  日志上传服务                   │
│  ✅ UpgradeService::instance()    升级检测服务                   │
│  ✅ AppRuntime::instance()        应用运行时                     │
│  ✅ HttpService::instance()        HTTP服务                      │
│  ✅ HistoryService::instance()    历史记录服务                   │
│  ✅ SongService::instance()       歌曲服务                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 五、启动流程架构

### 5.1 启动阶段划分

```
┌─────────────────────────────────────────────────────────────────┐
│  Stage 1：Platform Ready（平台就绪）                            │
│  • 文件系统挂载完成                                               │
│  • 网络接口可用                                                   │
│  • 显示设备可用（/dev/fb0）                                       │
│  • 输入设备可用（/dev/input/eventX）                             │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  Stage 2：Core Runtime（核心运行时）                             │
│  • AppRuntime 初始化完成                                         │
│  • EventBus 启动完成                                             │
│  • 日志系统初始化完成（syslog）                                  │
│  • 配置系统加载完成                                               │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  Stage 3：Service Init（服务初始化）                             │
│  • NetworkWorker 启动完成                                        │
│  • PlayerAdapter 启动完成（TPlayer初始化）                      │
│  • StorageService 初始化完成（SQLite可用）                       │
│  • HistoryService 初始化完成                                     │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  Stage 4：UI Ready（UI就绪）                                    │
│  • LVGL 初始化完成                                               │
│  • 首屏渲染完成                                                   │
│  • 页面管理器初始化完成                                           │
│  • 应用进入运行状态                                               │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 启动流程图

```
main()
    │
    ▼
AppRuntime::instance().initialize()
    │
    ▼
Stage 1: Platform Ready
    │
    ├─► 检查文件系统
    ├─► 检查网络接口
    ├─► 检查显示设备
    └─► 检查输入设备
    │
    ▼
Stage 2: Core Runtime
    │
    ├─► AppRuntime 初始化
    ├─► EventBus 启动
    ├─► 日志系统初始化
    └─► 配置系统加载
    │
    ▼
Stage 3: Service Init
    │
    ├─► NetworkWorker 启动
    ├─► PlayerAdapter 启动
    ├─► StorageService 初始化
    └─► HistoryService 初始化
    │
    ▼
Stage 4: UI Ready
    │
    ├─► LVGL 初始化
    ├─► 首屏渲染
    ├─► 页面管理器初始化
    └─► 应用进入运行状态
    │
    ▼
主循环（while (running)）
    │
    ├─► lv_timer_handler()
    ├─► EventBus::dispatchOnUiThread()
    └─► usleep(5000)
```

### 5.3 退出流程

```
退出触发（只有 AppRuntime 有权触发）
    │
    ▼
AppRuntime::shutdown()
    │
    ▼
停止顺序（与启动顺序相反）
    │
    ├─► UpgradeService::stop()
    ├─► LogUploadService::stop()
    ├─► PlayerAdapter::stop()
    ├─► NetworkWorker::stop()
    ├─► EventBus::stop()
    └─► UISystem::stop()
    │
    ▼
清理资源
    │
    ├─► 保存配置
    ├─► 保存历史记录
    └─► 释放资源
    │
    ▼
退出应用
```

---

## 六、数据流向架构

### 6.1 完整数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│  用户输入                                                         │
│  • 触摸屏点击                                                     │
│  • 遥控器按键                                                     │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  输入驱动（evdev）                                               │
│  • /dev/input/eventX                                            │
│  • 读取输入事件                                                   │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  UI主线程（LVGL事件处理）                                        │
│  • 处理输入事件                                                   │
│  • 触发UI回调                                                     │
└─────────────────────────────────────────────────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌───────────────┐     ┌───────────────────┐
│  本地操作     │     │  网络操作          │
│  • 播放控制   │     │  • 搜索歌曲        │
│  • 音量调节   │     │  • 获取歌单        │
│  • 页面切换   │     │  • 点歌            │
└───────────────┘     └───────────────────┘
        │                       │
        │                       ▼
        │           ┌───────────────────┐
        │           │  Network Worker  │
        │           │  • HTTP请求        │
        │           │  • JSON解析        │
        │           └───────────────────┘
        │                       │
        │                       ▼
        │           ┌───────────────────┐
        │           │  HTTP REST API     │
        │           │  • /api/songs      │
        │           │  • /api/search     │
        │           │  • /api/queue/add  │
        │           └───────────────────┘
        │                       │
        │                       ▼
        │           ┌───────────────────┐
        │           │  JSON响应          │
        │           │  • 歌曲列表        │
        │           │  • 搜索结果        │
        │           └───────────────────┘
        │                       │
        │                       ▼
        │           ┌───────────────────┐
        │           │  UiEventQueue      │
        │           │  • 事件通知UI       │
        │           └───────────────────┘
        │                       │
        └───────────┬───────────┘
                    │
                    ▼
        ┌───────────────────┐
        │  PlayerCmdQueue   │
        │  • 播放命令        │
        └───────────────────┘
                    │
                    ▼
        ┌───────────────────┐
        │  Player Worker    │
        │  • 执行播放命令     │
        └───────────────────┘
                    │
                    ▼
        ┌───────────────────┐
        │  TPlayer SDK       │
        │  • m3u8播放         │
        │  • 硬件解码         │
        └───────────────────┘
                    │
                    ▼
        ┌───────────────────┐
        │  播放状态回调       │
        │  • 播放进度         │
        │  • 播放错误         │
        └───────────────────┘
                    │
                    ▼
        ┌───────────────────┐
        │  UiEventQueue      │
        │  • 状态更新事件     │
        └───────────────────┘
                    │
                    ▼
        ┌───────────────────┐
        │  UI主线程          │
        │  • 更新UI控件       │
        │  • 显示播放状态     │
        └───────────────────┘
```

### 6.2 关键数据流场景

#### 场景1：点歌流程

```
用户点击歌曲
    │
    ▼
UI主线程（LVGL事件）
    │
    ▼
Network Worker.post([song_id]() {
    HttpService.post("/api/queue/add", {song_id})
})
    │
    ▼
HTTP请求（POST /api/queue/add）
    │
    ▼
JSON响应（{success: true}）
    │
    ▼
UiEventQueue.enqueue(QUEUE_ADDED_EVENT)
    │
    ▼
UI主线程（更新已点列表）
```

#### 场景2：播放流程

```
用户点击播放按钮
    │
    ▼
PlayerCmdQueue.enqueue(PLAY_CMD, url)
    │
    ▼
Player Worker（消费命令）
    │
    ▼
tplayer_play(url)
    │
    ▼
TPlayer SDK（开始播放）
    │
    ├─► 播放进度回调
    │   │
    │   ▼
    │   UiEventQueue.enqueue(PLAY_PROGRESS_EVENT)
    │
    └─► 播放完成回调
        │
        ▼
        UiEventQueue.enqueue(PLAY_COMPLETED_EVENT)
    │
    ▼
UI主线程（更新播放状态）
```

#### 场景3：搜索流程

```
用户输入搜索关键词
    │
    ▼
UI主线程（LVGL输入事件）
    │
    ▼
Network Worker.post([keyword]() {
    HttpService.get("/api/search?q=" + keyword)
})
    │
    ▼
HTTP请求（GET /api/search）
    │
    ▼
JSON响应（{songs: [...]}）
    │
    ▼
cJSON解析（解析JSON）
    │
    ▼
UiEventQueue.enqueue(SEARCH_RESULT_EVENT, data)
    │
    ▼
UI主线程（显示搜索结果）
```

---

## 七、核心设计原则

### 7.1 架构原则

```
┌─────────────────────────────────────────────────────────────────┐
│  核心设计原则                                                     │
│                                                                   │
│  ✅ Command Down / Event Up                                      │
│     • UI发指令往下走 → 播放器执行                                 │
│     • 后台事件往上走 → UI消费 & 更新                              │
│                                                                   │
│  ✅ 线程常驻 + 任务驱动                                           │
│     • 线程尽量常驻，任务按需唤醒/休眠                             │
│     • 常驻线程不得 busy-loop                                     │
│     • 所有常驻线程必须阻塞等待（queue / cond / fd）              │
│                                                                   │
│  ✅ Singleton 模式                                               │
│     • 线程宿主对象是 Singleton                                   │
│     • 核心资源必须全局唯一                                        │
│     • 禁止各模块自行控制线程生命周期                              │
│                                                                   │
│  ✅ 预分配内存                                                    │
│     • 所有内存预分配，零动态分配                                   │
│     • 页面实例使用静态存储                                        │
│     • 使用固定大小数组替代动态容器                                │
│                                                                   │
│  ✅ 简化设计                                                      │
│     • 4线程+2队列（固定角色）                                     │
│     • 业务层无锁                                                 │
│     • 不过度设计                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 禁止事项

```
┌─────────────────────────────────────────────────────────────────┐
│  禁止事项（硬规则）                                               │
│                                                                   │
│  ❌ 禁止跨线程直接调用 LVGL                                       │
│  ❌ 禁止 UI 线程访问网络/IO                                       │
│  ❌ 禁止使用 detach                                               │
│  ❌ 禁止线程内抛异常                                              │
│  ❌ 禁止 Singleton 构造依赖                                      │
│  ❌ 禁止死循环线程（while(1) + sleep）                           │
│  ❌ 禁止依赖 static 析构顺序                                     │
│  ❌ 禁止各模块自行控制线程生命周期                                │
│  ❌ 禁止在回调中做阻塞操作                                        │
│  ❌ 禁止在析构函数中阻塞等待外部资源                              │
│  ❌ 禁止模块间相互持有裸指针                                      │
│  ❌ 禁止隐式启动后台线程                                          │
│  ❌ 禁止用 sleep 作为同步手段                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 7.3 技术栈清单

```
┌─────────────────────────────────────────────────────────────────┐
│  技术栈清单                                                       │
│                                                                   │
│  硬件层：                                                         │
│  • F133 SoC（ARM Cortex-A7）                                    │
│                                                                   │
│  系统层：                                                         │
│  • Tina Linux（嵌入式Linux）                                     │
│  • Framebuffer（显示）                                           │
│  • evdev（输入）                                                  │
│  • ALSA（音频）                                                   │
│                                                                   │
│  应用层：                                                         │
│  • C++17（编程语言）                                              │
│  • LVGL 8.x（UI框架）                                             │
│  • std::thread（线程管理）                                        │
│  • std::queue + std::mutex（消息队列）                            │
│                                                                   │
│  网络层：                                                         │
│  • libcurl（HTTP客户端）                                          │
│  • libwebsockets（WebSocket客户端）                              │
│  • cJSON（JSON解析）                                              │
│                                                                   │
│  播放器层：                                                       │
│  • TPlayer（全志官方播放器SDK）                                  │
│  • m3u8（HLS流媒体）                                              │
│                                                                   │
│  数据层：                                                         │
│  • SQLite3（本地数据）                                            │
│  • syslog（日志）                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📚 相关文档

- [项目架构设计总览.md](./architecture/项目架构设计总览.md) ⭐⭐⭐ **必读**
- [并发架构总结构（最终版）.md](./architecture/并发架构总结构（最终版）.md) ⭐⭐⭐ **必读**
- [线程架构基线（最终版）.md](./线程架构基线（最终版）.md) ⭐⭐⭐ **必读**
- [应用启动阶段划分与退出原则.md](./architecture/应用启动阶段划分与退出原则.md) ⭐⭐⭐ **必读**
- [AppRuntime线程生命周期总控设计.md](./architecture/AppRuntime线程生命周期总控设计.md) ⭐⭐⭐ **必读**
- [工程规范完整指南（量产级）.md](./guides/工程规范完整指南（量产级）.md) ⭐⭐⭐ **必读**

---

**最后更新**: 2025-12-30  
**维护者**: 项目团队  
**状态**: ✅ 核心架构文档（完整版架构图）


