# KTVLV（F133/Tina）项目技术基座

> **文档版本**：v1.0  
> **最后更新**：2025-12-30  
> **项目名称**：KTVLV  
> **目标平台**：全志 F133（ARM Cortex-A7）  
> **操作系统**：Tina Linux  
> **状态**：✅ 官方技术基座文档

---

## 📌 一句话抽象

> **业务层 = Java/Web式开发体验 | 基础层 = 选型即设计、组件即方案 | 不碰系统内脏**

**核心定位**：
> **我们写的不是嵌入式系统，是一个运行在 TinaLinux 上的"微型网易云客户端"。**  
> **业务为王，底层靠选型。**

---

## 🎯 开发模式（正式定调）

### 团队定位模型

| 层级 | 由谁负责 | 技术 | 学习成本 |
|------|---------|------|---------|
| **业务层（你们团队）** | 歌单、榜单、搜索、逻辑 | C++接口 == Java习惯（无锁） | ⭐⭐⭐ 低（2周上手） |
| **服务层（框架）** | 我来给架构/模板 | 事件驱动 + 上下文封装 | ❌ 不接触 |
| **系统层（第三方）** | 开源库 | LVGL / WebSockets / libcurl / syslog / cjson / TPlayer | ❌ 不接触 |

### 核心原则

- ✅ **业务层 = Java/Web式开发体验**
- ✅ **基础层 = 选型即设计、组件即方案**
- ✅ **不碰系统内脏，不接触锁/调度/长连接细节**

**你们的核心战力在**：
- ✅ 业务逻辑
- ✅ 搜索算法
- ✅ 榜单排序
- ✅ 推荐算法
- ✅ 商业化

**不在**：
- ❌ 手搓调度
- ❌ 底层并发
- ❌ I/O 死磕

**详细说明**：详见 [团队开发规范v1.md](./团队开发规范v1.md)

---

## 🧩 使用到的所有库（MVP 已定版）

| 类别 | 选型 | 用途 | 为什么是它 |
|------|------|------|-----------|
| **UI框架** | **LVGL 8.3.11** | UI控件、事件、渲染 | 轻量、嵌入式王炸、团队能 hold |
| **播放器** | **TPlayer（全志SDK）** | 远程/本地 m3u8 + ts 播放 | 原生支持，性能稳，别造轮子 |
| **网络通信** | **libcurl** | 下载 m3u8、拉 TS、HTTP | Tina 必备，下载最稳 |
| **JSON** | **cJSON** | API/CONFIG 数据解析 | 轻量、无额外依赖 |
| **日志** | **syslog** | 系统日志（F133平台） | 系统自带，F133/Tina Linux 标准日志方案 |
| **长连接** | **libwebsockets** | WebSocket 实时控制 | 轻量、支持WSS、单线程友好 |
| **并发** | **std::thread + std::queue + mutex** | 线程与异步模型 | 简化心智，避免 pthread 裸奔 |
| **文件系统** | **POSIX / `<stdio.h>`** | TS/M3U8缓存落盘 | 不引入库，越简单越少坑 |

### 🚫 没用也不会用（MVP阶段）

- ❌ ffmpeg / libav - 不做转码
- ❌ Qt - 不需要跨平台GUI（F133使用framebuffer）
- ❌ boost - 体积大，不适合嵌入式
- ❌ moodycamel - 技术决策：不使用无锁队列，使用标准库 `std::queue + std::mutex + condition_variable`
- ❌ pthread 直接暴露 - 避免裸奔
- ❌ nlohmann::json - 部署端太重

### 核心原则

> **不引重库，不碰转码，不搞多媒体生产，只做"消费和缓存"。**

---

## 🧵 整体架构（服务式架构 + 4线程 + 2队列）

### 架构分层

```
┌─────────────────────────────────────────────────────────┐
│                  业务层（features/）                       │
│  歌单、榜单、搜索、逻辑（Java/Web式开发体验）                │
│  - SearchController、ChartController、PlaylistController │
└───────────────────────┬─────────────────────────────────┘
                        │ 调用服务层接口
┌───────────────────────▼─────────────────────────────────┐
│                  服务层（services/）                       │
│  PlayerService、HttpService、WebSocketService等          │
│  - 封装底层库，提供统一接口                              │
│  - 保证线程安全，业务层无锁                              │
└───────────────────────┬─────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────┐
│              系统层（4线程 + 2队列）                       │
│  UI线程、播放器线程、网络线程、SDK线程                      │
│  PlayerCmdQueue、UiEventQueue                            │
└───────────────────────┬─────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────┐
│                底层库（第三方）                            │
│  LVGL、TPlayer、libcurl、libwebsockets、syslog、cJSON      │
└─────────────────────────────────────────────────────────┘
```

### 线程架构（服务层内部实现，业务层不关心）

```
          ┌────────────────────────────────────────────┐
          │                    UI (LVGL)               │
          │   - 单线程渲染                              │
          │   - 控件事件                                │
          └──────────────▲─────────────────────────────┘
                         │  UiEventBus
                         │  UiEventQueue<Event>
                         │
  ┌──────────────────────┴───────────────────────────┐
  │                PlayerService 层                   │
  │  - 业务调用唯一入口                               │
  │  - 事件翻译/状态机                                │
  │  - 缓存策略开关 (本地优先)                        │
  └─────────▲────────────────────────┬───────────────┘
            │ PlayerCmdQueue<Cmd>    │ emit -> UI
            │ (串行调度)              │
            ▼                        │
        PlayerThread (std::thread)   │
            │                        │
            ▼                        │
        TPlayer SDK  ←─ SDK线程回调──┘
            │
            └→ file:///data/ts-cache/**/index.m3u8
```

**详细说明**：
- **服务层API设计**：详见 [服务层API设计文档.md](./服务层API设计文档.md)
- **项目结构**：详见 [项目脚手架结构.md](./项目脚手架结构.md)

### 线程职责表

| 线程 | 职责 | 为什么必须存在 | 不能做什么 |
|------|------|---------------|-----------|
| **UI 主线程** | LVGL 渲染、控件逻辑、UI更新 | UI 必须单线程 | ❌ 不能跨线程更新UI，❌ 不能直接调tplayer |
| **播放器线程（std::thread）** | 串行执行所有播放器命令 | 保证 tplayer 状态一致性 | ❌ 不能做业务逻辑，❌ 不能更新UI |
| **网络线程（std::async）** | HTTP请求 & JSON解析 | 避免阻塞UI | ❌ 不能直接更新UI |
| **SDK内部线程（tplayer线程）** | 来自SDK的回调 | 我们无法控制来源 | ❌ 不能直接触UI、不能直接触业务状态 |

### 消息队列表

| 队列 | 流向 | 谁写 → 谁读 | 实现方式 | 作用 |
|------|------|-----------|---------|------|
| **PlayerCmdQueue** | UI/业务 → 播放器 | UI & 网络 → PlayerThread | `std::queue + mutex` | 串行化所有播放器操作 |
| **UiEventQueue** | 播放器/网络/SDK → UI | PlayerThread & 网络 → UI线程 | `std::queue + mutex` | 把后台事件回主线程更新UI |

### 世界观

> **"命令往下走(Command Down) / 事件往上浮(Event Up)"**

---

## 🚦 播放策略（MVP黄金律）

| 阶段 | 行为 | 目的 |
|------|------|------|
| **首次播放** | **直接播远程 m3u8** | 首屏拉起快、成功率优先 |
| **播放中** | **后台异步解析+下载 TS** | 不影响播放线程，后台建缓存 |
| **二次播放** | **本地优先（file://）** | 弱网/离线也能播 |
| **缓存管理** | LRU/TTL/容量封顶 | 保持 NAND 健康，避免炸盘 |

> MVP 阶段**不做边播边下**，不和 TPlayer 抢调度权。  
> 后期可扩展成滑动窗口下载、弱网韧性增强。

---

## 🧠 最佳实践（工程交付面必须遵守）

### 🔐 并发模型

- ✅ UI = **唯一可修改界面的线程**
- ✅ PlayerThread = **唯一能调用 tplayer 的线程**
- ✅ SDK thread = **事件桥**（**禁止触 UI**）
- ❌ 禁止锁嵌套
- ❌ 禁止多队列乱飞
- ❌ 禁止状态交叉

### 📁 路径规则

| 目标 | 使用的路径 |
|------|-----------|
| **本地播放** | `file:///data/ts-cache/songID/index.m3u8` |
| **下载存盘** | `/data/ts-cache/songID/seg_123.ts` |
| **日志目录** | `/data/log/ktvlv.log` |

**必须 file://**  
不然 TPlayer 当 URL 走网络栈 → 坑。

### 🪵 日志策略（syslog）

- ✅ 一级目录：模块前缀 `[UI][Player][Cache][SDK][M3U8]`
- ✅ 用户态错误：LOGW / LOGE
- ✅ 内核杀点/断点：LOGF
- ✅ 研发看 DEBUG，线上隐藏 DEBUG

---

## ⚠️ 已识别的坑点清单（必须规避）

| 类型 | 坑点 | 规避方案 |
|------|------|---------|
| **播放器** | UI 线程直接调 tplayer | **永远走 PlayerAdapter → 队列 → PlayerThread** |
| **缓存** | 乱写 NAND 刷爆块 | 设容量上限 / TTL / 清理策略 |
| **m3u8** | 加密 `EXT-X-KEY` | MVP 跳过，后续支持 AES-128 |
| **TS下载** | 下载阻塞 UI / 播放卡死 | **后台线程，绝不阻塞主链路** |
| **相对路径** | `seg001.ts` 播不出来 | 改成 **绝对路径 + file://** |
| **live流** | 没有 `#EXT-X-ENDLIST` 无法缓存 | 限制为"在线播放模式" |
| **滥日志** | 写太多导致频繁 IO 卡顿 | log 级别策略 + 滚动日志控制大小 |

---

## 🔥 可复述版本（对财务/老板/供应链说）

> **KT VLV 的架构是"轻量级嵌入式播放器"方案，  
> 核心依赖 LVGL + TPlayer + libcurl + syslog，  
> 不做重型转码，不碰 ffmpeg，不走复杂并发，  
> 通过后台缓存机制实现弱网友好与离线可用。  
> 方案具有低成本交付能力，可持续扩展。**

---

## 💼 项目状态评估（站在老板视角）

| 维度 | 评分 | 说明 |
|------|------|------|
| **落地难度** | ⭐⭐⭐ | 线程模型清晰，风险可控 |
| **维护成本** | ⭐⭐⭐⭐ | 不引重库，团队容易接手 |
| **可扩展性** | ⭐⭐⭐⭐ | 后续可挂加密/滑动窗口/边播边下 |
| **性能空间** | ⭐⭐⭐ | F133能力有限，不做过度野心 |
| **成本/ROI** | ⭐⭐⭐⭐⭐ | 当前路线性价比最优 |

---

## 🧨 最后一个灵魂确认点

> **整个项目是"播放器驱动 UI"，不是"UI 去控制播放内核"。**  
> （把这句话烫金贴在 Cursor 项目根目录）

---

## 📚 相关文档

### 核心开发文档

- **团队开发规范**: [团队开发规范v1.md](./团队开发规范v1.md) ⭐⭐⭐ **必读**
- **服务层API设计**: [服务层API设计文档.md](./服务层API设计文档.md) ⭐⭐⭐ **必读**
- **项目脚手架结构**: [项目脚手架结构.md](./项目脚手架结构.md) ⭐⭐ **必读**

### 架构文档

- **并发架构总结构（最终版）**: [并发架构总结构（最终版）.md](./architecture/并发架构总结构（最终版）.md)
- **事件架构规范**: [事件架构规范.md](./architecture/事件架构规范.md)
- **项目架构设计总览**: [项目架构设计总览.md](./architecture/项目架构设计总览.md)

### 需求文档

- **F133第一期需求文档**: [F133第一期需求文档.md](./F133第一期需求文档.md)

### 库清单

- **F133平台库清单**: [F133平台库清单.md](./F133平台库清单.md)

---

## 🏷️ 标签

`#KTVLV` `#F133` `#TinaLinux` `#LVGL` `#TPlayer`  
`#技术基座` `#架构总结` `#MVP` `#嵌入式播放器`

---

**最后更新**: 2025-12-30  
**状态**: ✅ 官方技术基座文档，可挂仓库 README

