# KTV App ç¨³å®šæ€§ä¸è‡ªæ„ˆè®¾è®¡è¯´æ˜

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
> **æœ€åæ›´æ–°**ï¼š2025-12-30  
> **çŠ¶æ€**ï¼šâœ… æ ¸å¿ƒæ–‡æ¡£ï¼ˆé‡äº§å¿…è¯»ï¼‰  
> **é€‚ç”¨å¹³å°**ï¼šF133 / Tina Linux  
> **ç›®æ ‡**ï¼šç¡®ä¿åº”ç”¨åœ¨é‡äº§ç¯å¢ƒä¸­çš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§

---

## ğŸ¯ ä¸€å¥è¯æ€»è¯„

> **æ¶æ„æ–¹å‘æ­£ç¡®ï¼Œé€‰å‹æˆç†Ÿä¿å®ˆï¼Œä½†å¿…é¡»è¡¥å……è¿›ç¨‹çº§è‡ªæ„ˆã€çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸã€æ—¥å¿—è¿œç¨‹ä¸Šä¼ ã€å‡çº§å›æ»šã€é…ç½®è¾¹ç•Œå’Œå¼‚å¸¸UIï¼Œå¦åˆ™é‡äº§å¿…ç¿»è½¦ã€‚**

---

## ğŸ“‹ ç›®å½•

1. [è¿›ç¨‹çº§ Watchdog / è‡ªæ„ˆæœºåˆ¶](#ä¸€-è¿›ç¨‹çº§-watchdog--è‡ªæ„ˆæœºåˆ¶)
2. [çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ & é€€å‡ºé¡ºåº](#äºŒ-çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ--é€€å‡ºé¡ºåº)
3. [æ—¥å¿— â†’ è¿œç¨‹ä¸Šä¼ é—­ç¯](#ä¸‰-æ—¥å¿—--è¿œç¨‹ä¸Šä¼ é—­ç¯)
4. [åº”ç”¨å‡çº§çš„å›æ»šç­–ç•¥](#å››-åº”ç”¨å‡çº§çš„å›æ»šç­–ç•¥)
5. [é…ç½®ä¸­å¿ƒçš„åªè¯»/å¯å†™è¾¹ç•Œ](#äº”-é…ç½®ä¸­å¿ƒçš„åªè¯»å¯å†™è¾¹ç•Œ)
6. [å¼‚å¸¸å…œåº• UI](#å…­-å¼‚å¸¸å…œåº•-ui)
7. [å·¥ç¨‹ç¨³å®šæ€§æ£€æŸ¥æ¸…å•](#ä¸ƒ-å·¥ç¨‹ç¨³å®šæ€§æ£€æŸ¥æ¸…å•)

---

## ä¸€ã€è¿›ç¨‹çº§ Watchdog / è‡ªæ„ˆæœºåˆ¶

### 1.1 é—®é¢˜æè¿°

**å½“å‰çŠ¶æ€**ï¼š
- âœ… æœ‰çº¿ç¨‹æ¶æ„è®¾è®¡
- âœ… æœ‰äº‹ä»¶ç³»ç»Ÿè®¾è®¡
- âœ… æœ‰ Service è®¾è®¡
- âŒ **ç¼ºå°‘ App çº§è‡ªæ„ˆç­–ç•¥**

**é£é™©**ï¼š
- ç½‘ç»œæŠ–åŠ¨ â†’ App å‡æ­»
- TPlayer å¡æ­» â†’ åªèƒ½æ–­ç”µé‡å¯
- LVGL çº¿ç¨‹å‡æ­» â†’ UI æ— å“åº”
- å†…å­˜æ³„æ¼ç´¯ç§¯ â†’ ç³»ç»Ÿå´©æºƒ

### 1.2 è‡ªæ„ˆæœºåˆ¶è®¾è®¡

#### æœ€ä½æ ‡å‡†ï¼ˆå¿…é¡»å®ç°ï¼‰

**1. ä¸»è¿›ç¨‹å¿ƒè·³æœºåˆ¶**

```c
// ä¸»è¿›ç¨‹å¿ƒè·³ï¼ˆæ¯ 1~5 ç§’ï¼‰
static void heartbeat_check(void) {
    static time_t last_heartbeat = 0;
    time_t now = time(NULL);
    
    if (now - last_heartbeat > HEARTBEAT_TIMEOUT) {
        syslog(LOG_ERR, "[ktv][watchdog] heartbeat timeout, restarting...");
        exit(EXIT_FAILURE);  // è§¦å‘ systemd é‡å¯
    }
    
    last_heartbeat = now;
}
```

**2. å­æ¨¡å—çŠ¶æ€ä½æ£€æŸ¥**

```c
// ä¸‰ä¸ªæ ¸å¿ƒæ¨¡å—çŠ¶æ€ä½
typedef struct {
    bool ui_alive;      // UI/LVGL çº¿ç¨‹çŠ¶æ€
    bool player_alive;  // Player çº¿ç¨‹çŠ¶æ€
    bool network_alive; // Network çº¿ç¨‹çŠ¶æ€
    time_t last_update; // æœ€åæ›´æ–°æ—¶é—´
} module_status_t;

// çŠ¶æ€æ£€æŸ¥
static bool check_module_status(module_status_t* status) {
    time_t now = time(NULL);
    
    // æ£€æŸ¥å„æ¨¡å—æ˜¯å¦è¶…è¿‡é˜ˆå€¼æœªæ›´æ–°
    if (now - status->last_update > MODULE_TIMEOUT) {
        if (!status->ui_alive || !status->player_alive || !status->network_alive) {
            return false;
        }
    }
    
    return true;
}
```

**3. è¿ç»­å¼‚å¸¸æ£€æµ‹ä¸è‡ªæ€é‡å¯**

```c
// å¼‚å¸¸è®¡æ•°
static int failure_count = 0;
static const int MAX_FAILURES = 3;

static void handle_module_failure(void) {
    failure_count++;
    
    syslog(LOG_ERR, "[ktv][watchdog] module failure, count=%d", failure_count);
    
    if (failure_count >= MAX_FAILURES) {
        syslog(LOG_CRIT, "[ktv][watchdog] max failures reached, restarting...");
        
        // æ¸…ç†èµ„æº
        cleanup_resources();
        
        // è‡ªæ€ï¼Œè®© systemd é‡å¯
        exit(EXIT_FAILURE);
    }
}
```

#### systemd é…ç½®ï¼ˆå¤–éƒ¨ä¿éšœï¼‰

```ini
[Unit]
Description=KTV Application
After=network.target

[Service]
Type=simple
ExecStart=/opt/app/current/ktvlv
Restart=always
RestartSec=5
StartLimitInterval=60
StartLimitBurst=3

[Install]
WantedBy=multi-user.target
```

### 1.3 å®ç°å»ºè®®

1. **ä¸»å¾ªç¯å¿ƒè·³**ï¼šåœ¨ä¸»å¾ªç¯ä¸­æ¯ 1 ç§’æ£€æŸ¥ä¸€æ¬¡
2. **çº¿ç¨‹çŠ¶æ€æŠ¥å‘Š**ï¼šæ¯ä¸ªçº¿ç¨‹å®šæœŸæ›´æ–°çŠ¶æ€ä½
3. **å¼‚å¸¸é˜ˆå€¼**ï¼šè¿ç»­ 3 æ¬¡å¼‚å¸¸ â†’ é‡å¯
4. **æ—¥å¿—è®°å½•**ï¼šæ‰€æœ‰å¼‚å¸¸å¿…é¡»è®°å½•åˆ° syslog

---

## äºŒã€çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ & é€€å‡ºé¡ºåº

### 2.1 é—®é¢˜æè¿°

**å½“å‰é£é™©**ï¼š
- çº¿ç¨‹åˆ›å»º/é€€å‡ºæ—¶æœºä¸æ˜ç¡®
- é€€å‡ºé¡ºåºæ··ä¹±å¯¼è‡´èµ„æºæ³„æ¼
- çº¿ç¨‹é‡å¯ç­–ç•¥æœªå®šä¹‰

### 2.2 çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè¡¨

| çº¿ç¨‹ | åˆ›å»ºæ—¶æœº | é€€å‡ºæ—¶æœº | æ˜¯å¦å¯é‡å¯ | é€€å‡ºé¡ºåº | è¯´æ˜ |
|------|---------|---------|-----------|---------|------|
| **UI/LVGL** | App å¯åŠ¨ | App é€€å‡º | âŒ å¦ | æœ€åé€€å‡º | ä¸»çº¿ç¨‹ï¼Œç®¡ç†æ‰€æœ‰ UI èµ„æº |
| **Event Loop** | App å¯åŠ¨ | App é€€å‡º | âŒ å¦ | å€’æ•°ç¬¬äºŒ | äº‹ä»¶åˆ†å‘ï¼Œå¿…é¡»åœ¨ UI ä¹‹å‰é€€å‡º |
| **Network Worker** | å¯åŠ¨åç«‹å³åˆ›å»º | ç½‘ç»œå¼‚å¸¸å¯é‡å¯ | âœ… æ˜¯ | ç¬¬ 3 | ç½‘ç»œè¯·æ±‚å¤„ç†ï¼Œå¯ç‹¬ç«‹é‡å¯ |
| **Player Worker** | ç‚¹æ­Œæ—¶åˆ›å»º | æ’­æ”¾ç»“æŸæˆ–åœæ­¢ | âœ… æ˜¯ | ç¬¬ 2 | æ’­æ”¾å™¨çº¿ç¨‹ï¼Œæ¯æ¬¡æ’­æ”¾åˆ›å»ºæ–°çº¿ç¨‹ |
| **LogUpload** | å¯åŠ¨ååˆ›å»º | App é€€å‡º | âœ… æ˜¯ï¼ˆä½ä¼˜å…ˆçº§ï¼‰ | ç¬¬ 1 | æ—¥å¿—ä¸Šä¼ ï¼Œä½ä¼˜å…ˆçº§ï¼Œå¯å¿½ç•¥é€€å‡º |

### 2.3 é€€å‡ºé¡ºåºè®¾è®¡

**å…³é”®åŸåˆ™**ï¼š
1. **ä¾èµ–å…³ç³»å†³å®šé€€å‡ºé¡ºåº**ï¼šè¢«ä¾èµ–çš„çº¿ç¨‹å…ˆé€€å‡º
2. **èµ„æºæ¸…ç†é¡ºåº**ï¼šå…ˆæ¸…ç†ä¸šåŠ¡èµ„æºï¼Œå†æ¸…ç†ç³»ç»Ÿèµ„æº
3. **ä¼˜é›…é€€å‡º**ï¼šè®¾ç½®é€€å‡ºæ ‡å¿—ï¼Œç­‰å¾…çº¿ç¨‹è‡ªç„¶é€€å‡ºï¼ˆè¶…æ—¶å¼ºåˆ¶é€€å‡ºï¼‰

**é€€å‡ºæµç¨‹**ï¼š

```
1. è®¾ç½®å…¨å±€é€€å‡ºæ ‡å¿— (g_app_quit = true)
2. åœæ­¢æ‰€æœ‰ Worker çº¿ç¨‹ï¼ˆNetworkã€Playerã€LogUploadï¼‰
3. åœæ­¢ Event Loopï¼ˆç­‰å¾…äº‹ä»¶å¤„ç†å®Œæˆï¼‰
4. åœæ­¢ UI/LVGL çº¿ç¨‹ï¼ˆæœ€åæ¸…ç† UI èµ„æºï¼‰
5. æ¸…ç†å…¨å±€èµ„æºï¼ˆSingleton å®ä¾‹ï¼‰
6. é€€å‡ºä¸»è¿›ç¨‹
```

**ä»£ç ç¤ºä¾‹**ï¼š

```c
// å…¨å±€é€€å‡ºæ ‡å¿—
static volatile bool g_app_quit = false;

// é€€å‡ºé¡ºåºæ§åˆ¶
static void cleanup_threads(void) {
    // 1. è®¾ç½®é€€å‡ºæ ‡å¿—
    g_app_quit = true;
    
    // 2. åœæ­¢ Worker çº¿ç¨‹ï¼ˆæŒ‰é¡ºåºï¼‰
    log_upload_service_stop();      // LogUploadï¼ˆç¬¬1ï¼‰
    player_service_stop();           // Playerï¼ˆç¬¬2ï¼‰
    network_service_stop();          // Networkï¼ˆç¬¬3ï¼‰
    
    // 3. åœæ­¢ Event Loopï¼ˆå€’æ•°ç¬¬äºŒï¼‰
    event_bus_stop();
    
    // 4. åœæ­¢ UI/LVGLï¼ˆæœ€åï¼‰
    ui_system_cleanup();
    
    // 5. æ¸…ç†å…¨å±€èµ„æº
    cleanup_singletons();
}
```

### 2.4 çº¿ç¨‹é‡å¯ç­–ç•¥

**å¯é‡å¯çº¿ç¨‹çš„é‡å¯è§„åˆ™**ï¼š

| çº¿ç¨‹ | é‡å¯è§¦å‘æ¡ä»¶ | é‡å¯å»¶è¿Ÿ | æœ€å¤§é‡å¯æ¬¡æ•° |
|------|------------|---------|------------|
| Network Worker | ç½‘ç»œå¼‚å¸¸ã€è¿æ¥æ–­å¼€ | 3 ç§’ | 5 æ¬¡/å°æ—¶ |
| Player Worker | æ’­æ”¾å¤±è´¥ã€TPlayer å¼‚å¸¸ | ç«‹å³ | 3 æ¬¡/æ’­æ”¾ |
| LogUpload | ä¸Šä¼ å¤±è´¥ | æŒ‡æ•°é€€é¿ï¼ˆ10s, 30s, 60sï¼‰ | æ— é™åˆ¶ï¼ˆä½ä¼˜å…ˆçº§ï¼‰ |

---

## ä¸‰ã€æ—¥å¿— â†’ è¿œç¨‹ä¸Šä¼ é—­ç¯

### 3.1 å½“å‰çŠ¶æ€

**å·²æœ‰**ï¼š
- âœ… syslog æ—¥å¿—ç³»ç»Ÿ
- âœ… logread æœ¬åœ°è¯»å–
- âœ… LogUploadService è®¾è®¡

**ç¼ºå¤±**ï¼š
- âŒ å…³é”®æ—¥å¿— ring bufferï¼ˆå†…å­˜ï¼‰
- âŒ å¼‚å¸¸è§¦å‘æ‰“åŒ…ç­–ç•¥
- âŒ HTTP ä¸Šä¼ å®ç°ï¼ˆgzipï¼‰

### 3.2 æ—¥å¿—è¿œç¨‹ä¸Šä¼ è®¾è®¡

#### 1. å…³é”®æ—¥å¿— Ring Buffer

```c
// å…³é”®æ—¥å¿— ring bufferï¼ˆå†…å­˜ï¼Œæœ€è¿‘ 1000 æ¡ï¼‰
#define LOG_RING_BUFFER_SIZE 1000

typedef struct {
    char message[256];
    time_t timestamp;
    int level;
} log_entry_t;

static log_entry_t log_ring_buffer[LOG_RING_BUFFER_SIZE];
static int log_ring_index = 0;
static pthread_mutex_t log_ring_mutex = PTHREAD_MUTEX_INITIALIZER;

// å…³é”®æ—¥å¿—è®°å½•ï¼ˆERROR å’Œ WARNINGï¼‰
void log_critical(const char* format, ...) {
    va_list args;
    va_start(args, format);
    
    char buffer[256];
    vsnprintf(buffer, sizeof(buffer), format, args);
    va_end(args);
    
    // å†™å…¥ syslog
    syslog(LOG_ERR, "%s", buffer);
    
    // å†™å…¥ ring buffer
    pthread_mutex_lock(&log_ring_mutex);
    log_entry_t* entry = &log_ring_buffer[log_ring_index];
    strncpy(entry->message, buffer, sizeof(entry->message) - 1);
    entry->timestamp = time(NULL);
    entry->level = LOG_ERR;
    log_ring_index = (log_ring_index + 1) % LOG_RING_BUFFER_SIZE;
    pthread_mutex_unlock(&log_ring_mutex);
}
```

#### 2. å¼‚å¸¸è§¦å‘æ‰“åŒ…

**è§¦å‘æ¡ä»¶**ï¼š
- æ’­æ”¾å¤±è´¥
- ç½‘ç»œè¿ç»­é”™è¯¯ï¼ˆ3 æ¬¡ï¼‰
- å†…å­˜ä¸è¶³
- TPlayer å¼‚å¸¸
- ç”¨æˆ·åé¦ˆæŒ‰é’®è§¦å‘

**æ‰“åŒ…ç­–ç•¥**ï¼š
- æœ€è¿‘ 10 åˆ†é’Ÿçš„ syslog æ—¥å¿—
- Ring buffer ä¸­çš„å…³é”®æ—¥å¿—
- ç³»ç»Ÿä¿¡æ¯ï¼ˆuptimeã€å†…å­˜ã€CPUï¼‰
- åº”ç”¨çŠ¶æ€ï¼ˆç‰ˆæœ¬ã€é…ç½®ï¼‰

```c
// å¼‚å¸¸è§¦å‘æ‰“åŒ…
typedef struct {
    char* logs;           // æ—¥å¿—å†…å®¹ï¼ˆgzip å‹ç¼©ï¼‰
    size_t logs_size;     // å‹ç¼©åå¤§å°
    char device_id[64];   // è®¾å¤‡ID
    char version[32];     // ç‰ˆæœ¬å·
    time_t timestamp;     // æ—¶é—´æˆ³
    int error_code;       // é”™è¯¯ç 
} log_package_t;

log_package_t* package_logs(int error_code) {
    // 1. æ”¶é›† syslogï¼ˆæœ€è¿‘ 10 åˆ†é’Ÿï¼‰
    // 2. æ”¶é›† ring buffer
    // 3. æ”¶é›†ç³»ç»Ÿä¿¡æ¯
    // 4. gzip å‹ç¼©
    // 5. æ„å»º JSON payload
    // ...
}
```

#### 3. HTTP ä¸Šä¼ ï¼ˆgzipï¼‰

```c
// ä½¿ç”¨ libcurl ä¸Šä¼ ï¼ˆgzip å‹ç¼©ï¼‰
int upload_logs(log_package_t* package) {
    CURL* curl = curl_easy_init();
    if (!curl) return -1;
    
    struct curl_slist* headers = NULL;
    headers = curl_slist_append(headers, "Content-Type: application/json");
    headers = curl_slist_append(headers, "Content-Encoding: gzip");
    
    curl_easy_setopt(curl, CURLOPT_URL, "https://api.example.com/logs/upload");
    curl_easy_setopt(curl, CURLOPT_POSTFIELDS, package->logs);
    curl_easy_setopt(curl, CURLOPT_POSTFIELDSIZE, package->logs_size);
    curl_easy_setopt(curl, CURLOPT_HTTPHEADER, headers);
    
    CURLcode res = curl_easy_perform(curl);
    curl_easy_cleanup(curl);
    curl_slist_free_all(headers);
    
    return (res == CURLE_OK) ? 0 : -1;
}
```

### 3.3 å®ç°å»ºè®®

1. **Ring Buffer å¤§å°**ï¼š1000 æ¡ï¼ˆçº¦ 256KB å†…å­˜ï¼‰
2. **æ‰“åŒ…è§¦å‘é¢‘ç‡**ï¼šåŒä¸€é”™è¯¯ 10 åˆ†é’Ÿå†…åªæ‰“åŒ…ä¸€æ¬¡
3. **ä¸Šä¼ è¶…æ—¶**ï¼š10 ç§’
4. **å¤±è´¥é‡è¯•**ï¼šæŒ‡æ•°é€€é¿ï¼ˆ10s, 30s, 60sï¼‰

---

## å››ã€åº”ç”¨å‡çº§çš„å›æ»šç­–ç•¥

### 4.1 é—®é¢˜æè¿°

**é£é™©**ï¼š
- OTA å‡çº§å¤±è´¥ â†’ ç°åœºç –æœº
- æ–°ç‰ˆæœ¬å¯åŠ¨å¤±è´¥ â†’ æ— æ³•å›é€€
- å‡çº§è¿‡ç¨‹ä¸­æ–­ç”µ â†’ ç³»ç»ŸæŸå

### 4.2 å‡çº§å›æ»šè®¾è®¡

#### ç›®å½•ç»“æ„

```
/opt/app/
â”œâ”€â”€ current -> app_v1.0.0/    # å½“å‰è¿è¡Œç‰ˆæœ¬ï¼ˆè½¯é“¾æ¥ï¼‰
â”œâ”€â”€ backup -> app_v0.9.0/     # å¤‡ä»½ç‰ˆæœ¬ï¼ˆè½¯é“¾æ¥ï¼‰
â”œâ”€â”€ app_v1.0.0/               # ç‰ˆæœ¬ç›®å½•
â”‚   â”œâ”€â”€ ktvlv                 # å¯æ‰§è¡Œæ–‡ä»¶
â”‚   â”œâ”€â”€ config.ini            # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ res/                  # èµ„æºæ–‡ä»¶
â””â”€â”€ app_v0.9.0/               # å¤‡ä»½ç‰ˆæœ¬ç›®å½•
```

#### å‡çº§æµç¨‹

```
1. ä¸‹è½½æ–°ç‰ˆæœ¬åˆ°ä¸´æ—¶ç›®å½•ï¼ˆ/tmp/app_v1.1.0/ï¼‰
2. éªŒè¯æ–°ç‰ˆæœ¬ï¼ˆæ ¡éªŒå’Œã€æƒé™æ£€æŸ¥ï¼‰
3. å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆcp -r current backupï¼‰
4. å®‰è£…æ–°ç‰ˆæœ¬ï¼ˆmv /tmp/app_v1.1.0 /opt/app/app_v1.1.0ï¼‰
5. åˆ‡æ¢è½¯é“¾æ¥ï¼ˆln -sfn app_v1.1.0 currentï¼‰
6. å¯åŠ¨æ–°ç‰ˆæœ¬
7. å¥åº·æ£€æŸ¥ï¼ˆå¯åŠ¨å 30 ç§’å†…æ— å´©æºƒï¼‰
8. æˆåŠŸ â†’ åˆ é™¤å¤‡ä»½ï¼›å¤±è´¥ â†’ å›æ»š
```

#### å›æ»šç­–ç•¥

```bash
#!/bin/bash
# å›æ»šè„šæœ¬

CURRENT_LINK="/opt/app/current"
BACKUP_LINK="/opt/app/backup"

# 1. åœæ­¢å½“å‰åº”ç”¨
systemctl stop ktvapp

# 2. åˆ‡æ¢å›å¤‡ä»½ç‰ˆæœ¬
ln -sfn $(readlink $BACKUP_LINK) $CURRENT_LINK

# 3. é‡å¯åº”ç”¨
systemctl start ktvapp

# 4. è®°å½•å›æ»šæ—¥å¿—
echo "$(date): Rollback to $(readlink $CURRENT_LINK)" >> /var/log/ktv_upgrade.log
```

#### å¥åº·æ£€æŸ¥

```c
// å¯åŠ¨åå¥åº·æ£€æŸ¥ï¼ˆ30 ç§’ï¼‰
#define HEALTH_CHECK_TIMEOUT 30

static bool health_check(void) {
    time_t start = time(NULL);
    
    while (time(NULL) - start < HEALTH_CHECK_TIMEOUT) {
        // æ£€æŸ¥ä¸»è¿›ç¨‹æ˜¯å¦å­˜æ´»
        if (kill(getpid(), 0) != 0) {
            return false;  // è¿›ç¨‹å·²æ­»
        }
        
        // æ£€æŸ¥å…³é”®æ¨¡å—çŠ¶æ€
        if (!check_module_status(&g_status)) {
            return false;  // æ¨¡å—å¼‚å¸¸
        }
        
        sleep(1);
    }
    
    return true;  // å¥åº·æ£€æŸ¥é€šè¿‡
}
```

### 4.3 å®ç°å»ºè®®

1. **ç‰ˆæœ¬ç›®å½•å‘½å**ï¼š`app_v{major}.{minor}.{patch}/`
2. **å¤‡ä»½ä¿ç•™**ï¼šè‡³å°‘ä¿ç•™ 1 ä¸ªå¤‡ä»½ç‰ˆæœ¬
3. **å¥åº·æ£€æŸ¥æ—¶é—´**ï¼š30 ç§’ï¼ˆå¯é…ç½®ï¼‰
4. **è‡ªåŠ¨å›æ»š**ï¼šå¥åº·æ£€æŸ¥å¤±è´¥è‡ªåŠ¨å›æ»š

---

## äº”ã€é…ç½®ä¸­å¿ƒçš„åªè¯»/å¯å†™è¾¹ç•Œ

### 5.1 é—®é¢˜æè¿°

**å½“å‰çŠ¶æ€**ï¼š
- é…ç½®æ–‡ä»¶åˆ†æ•£ï¼ˆJSON / INI / SQLite æ··ç”¨ï¼‰
- é…ç½®è¯»å†™è¾¹ç•Œä¸æ˜ç¡®
- çƒ­æ›´æ–°ç­–ç•¥æœªå®šä¹‰

### 5.2 é…ç½®åˆ†ç±»

| é…ç½®ç±»å‹ | å­˜å‚¨ä½ç½® | æ˜¯å¦å¯å†™ | çƒ­æ›´æ–° | é‡å¯ç”Ÿæ•ˆ | ç¤ºä¾‹ |
|---------|---------|---------|--------|---------|------|
| **ç¼–è¯‘æœŸé…ç½®** | ä»£ç ä¸­ï¼ˆå®å®šä¹‰ï¼‰ | âŒ ä¸å¯æ”¹ | âŒ | N/A | åˆ†è¾¨ç‡ã€ç¼“å†²åŒºå¤§å° |
| **è®¾å¤‡çº§é…ç½®** | `/etc/ktv/device.ini` | âœ… ä¸€æ¬¡å†™å…¥ | âŒ | âœ… æ˜¯ | è®¾å¤‡IDã€MACåœ°å€ |
| **è¿è¡ŒæœŸé…ç½®** | `/opt/app/config/config.ini` | âœ… å¯æ”¹ | âœ… æ˜¯ | âŒ å¦ | æœåŠ¡å™¨åœ°å€ã€éŸ³é‡ |

### 5.3 é…ç½®è¾¹ç•Œè§„åˆ™

#### 1. ç¼–è¯‘æœŸé…ç½®ï¼ˆä¸å¯æ”¹ï¼‰

```c
// lv_conf.h
#define LV_HOR_RES_MAX 1280
#define LV_VER_RES_MAX 720
#define LV_MEM_CUSTOM 1

// è¿™äº›é…ç½®åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œè¿è¡Œæ—¶ä¸å¯ä¿®æ”¹
```

#### 2. è®¾å¤‡çº§é…ç½®ï¼ˆä¸€æ¬¡å†™å…¥ï¼‰

```ini
# /etc/ktv/device.iniï¼ˆåªè¯»ï¼Œç³»ç»Ÿåˆå§‹åŒ–æ—¶å†™å…¥ï¼‰
[Device]
device_id=KTV001234567890
mac_address=AA:BB:CC:DD:EE:FF
factory_date=2025-01-01
```

**è§„åˆ™**ï¼š
- ç³»ç»Ÿåˆå§‹åŒ–æ—¶å†™å…¥
- åº”ç”¨è¿è¡Œæ—¶åªè¯»
- ä¿®æ”¹éœ€è¦ root æƒé™
- ä¿®æ”¹åéœ€è¦é‡å¯åº”ç”¨

#### 3. è¿è¡ŒæœŸé…ç½®ï¼ˆUI å¯æ”¹ï¼‰

```ini
# /opt/app/config/config.iniï¼ˆå¯å†™ï¼‰
[Server]
api_url=https://api.example.com
timeout=30

[Player]
default_volume=80
default_audio_track=original

[UI]
theme=dark
language=zh_CN
```

**è§„åˆ™**ï¼š
- UI å¯ä»¥ä¿®æ”¹
- æ”¯æŒçƒ­æ›´æ–°ï¼ˆæ— éœ€é‡å¯ï¼‰
- ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ
- ä½¿ç”¨æ–‡ä»¶é”é˜²æ­¢å¹¶å‘å†™å…¥

### 5.4 çƒ­æ›´æ–°å®ç°

```c
// é…ç½®çƒ­æ›´æ–°ï¼ˆä½¿ç”¨æ–‡ä»¶é”ï¼‰
int update_config(const char* key, const char* value) {
    int fd = open("/opt/app/config/config.ini", O_RDWR);
    if (fd < 0) return -1;
    
    // æ–‡ä»¶é”
    struct flock lock;
    lock.l_type = F_WRLCK;
    lock.l_whence = SEEK_SET;
    lock.l_start = 0;
    lock.l_len = 0;
    
    if (fcntl(fd, F_SETLKW, &lock) < 0) {
        close(fd);
        return -1;
    }
    
    // æ›´æ–°é…ç½®ï¼ˆä½¿ç”¨ inih åº“ï¼‰
    // ...
    
    // é‡Šæ”¾é”
    lock.l_type = F_UNLCK;
    fcntl(fd, F_SETLK, &lock);
    close(fd);
    
    // é€šçŸ¥é…ç½®å˜æ›´
    config_service_notify_change(key, value);
    
    return 0;
}
```

### 5.5 é…ç½®è¯»å–ä¼˜å…ˆçº§

```
1. è¿è¡Œæ—¶é…ç½®ï¼ˆ/opt/app/config/config.iniï¼‰
2. è®¾å¤‡é…ç½®ï¼ˆ/etc/ktv/device.iniï¼‰
3. ç¼–è¯‘æœŸé…ç½®ï¼ˆä»£ç å®å®šä¹‰ï¼‰
```

---

## å…­ã€å¼‚å¸¸å…œåº• UI

### 6.1 é—®é¢˜æè¿°

**å½“å‰é£é™©**ï¼š
- UI å‡è®¾ä¸€åˆ‡æ­£å¸¸
- ç½‘ç»œå¤±è´¥ â†’ ç™½å±
- æ’­æ”¾å¤±è´¥ â†’ æ— æç¤º
- å‡çº§å¤±è´¥ â†’ æ— æ³•æ“ä½œ

### 6.2 å¼‚å¸¸ UI è®¾è®¡

#### 1. ç½‘ç»œå¤±è´¥é¡µ

**è§¦å‘æ¡ä»¶**ï¼š
- HTTP è¯·æ±‚è¿ç»­å¤±è´¥ï¼ˆ3 æ¬¡ï¼‰
- WebSocket è¿æ¥æ–­å¼€
- DNS è§£æå¤±è´¥

**UI è®¾è®¡**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   âš ï¸ ç½‘ç»œè¿æ¥å¤±è´¥        â”‚
â”‚                         â”‚
â”‚   è¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®        â”‚
â”‚                         â”‚
â”‚   [é‡è¯•]  [è®¾ç½®]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. æ’­æ”¾å¤±è´¥é¡µ

**è§¦å‘æ¡ä»¶**ï¼š
- TPlayer æ’­æ”¾å¤±è´¥
- M3U8 ä¸‹è½½å¤±è´¥
- éŸ³è½¨åˆ‡æ¢å¤±è´¥

**UI è®¾è®¡**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   âŒ æ’­æ”¾å¤±è´¥           â”‚
â”‚                         â”‚
â”‚   æ­Œæ›²ï¼šç¨»é¦™            â”‚
â”‚   é”™è¯¯ï¼šç½‘ç»œè¶…æ—¶        â”‚
â”‚                         â”‚
â”‚   [é‡è¯•]  [ä¸‹ä¸€é¦–]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. å‡çº§å¤±è´¥é¡µ

**è§¦å‘æ¡ä»¶**ï¼š
- OTA å‡çº§å¤±è´¥
- ç‰ˆæœ¬æ ¡éªŒå¤±è´¥
- å¥åº·æ£€æŸ¥å¤±è´¥

**UI è®¾è®¡**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   âš ï¸ å‡çº§å¤±è´¥           â”‚
â”‚                         â”‚
â”‚   å·²è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬  â”‚
â”‚                         â”‚
â”‚   [ç¡®å®š]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4. ç©ºæ•°æ®é¡µ

**è§¦å‘æ¡ä»¶**ï¼š
- æœç´¢æ— ç»“æœ
- æ­Œå•ä¸ºç©º
- å†å²è®°å½•ä¸ºç©º

**UI è®¾è®¡**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ“­ æš‚æ— æ•°æ®           â”‚
â”‚                         â”‚
â”‚   è¯·å°è¯•å…¶ä»–æœç´¢æ¡ä»¶    â”‚
â”‚                         â”‚
â”‚   [è¿”å›]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 å®ç°å»ºè®®

1. **ç»Ÿä¸€å¼‚å¸¸é¡µé¢ç»„ä»¶**ï¼š`ErrorPage` ç»„ä»¶ï¼Œå‚æ•°åŒ–é”™è¯¯ç±»å‹å’Œæ¶ˆæ¯
2. **é”™è¯¯ç æ˜ å°„**ï¼šé”™è¯¯ç  â†’ é”™è¯¯æ¶ˆæ¯ â†’ UI é¡µé¢
3. **è‡ªåŠ¨æ¢å¤**ï¼šç½‘ç»œé”™è¯¯ 30 ç§’åè‡ªåŠ¨é‡è¯•
4. **ç”¨æˆ·æ“ä½œ**ï¼šæä¾›é‡è¯•ã€è¿”å›ã€è®¾ç½®ç­‰æ“ä½œæŒ‰é’®

---

## ä¸ƒã€å·¥ç¨‹ç¨³å®šæ€§æ£€æŸ¥æ¸…å•

### 7.1 å¿…é¡»å®ç°é¡¹

- [ ] è¿›ç¨‹çº§ Watchdogï¼ˆå¿ƒè·³ + çŠ¶æ€æ£€æŸ¥ï¼‰
- [ ] systemd æœåŠ¡é…ç½®ï¼ˆè‡ªåŠ¨é‡å¯ï¼‰
- [ ] çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè¡¨ï¼ˆåˆ›å»º/é€€å‡º/é‡å¯ç­–ç•¥ï¼‰
- [ ] ä¼˜é›…é€€å‡ºæµç¨‹ï¼ˆæŒ‰é¡ºåºæ¸…ç†çº¿ç¨‹ï¼‰
- [ ] æ—¥å¿— Ring Bufferï¼ˆå†…å­˜ï¼Œ1000 æ¡ï¼‰
- [ ] å¼‚å¸¸è§¦å‘æ‰“åŒ…ï¼ˆHTTP + gzipï¼‰
- [ ] å‡çº§å›æ»šç­–ç•¥ï¼ˆåŒç‰ˆæœ¬ç›®å½•ï¼‰
- [ ] å¥åº·æ£€æŸ¥æœºåˆ¶ï¼ˆ30 ç§’ï¼‰
- [ ] é…ç½®åˆ†ç±»ï¼ˆç¼–è¯‘æœŸ/è®¾å¤‡çº§/è¿è¡ŒæœŸï¼‰
- [ ] é…ç½®çƒ­æ›´æ–°ï¼ˆæ–‡ä»¶é”ï¼‰
- [ ] å¼‚å¸¸ UI é¡µé¢ï¼ˆç½‘ç»œ/æ’­æ”¾/å‡çº§/ç©ºæ•°æ®ï¼‰

### 7.2 å»ºè®®å®ç°é¡¹

- [ ] çº¿ç¨‹çŠ¶æ€ç›‘æ§ï¼ˆå®æ—¶çŠ¶æ€ä¸ŠæŠ¥ï¼‰
- [ ] èµ„æºä½¿ç”¨ç›‘æ§ï¼ˆå†…å­˜/CPUï¼‰
- [ ] è¿œç¨‹è¯Šæ–­æ¥å£ï¼ˆHTTP APIï¼‰
- [ ] é…ç½®å¤‡ä»½æœºåˆ¶ï¼ˆå‡çº§å‰å¤‡ä»½ï¼‰

### 7.3 ä»£ç å®¡æŸ¥æ£€æŸ¥ç‚¹

1. **çº¿ç¨‹åˆ›å»º**ï¼šæ˜¯å¦æœ‰æ˜ç¡®çš„åˆ›å»ºç‚¹å’Œé€€å‡ºç‚¹ï¼Ÿ
2. **èµ„æºæ¸…ç†**ï¼šé€€å‡ºæ—¶æ˜¯å¦æŒ‰é¡ºåºæ¸…ç†ï¼Ÿ
3. **å¼‚å¸¸å¤„ç†**ï¼šæ˜¯å¦æœ‰ Watchdog æ£€æŸ¥ï¼Ÿ
4. **æ—¥å¿—ä¸Šä¼ **ï¼šå¼‚å¸¸æ—¶æ˜¯å¦è§¦å‘ä¸Šä¼ ï¼Ÿ
5. **é…ç½®æ›´æ–°**ï¼šæ˜¯å¦ä½¿ç”¨æ–‡ä»¶é”ï¼Ÿ
6. **UI å¼‚å¸¸**ï¼šæ˜¯å¦æœ‰å…œåº•é¡µé¢ï¼Ÿ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [çº¿ç¨‹æ¶æ„åŸºçº¿ï¼ˆæœ€ç»ˆç‰ˆï¼‰.md](../çº¿ç¨‹æ¶æ„åŸºçº¿ï¼ˆæœ€ç»ˆç‰ˆï¼‰.md)
- [KTVæ—¥å¿—ç³»ç»Ÿå®Œæ•´æŒ‡å—.md](../guides/KTVæ—¥å¿—ç³»ç»Ÿå®Œæ•´æŒ‡å—.md)
- [æ¶ˆæ¯é˜Ÿåˆ—å®Œæ•´æŒ‡å—.md](../æ¶ˆæ¯é˜Ÿåˆ—å®Œæ•´æŒ‡å—.md)
- [èµ„æºç®¡ç†è§„èŒƒv1.md](../èµ„æºç®¡ç†è§„èŒƒv1.md)

---

**æœ€åæ›´æ–°**: 2025-12-30  
**ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ

