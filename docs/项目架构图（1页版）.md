# KTVLV 项目架构图（1页版）

> **文档版本**：v1.0  
> **最后更新**：2025-12-30  
> **状态**：✅ 对外讲解文档  
> **用途**：给财务/给老板过会/开发团队内部SOP

---

## 🏗️ 系统架构总览

```text
┌──────────────────────────────────────────────────────────────┐
│                          F133 SoC / Tina Linux               │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │                  OS / Kernel / Driver Layer              │ │
│  │                                                          │ │
│  │  • Display Driver  → F133 LCD/HDMI Framebuffer           │ │
│  │  • Touch Input Driver → /dev/input/eventX                │ │
│  │  • Audio Output Driver → ALSA / TPlayer / I2S            │ │
│  │  • FileSystem → ext4 / squashfs / UDisk                  │ │
│  └──────────────────────────────────────────────────────────┘ │
│                         ▲                        ▲            │
│                         │ read(fd) / eventX      │ framebuffer │
└─────────────────────────┼────────────────────────┼─────────────┘
                          │                        │
                          ▼                        ▼
          ┌────────────────────────────────────────────────────────┐
          │                 Application Runtime Layer              │
          │                                                        │
          │  ┌──────────────────────────────────────────────────┐    │
          │  │              UI Main Thread                       │    │
          │  │              (LVGL Single Owner)                  │    │
          │  │──────────────────────────────────────────────────│    │
          │  │ • lv_init / display_drv_init()                   │    │
          │  │ • lv_timer_handler() / 5ms tick                 │    │
          │  │ • 输入事件处理（触摸屏/遥控器，LVGL事件回调）    │    │
          │  │ • 控件命中/事件派发(LV_EVENT_CLICKED)            │    │
          │  │ • Controller/Service 编排（主线程同步）          │    │
          │  │ • 网络请求（同步libcurl，主线程）               │    │
          │  │ • SQLite访问（同步，主线程）                     │    │
          │  │ • UI刷新（LVGL控件更新）                          │    │
          │  └──────────────────────────────────────────────────┘    │
          │                                      ▲                 │
          │                                      │ pop             │
          │         ┌──────────────────────────────────────────┐    │
          │         │        UiEventQueue (std::queue+mutex)     │    │
          │         │        • 下载线程/播放器 → UI              │    │
          │         │        • 固定容量 64 / 溢出丢旧消息       │    │
          │         │        • UI唯一消费者                      │    │
          │         └──────────────────────────────────────────┘    │
          │                   ▲                    ▲               │
          │                   │ push               │ push           │
          │  ┌────────────────┘                    └────────────────┐ │
          │  │                                                  │ │
          │  │  ┌──────────────────┐   ┌────────────────────┐ │ │
          │  │  │ Download Thread   │   │ tplayer内部线程     │ │ │
          │  │  │ (Producer)        │   │ (Producer)         │ │ │
          │  │  │────────────────── │   │────────────────────│ │ │
          │  │  │ • m3u8/ts下载     │   │ • 播放状态回调     │ │ │
          │  │  │ • 串行执行        │   │ • 进度更新         │ │ │
          │  │  └──────────────────┘   └────────────────────┘ │ │
          │  │                                                  │ │
          └──┴──────────────────────────────────────────────────┴─┘
                                         │
                                         │ 控件/事件调用
                                         ▼
                    ┌──────────────────────────────────────────┐
                    │              LVGL Framework              │
                    │──────────────────────────────────────────│
                    │ • Render Pipeline                        │
                    │ • Event Dispatch / Input Device          │
                    │ • Font / Image / Layout / PageManager    │
                    │ • 控件树（Button/Label/List/Grid）       │
                    └──────────────────────────────────────────┘
                                         │
                                         │ Framebuffer
                                         ▼
        ┌────────────────────────────────────────────────────────────────┐
        │                          LCD / HDMI 显示输出                   │
        └────────────────────────────────────────────────────────────────┘
```text

---

## 🧵 线程模型（MVP：UI + 下载 + 播放器内部）

| 线程 | 职责 | 交互方式 |
|------|------|---------|
| **UI主线程** | LVGL渲染、控件逻辑、Controller/Service 编排 | 消费 UiEventQueue |
| **下载线程** | m3u8/ts 下载（串行） | 生产 → UiEventQueue |
| **播放器内部线程** | 播放状态回调（tplayer 黑盒） | 生产 → UiEventQueue |

---

## 📩 消息队列（1个）

| 队列 | 流向 | 实现 |
|------|------|------|
| **UiEventQueue** | 下载线程/播放器 → UI | std::queue + std::mutex |

---

## 🔄 数据流向

### 1. 用户输入流程（LVGL 事件）

```text
触摸屏 → evdev → LVGL事件回调（UI主线程）→ Controller/Service → UI刷新
```

### 2. 点歌流程（播放控制）

```text
UI点击 → Controller → PlayerService（Adapter→tplayer）→ 播放
```

### 3. 播放状态更新流程（回调→事件）

```text
tplayer回调（内部线程）→ UiEventQueue → UI主线程 → 更新播放按钮/进度条
```

### 4. 搜索/列表流程（同步网络）

```text
UI输入 → Service（主线程，同步libcurl + cJSON解析）→ 更新UiModel → UI刷新
```

---

## 📍 架构价值点（用于向老板/财务/技术面解释）

| 优势 | 解释 |
|------|------|
| **UI线程隔离** | UI不卡死、不黑屏，触摸高响应稳定 |
| **事件驱动模型** | 跨线程通信安全、可扩展、快速定位问题 |
| **解耦** | UI与业务线程没有直接耦合，后期重构成本低 |
| **可以快速量产** | 无需引入过度抽象、事件总线、IOC框架 |
| **Tina & F133 Friendly** | 符合嵌入式资源约束和输入模型（/dev/input/eventX） |

---

## 🎯 核心设计原则

### ✅ 已实现

- ✅ **线程职责边界明确**：UI主线程/下载线程/播放器内部线程 各司其职
- ✅ **事件驱动**：下载/播放器回调通过事件回到UI
- ✅ **队列通信**：避免跨线程UI调用
- ✅ **同步网络**：普通网络请求在主线程同步执行（快速响应）
- ✅ **MVP可用**：可量产可扩展

### ❌ 不做的（避免过度设计）

- ❌ 工厂模式泛滥
- ❌ 虚基类、接口抽象层层叠
- ❌ IOC容器、事件总线乱飞
- ❌ 架构师自嗨的架空设计

---

## 🎯 一句"能震住外行"的总结台词（建议粘贴到PPT）

> **本架构基于 Single-Owner UI Thread + Event-Driven 线程通信模型。**  
> **UI 独占 LVGL 的渲染与控件生命周期，所有输入与业务状态通过定长消息队列异步分发，避免跨线程 UI 调用导致的卡顿或异常，确保在弱算力 Tina/F133 环境下依然保持高稳定性和低延迟响应。**

---

## 🛡️ 落地风险与规避手段

| 风险 | 场景 | 规避策略 |
|------|------|---------|
| UI卡顿 | 在UI线程执行网络/播放/解码 | 禁止耗时操作 → push队列给业务线程 |
| 输入丢失 | 事件 >64频率瞬发 | 队列溢出弃旧、实时性优先 |
| 死锁 | 多个queue双向锁等待 | 单向通信、仅UI消费 |
| LVGL崩溃 | 跨线程UI操作 | 单线程UI原则、回调只发事件 |

---

## 🧠 说服财务/老板的说辞

> 这套架构以"能跑、能上量、能维护"为基准，不堆叠过度抽象或设计模式，在 Tina + F133 的资源条件下最大化稳定性与迭代速度。后续扩展播放器/遥控器/蓝牙设备时不需要推翻架构，只需增加 Producer 即可。

---

## 📊 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| **硬件** | F133 (ARM Cortex-A7) | 全志芯片 |
| **系统** | Tina Linux | 嵌入式Linux |
| **显示** | Framebuffer | 直接帧缓冲 |
| **输入** | evdev | Linux输入事件 |
| **音频** | TPlayer SDK | 全志官方播放器 |
| **UI框架** | LVGL 8.x | 轻量级GUI |
| **网络** | libcurl | HTTP客户端 |
| **日志** | syslog | 系统日志 |
| **队列** | std::queue + std::mutex | 标准库，简单可靠 |

---

## 🚀 架构优势

1. **简单可靠**：标准库，无需额外依赖
2. **性能足够**：MVP阶段事件频率不高，完全够用
3. **易于维护**：团队熟悉，问题少
4. **技术决策**：使用标准库 `std::queue + std::mutex + condition_variable`，不使用无锁队列
5. **不过度设计**：保持2/5抽象层级，避免过度包装

---

## 📋 开发规范

### ✅ 必须遵守

- ✅ UI线程只消费队列，不直接调用tplayer
- ✅ 其他线程只生产队列，不直接调用LVGL
- ✅ 队列容量固定64，溢出丢弃最旧消息
- ✅ 消息只传ID/指针，不传大对象

### ❌ 禁止事项

- ❌ 跨线程直接调用LVGL API
- ❌ UI线程等待业务线程同步返回
- ❌ 队列无限增长
- ❌ 消息中传递大结构或图片

---

## 💡 一句话总结（技术版）

> **MVP采用“UI主线程 + 下载线程 + 播放器内部回调 + 1个UiEventQueue”。**  
> **UI只在主线程更新；普通网络/SQLite同步执行；下载与播放器回调通过事件回到UI。**

## 💡 一句话总结（对外版）

> **本架构基于 Single-Owner UI Thread + Event-Driven 线程通信模型，UI 独占 LVGL 的渲染与控件生命周期，所有输入与业务状态通过定长消息队列异步分发，避免跨线程 UI 调用导致的卡顿或异常，确保在弱算力 Tina/F133 环境下依然保持高稳定性和低延迟响应。**

---

## 📚 相关文档

- **架构成熟度评估**: [架构成熟度评估与包装原则.md](./架构成熟度评估与包装原则.md)
- **消息队列实现**: [消息队列实现与最佳实践.md](./消息队列实现与最佳实践.md)
- **线程架构基线**: [线程架构基线（最终版）.md](./线程架构基线（最终版）.md)
- **项目架构总览**: [项目架构设计总览.md](./architecture/项目架构设计总览.md)

---

**最后更新**: 2025-12-30  
**状态**: ✅ 对外讲解文档，1页版架构图

