# è¾“å…¥æ³•æ¶æ„è®¾è®¡ï¼ˆå®šç‰ˆï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
> **æœ€åæ›´æ–°**ï¼š2026-01-07  
> **çŠ¶æ€**ï¼šâœ… å®šç‰ˆï¼ˆMVPç®€åŒ–æ¶æ„ï¼‰  
> **é€‚ç”¨åœºæ™¯**ï¼šé«˜é¢‘æœ¬åœ°äº¤äº’ï¼ˆæ‹¼éŸ³/é¦–å­—æ¯/æ¨¡ç³Šæœç´¢ï¼‰  
> **ç›¸å…³æ–‡æ¡£**ï¼š
> - [å·¥ç¨‹è§„èŒƒä¸é¿å‘æŒ‡å—ï¼ˆå®šç‰ˆï¼‰.md](../guides/å·¥ç¨‹è§„èŒƒä¸é¿å‘æŒ‡å—ï¼ˆå®šç‰ˆï¼‰.md)
> - [è¾“å…¥è®¾å¤‡ä¸äº¤äº’è®¾è®¡.md](./è¾“å…¥è®¾å¤‡ä¸äº¤äº’è®¾è®¡.md)

---

## ğŸ¯ æ ¸å¿ƒç»“è®ºï¼ˆä¸€å¥è¯å®šè°ƒï¼‰

> **è¾“å…¥æ³•å±äºé«˜é¢‘æœ¬åœ°äº¤äº’ç³»ç»Ÿï¼Œä¸»é“¾è·¯ç¦æ­¢ä»»ä½•ç½‘ç»œä¸é˜»å¡æ“ä½œï¼Œç½‘ç»œèƒ½åŠ›ä»…ç”¨äºåå°è¡¥å……ç¼“å­˜ã€‚**

---

## âš ï¸ ä¸ºä»€ä¹ˆè¾“å…¥æ³•æ˜¯"å®Œå…¨ä¸åŒçš„ä¸€ç±»åœºæ™¯"ï¼Ÿ

### è¾“å…¥æ³•çš„æœ¬è´¨ç‰¹å¾

- **é«˜é¢‘**ï¼šå‡ åæ¯«ç§’ä¸€æ¬¡æŒ‰é”®
- **å¼ºè¿ç»­æ€§**ï¼šç”¨æˆ·è¿ç»­è¾“å…¥ï¼Œä¸èƒ½ä¸­æ–­
- **ç”¨æˆ·é¢„æœŸ 0 å»¶è¿Ÿ**ï¼šæŒ‰é”®å³å“åº”
- **ä¸èƒ½ loading**ï¼šä¸èƒ½æ˜¾ç¤ºåŠ è½½çŠ¶æ€
- **ä¸èƒ½ç¦ç”¨**ï¼šä¸èƒ½ç¦ç”¨è¾“å…¥æ¡†

ğŸ‘‰ **è¿™ä¸æ™®é€šæŒ‰é’®ç‚¹å‡»ï¼ˆåˆ†ç±»ç‚¹å‡»ã€æ¦œå•ç‚¹å‡»ã€é¡µé¢è·³è½¬ï¼‰å®Œå…¨ä¸æ˜¯ä¸€ç±»ä¸œè¥¿ã€‚**

---

## ğŸ”’ è¾“å…¥æ³• 4 å¤§é“å¾‹ï¼ˆå®šç‰ˆï¼‰

1. **ä»»ä½•ä¸€æ¬¡æŒ‰é”®éƒ½ä¸èƒ½è§¦å‘ç½‘ç»œ**
2. **ä»»ä½•ä¸€æ¬¡æŒ‰é”®éƒ½ä¸èƒ½é˜»å¡**
3. **ä¸»è·¯å¾„åªèµ°æœ¬åœ°æ•°æ®**
4. **ç½‘ç»œåªèƒ½"å»¶åã€åˆå¹¶ã€è¡¥å…¨"**

---

## âŒ é”™è¯¯æ¨¡å‹ï¼ˆä¸€å®šä¼šå¡ï¼‰

```text
KeyPress
 â†’ Controller
   â†’ Service
     â†’ ç½‘ç»œï¼ˆé˜»å¡ï¼‰
```

**é—®é¢˜**ï¼š
- æ¯æ¬¡æŒ‰é”®éƒ½è§¦å‘ç½‘ç»œè¯·æ±‚
- UI ä¼šå¡é¡¿ã€å»¶è¿Ÿ
- ç”¨æˆ·ä½“éªŒæå·®

---

## âœ… æ­£ç¡®æ¨¡å‹ï¼ˆå®šç‰ˆï¼‰

```text
KeyPressï¼ˆä¸»é“¾è·¯ï¼‰
 â†’ InputController
   â†’ æœ¬åœ°ç´¢å¼•æŸ¥è¯¢ï¼ˆå†…å­˜ / SQLiteï¼‰
 â†’ UI å³æ—¶åˆ·æ–°

ï¼ˆåŒæ—¶ï¼Œå¯é€‰ï¼‰
KeyPress
 â†’ è§¦å‘"å»¶è¿Ÿç½‘ç»œä»»åŠ¡"ï¼ˆdebounce 300msï¼‰
   â†’ Download Thread
     â†’ ç½‘ç»œè¯·æ±‚ï¼ˆåå°ï¼‰
     â†’ æ›´æ–°æœ¬åœ°ç¼“å­˜
```

**ä¸»é“¾è·¯ = 100% æœ¬åœ°ï¼Œç½‘ç»œ = åå°è¡¥å……**

---

## ğŸ“ è¾“å…¥æ³•å­ç³»ç»Ÿç»“æ„ï¼ˆç‹¬ç«‹å­ç³»ç»Ÿï¼‰

### ç›®å½•ç»“æ„

```
app/
â”œâ”€â”€ input/                          ğŸ¨ å·¥ç¨‹å¸ˆ Aï¼ˆUIï¼‰âš™ï¸ Bï¼ˆå¼•æ“ï¼‰
â”‚   â”œâ”€â”€ input_controller.c          ğŸ”’ é€»è¾‘å•ä¾‹ï¼ˆä¸ç¢°ç½‘ç»œï¼‰
â”‚   â”œâ”€â”€ input_controller.h
â”‚   â”œâ”€â”€ input_engine.c             âš™ï¸ Bï¼ˆæœ¬åœ°åŒ¹é…å¼•æ“ï¼‰
â”‚   â”œâ”€â”€ input_engine.h
â”‚   â”œâ”€â”€ input_cache.c               âš™ï¸ Bï¼ˆå†…å­˜ç´¢å¼•ï¼‰
â”‚   â”œâ”€â”€ input_cache.h
â”‚   â”œâ”€â”€ input_model.c               ğŸ¨ Aï¼ˆè¾“å…¥çŠ¶æ€ï¼‰
â”‚   â””â”€â”€ input_model.h
```

### å…³é”®åŸåˆ™

> âš ï¸ **è¾“å…¥æ³•ä¸å¤ç”¨æ™®é€š Controller / Service**  
> è¿™æ˜¯æ¶æ„ä¸Šéå¸¸é‡è¦çš„ä¸€ç‚¹

---

## ğŸ§µ è¾“å…¥æ³•çº¿ç¨‹æ¨¡å‹ï¼ˆæ¸…æ™°ï¼‰

```text
Main Threadï¼ˆä¸»é“¾è·¯ï¼‰
- KeyPress äº‹ä»¶
- InputController
- æœ¬åœ°åŒ¹é…ï¼ˆå†…å­˜/SQLiteï¼‰
- UI åˆ·æ–°ï¼ˆå³æ—¶ï¼‰

Download Threadï¼ˆåå°è¡¥å……ï¼‰
- äº‘è¯åº“åŒæ­¥
- è”æƒ³æ•°æ®æ›´æ–°
- çƒ­é—¨è¯è¡¥å…¨
```

ğŸ‘‰ **ä¸»çº¿ç¨‹æ°¸ä¸é˜»å¡**

---

## ğŸ“‹ è¾“å…¥æ³•ä¸»é“¾è·¯ï¼šæœ¬åœ°å³æ—¶å¤„ç†ï¼ˆå¿…é¡»ï¼‰

### 1ï¸âƒ£ æŒ‰é”®å›è°ƒï¼ˆä»ç„¶è¦å¿«ï¼‰

```c
static void on_key_press(lv_event_t* e) {
    char key = lv_event_get_key(e);
    input_controller_on_key(key);
}
```

**è§„åˆ™**ï¼š
- âœ… ç«‹å³è¿”å›
- âœ… ä¸é˜»å¡
- âœ… ä¸è§¦å‘ç½‘ç»œ

---

### 2ï¸âƒ£ InputControllerï¼ˆä¸ç¢°ç½‘ç»œï¼‰

```c
void input_controller_on_key(char key) {
    // 1. æ›´æ–°è¾“å…¥æ¨¡å‹
    input_model_append(key);
    
    // 2. æœ¬åœ°åŒ¹é…ï¼ˆå†…å­˜/SQLiteï¼‰
    input_engine_match();
    
    // 3. UI å³æ—¶åˆ·æ–°
    ui_refresh_input();
    
    // 4. è§¦å‘å»¶è¿Ÿç½‘ç»œä»»åŠ¡ï¼ˆå¯é€‰ï¼Œä¸é˜»å¡ï¼‰
    input_controller_trigger_cloud_suggest();
}
```

**è§„åˆ™**ï¼š
- âœ… æ— é˜»å¡
- âœ… æ— ç½‘ç»œ
- âœ… æ—  IOï¼ˆSQLite é™¤å¤–ï¼Œå› ä¸ºæå¿«ï¼‰

---

### 3ï¸âƒ£ æœ¬åœ°åŒ¹é…æ¥æºï¼ˆä¼˜å…ˆçº§ï¼‰

| é¡ºåº | æ•°æ®æ¥æº | è¯´æ˜ |
|------|---------|------|
| 1 | **å†…å­˜ç´¢å¼•**ï¼ˆæœ€ä¼˜ï¼‰ | é¢„åŠ è½½çƒ­é—¨è¯ã€å†å²è®°å½• |
| 2 | **SQLite**ï¼ˆåŒæ­¥ã€æå¿«ï¼‰ | æœ¬åœ°è¯åº“ã€å†å²æœç´¢ |
| 3 | **æœ¬åœ°æ–‡ä»¶**ï¼ˆå¯é€‰ï¼‰ | é™æ€è¯åº“æ–‡ä»¶ |

> â— **SQLite åœ¨è¿™é‡Œæ˜¯å…è®¸çš„**  
> å› ä¸ºæ˜¯æœ¬åœ°ã€æ¯«ç§’çº§ã€å¯é¢„æœŸ

---

## ğŸŒ ç½‘ç»œçš„æ­£ç¡®è§’è‰²ï¼šè¡¥å…… & çº å

### ç½‘ç»œçš„ç”¨é€”

- çƒ­é—¨è¯è¡¥å…¨
- è”æƒ³æ’åºä¼˜åŒ–
- äº‘ç«¯è¯åº“åŒæ­¥

### æ­£ç¡®è§¦å‘æ–¹å¼ï¼ˆåªèƒ½è¿™æ ·ï¼‰

#### âœ… å»¶è¿Ÿè§¦å‘ï¼ˆdebounceï¼‰

```c
// ç”¨æˆ·åœæ­¢è¾“å…¥ 300ms åï¼Œå‘ 1 æ¬¡ç½‘ç»œè¯·æ±‚
void input_controller_trigger_cloud_suggest(void) {
    // å–æ¶ˆä¹‹å‰çš„ä»»åŠ¡
    input_debounce_cancel();
    
    // å»¶è¿Ÿ 300ms è§¦å‘
    input_debounce_start(300, on_debounce_timeout);
}

void on_debounce_timeout(void) {
    // å‘é€åˆ°ä¸‹è½½çº¿ç¨‹
    download_thread_post_task(CLOUD_SUGGEST_TASK);
}
```

#### âœ… åå°çº¿ç¨‹

```c
// Download Thread å¤„ç†
void download_thread_handle_cloud_suggest(const char* keyword) {
    // ç½‘ç»œè¯·æ±‚
    char* json = network_get_json("/api/suggest?q=%s", keyword);
    
    // è§£æå¹¶æ›´æ–°ç¼“å­˜
    input_cache_update_cloud_suggest(json);
    
    // ä¸å¼ºåˆ¶åˆ·æ–° UIï¼Œä¸‹æ¬¡è¾“å…¥è‡ªç„¶ç”Ÿæ•ˆ
}
```

#### âœ… ç»“æœ"åªæ›´æ–°ç¼“å­˜ï¼Œä¸å¼ºåˆ¶åˆ·æ–° UI"

```c
void on_cloud_suggest_ready(const char* keyword, const char* suggestions) {
    // æ›´æ–°æœ¬åœ°ç¼“å­˜
    input_cache_update(keyword, suggestions);
    
    // ä¸å¼ºåˆ¶åˆ·æ–° UI
    // ä¸‹æ¬¡ç”¨æˆ·è¾“å…¥æ—¶ï¼Œè‡ªç„¶ä»ç¼“å­˜è¯»å–
}
```

---

## ğŸš« å·¥ç¨‹ä¸Šæœ€å®¹æ˜“è¸©çš„ 5 ä¸ªå‘ï¼ˆæå‰å‘Šè¯‰ä½ ï¼‰

1. âŒ **æ¯æ¬¡ keypress éƒ½æŸ¥ç½‘ç»œ** â†’ å¡é¡¿ã€å»¶è¿Ÿ
2. âŒ **keypress èµ° Event Queue** â†’ å»¶è¿Ÿã€ä¸è¿ç»­
3. âŒ **keypress è§¦å‘ loading** â†’ æ‰“æ–­ç”¨æˆ·è¾“å…¥
4. âŒ **è¾“å…¥æ³•å¤ç”¨æ™®é€š Controller** â†’ æ¶æ„æ··ä¹±
5. âŒ **ç½‘ç»œç»“æœå¼ºè¡Œåˆ·æ–° UI** â†’ æ‰“æ–­ç”¨æˆ·è¾“å…¥

**è¿™äº›ä»»æ„ä¸€ä¸ªï¼Œéƒ½ä¼šè®©è¾“å…¥æ³•"æ‰‹æ„Ÿç‚¸è£‚"ã€‚**

---

## ğŸ“Š è¾“å…¥æ³•ä¸ç°æœ‰æ¶æ„çš„å…³ç³»

| ç³»ç»Ÿ | æ˜¯å¦å¤ç”¨ | è¯´æ˜ |
|------|---------|------|
| **UI å±‚** | âœ… | è¾“å…¥æ¡†ã€ç»“æœæ˜¾ç¤º |
| **Event** | âŒ | ä¸»é“¾è·¯ä¸ç”¨ Eventï¼ˆæœ¬åœ°å³æ—¶ï¼‰ |
| **Controller** | âŒ | ç‹¬ç«‹ InputController |
| **Service** | âŒ | ä¸å¤ç”¨æ™®é€š Service |
| **Download Thread** | âœ… | å¤ç”¨ä¸‹è½½çº¿ç¨‹ï¼ˆåå°ç½‘ç»œï¼‰ |
| **SQLite** | âœ… | æœ¬åœ°è¯åº“ã€å†å²æœç´¢ |

---

## ğŸ’» ä»£ç çº§æ¨¡æ¿ï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼‰

### InputControllerï¼ˆæœ€å°å®ç°ï¼‰

```c
// input_controller.h
#ifndef INPUT_CONTROLLER_H
#define INPUT_CONTROLLER_H

typedef struct {
    char buffer[256];
    int length;
} InputModel;

void input_controller_init(void);
void input_controller_on_key(char key);
void input_controller_clear(void);
const char* input_controller_get_text(void);
void input_controller_trigger_cloud_suggest(void);

#endif
```

```c
// input_controller.c
#include "input_controller.h"
#include "input_engine.h"
#include "input_cache.h"
#include "input_model.h"

static InputModel g_input_model = {0};

void input_controller_init(void) {
    input_engine_init();
    input_cache_init();
}

void input_controller_on_key(char key) {
    // 1. æ›´æ–°è¾“å…¥æ¨¡å‹
    if (g_input_model.length < sizeof(g_input_model.buffer) - 1) {
        g_input_model.buffer[g_input_model.length++] = key;
        g_input_model.buffer[g_input_model.length] = '\0';
    }
    
    // 2. æœ¬åœ°åŒ¹é…ï¼ˆå†…å­˜/SQLiteï¼‰
    input_engine_match(g_input_model.buffer);
    
    // 3. UI å³æ—¶åˆ·æ–°
    ui_refresh_input();
    
    // 4. è§¦å‘å»¶è¿Ÿç½‘ç»œä»»åŠ¡ï¼ˆä¸é˜»å¡ï¼‰
    input_controller_trigger_cloud_suggest();
}

void input_controller_trigger_cloud_suggest(void) {
    // debounce 300msï¼Œåå°çº¿ç¨‹å¤„ç†
    // å®ç°ç»†èŠ‚...
}
```

---

### InputEngineï¼ˆæœ¬åœ°åŒ¹é…ï¼‰

```c
// input_engine.h
#ifndef INPUT_ENGINE_H
#define INPUT_ENGINE_H

typedef struct {
    char* text;
    int score;
} MatchResult;

void input_engine_init(void);
int input_engine_match(const char* keyword, MatchResult* results, int max_results);
void input_engine_cleanup(void);

#endif
```

```c
// input_engine.c
#include "input_engine.h"
#include "input_cache.h"
#include <string.h>
#include <ctype.h>

// æœ¬åœ°åŒ¹é…ï¼šå†…å­˜ç´¢å¼• + SQLite
int input_engine_match(const char* keyword, MatchResult* results, int max_results) {
    int count = 0;
    
    // 1. ä»å†…å­˜ç´¢å¼•åŒ¹é…ï¼ˆæœ€å¿«ï¼‰
    count = input_cache_match_memory(keyword, results, max_results);
    
    // 2. å¦‚æœä¸å¤Ÿï¼Œä» SQLite åŒ¹é…
    if (count < max_results) {
        int sqlite_count = input_cache_match_sqlite(
            keyword, 
            results + count, 
            max_results - count
        );
        count += sqlite_count;
    }
    
    return count;
}
```

---

## ğŸ”„ è¾“å…¥æ³•ä¸»é“¾è·¯ vs ç½‘ç»œè¡¥å……ï¼ˆæ—¶åºå›¾ï¼‰

```text
ç”¨æˆ·è¾“å…¥ "å‘¨"
  â†“
InputControllerï¼ˆä¸»çº¿ç¨‹ï¼‰
  â†“
æœ¬åœ°åŒ¹é…ï¼ˆå†…å­˜/SQLiteï¼Œ< 10msï¼‰
  â†“
UI å³æ—¶åˆ·æ–°ï¼ˆæ˜¾ç¤º"å‘¨æ°ä¼¦"ç­‰ï¼‰
  â†“
è§¦å‘å»¶è¿Ÿç½‘ç»œä»»åŠ¡ï¼ˆdebounce 300msï¼‰
  â†“
[300ms åï¼Œç”¨æˆ·åœæ­¢è¾“å…¥]
  â†“
Download Thread
  â†“
ç½‘ç»œè¯·æ±‚ï¼ˆ/api/suggest?q=å‘¨ï¼‰
  â†“
æ›´æ–°æœ¬åœ°ç¼“å­˜
  â†“
[ä¸‹æ¬¡ç”¨æˆ·è¾“å…¥æ—¶ï¼Œè‡ªç„¶ä»ç¼“å­˜è¯»å–]
```

---

## ğŸ“‹ è¾“å…¥æ³•ä¸æ™®é€šæŒ‰é’®çš„åŒºåˆ«

| åœºæ™¯ | æ™®é€šæŒ‰é’® | è¾“å…¥æ³• |
|------|---------|--------|
| **é¢‘ç‡** | ä½é¢‘ï¼ˆç§’çº§ï¼‰ | é«˜é¢‘ï¼ˆæ¯«ç§’çº§ï¼‰ |
| **å»¶è¿Ÿå®¹å¿** | å¯æ˜¾ç¤º loading | 0 å»¶è¿Ÿ |
| **ç½‘ç»œ** | å¯åŒæ­¥é˜»å¡ | ç¦æ­¢é˜»å¡ |
| **Event** | å¯ç”¨ | ä¸»é“¾è·¯ä¸ç”¨ |
| **Controller** | æ™®é€š Controller | ç‹¬ç«‹ InputController |
| **Service** | æ™®é€š Service | ä¸å¤ç”¨ Service |

---

## ğŸ¯ ä¸€å¥è¯æ€»ç»“ï¼ˆå¯ä»¥å†™è¿›è§„èŒƒï¼‰

> **è¾“å…¥æ³•å±äºé«˜é¢‘æœ¬åœ°äº¤äº’ç³»ç»Ÿï¼Œä¸»é“¾è·¯ç¦æ­¢ä»»ä½•ç½‘ç»œä¸é˜»å¡æ“ä½œï¼Œç½‘ç»œèƒ½åŠ›ä»…ç”¨äºåå°è¡¥å……ç¼“å­˜ã€‚**

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å·¥ç¨‹è§„èŒƒä¸é¿å‘æŒ‡å—ï¼ˆå®šç‰ˆï¼‰.md](../guides/å·¥ç¨‹è§„èŒƒä¸é¿å‘æŒ‡å—ï¼ˆå®šç‰ˆï¼‰.md) â­â­â­ **å¿…è¯»**
- [è¾“å…¥è®¾å¤‡ä¸äº¤äº’è®¾è®¡.md](./è¾“å…¥è®¾å¤‡ä¸äº¤äº’è®¾è®¡.md)
- [é¡¹ç›®æ¶æ„å›¾ï¼ˆ1é¡µç‰ˆï¼‰.md](../é¡¹ç›®æ¶æ„å›¾ï¼ˆ1é¡µç‰ˆï¼‰.md)

---

**æœ€åæ›´æ–°**: 2026-01-07  
**çŠ¶æ€**: âœ… å®šç‰ˆï¼ˆMVPç®€åŒ–æ¶æ„ï¼‰  
**ç»´æŠ¤è€…**: Tech Product Owner

