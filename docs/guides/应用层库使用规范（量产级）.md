# åº”ç”¨å±‚åº“ä½¿ç”¨è§„èŒƒï¼ˆé‡äº§çº§ï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
> **æœ€åæ›´æ–°**ï¼š2025-12-30  
> **çŠ¶æ€**ï¼šâœ… æ ¸å¿ƒæ–‡æ¡£ï¼ˆå·¥ç¨‹è§„èŒƒ - é‡äº§çº§ï¼‰  
> **é€‚ç”¨å¹³å°**ï¼šF133 / Tina Linux  
> **ç›®æ ‡**ï¼šå®šä¹‰åº”ç”¨å±‚åº“çš„ä½¿ç”¨è¾¹ç•Œã€æœ€ä½³å®è·µä¸ç¦æ­¢é¡¹ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨é•¿æœŸè¿è¡Œä¸é‡äº§ç¯å¢ƒä¸‹çš„ç¨³å®šæ€§ä¸å¯ç»´æŠ¤æ€§

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼ˆä¸€å¥è¯ï¼‰

> **æœ¬é¡¹ç›®åº”ç”¨å±‚ä¾èµ–åº“æ•°é‡æœ‰é™ï¼Œå‡é‡‡ç”¨æˆç†Ÿã€å¯æ§çš„ç³»ç»Ÿçº§ä¸å¼€æºåº“ã€‚æ¯ä¸ªåº“å‡æœ‰æ˜ç¡®çš„ä½¿ç”¨è¾¹ç•Œã€æœ€ä½³å®è·µä¸ç¦æ­¢é¡¹ï¼Œç¦æ­¢è·¨å±‚è°ƒç”¨ã€ç¦æ­¢è·¨çº¿ç¨‹è¯¯ç”¨ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨é•¿æœŸè¿è¡Œä¸é‡äº§ç¯å¢ƒä¸‹çš„ç¨³å®šæ€§ä¸å¯ç»´æŠ¤æ€§ã€‚**

---

## ğŸ“‹ ç›®å½•

1. [åº“æ€»ä½“ç›˜ç‚¹](#ä¸€-åº“æ€»ä½“ç›˜ç‚¹)
2. [é€åº“æ¸…å• + æœ€ä½³å®è·µ + é¿å‘æŒ‡å—](#äºŒ-é€åº“æ¸…å•--æœ€ä½³å®è·µ--é¿å‘æŒ‡å—)
3. [åº“ â†’ çº¿ç¨‹ â†’ æ¨¡å—æ˜ å°„è¡¨](#ä¸‰-åº“--çº¿ç¨‹--æ¨¡å—æ˜ å°„è¡¨)
4. [æ–°äºº Onboardingï¼šè¿™äº›åº“åƒä¸‡åˆ«ä¹±ç”¨](#å››-æ–°äºº-onboardingè¿™äº›åº“åƒä¸‡åˆ«ä¹±ç”¨)

---

## ä¸€ã€åº“æ€»ä½“ç›˜ç‚¹

### åº”ç”¨å±‚å®é™…æ¶‰åŠçš„åº“

**åº”ç”¨å±‚å®é™…æ¶‰åŠçš„åº“ â‰ˆ 12 ä¸ªå·¦å³**ï¼Œæ•°é‡éå¸¸å…‹åˆ¶ï¼Œè¿™æ˜¯å¥½äº‹ã€‚

å¯ä»¥æ¸…æ™°åˆ†ä¸º **7 å¤§ç±»**ï¼š

| ç±»åˆ« | åº“å | æ•°é‡ | è¯´æ˜ |
|------|------|------|------|
| **C++ æ ‡å‡†åº“** | libstdc++ | 1 | å®¹å™¨ã€RAIIã€çº¿ç¨‹æŠ½è±¡ |
| **çº¿ç¨‹ / åŒæ­¥** | std::thread / pthread | 1 | çº¿ç¨‹æŠ½è±¡ï¼ˆåº”ç”¨å±‚åªæ¥è§¦ std::threadï¼‰ |
| **UI / äº¤äº’** | LVGL | 1 | UI æ¸²æŸ“ã€äº‹ä»¶å›è°ƒ |
| **ç½‘ç»œ** | libcurlã€libwebsockets | 2 | HTTPã€WebSocket |
| **å¤šåª’ä½“** | TPlayerã€ALSA | 2 | éŸ³è§†é¢‘æ’­æ”¾ã€éŸ³é¢‘è¾“å‡º |
| **æ•°æ®ä¸é…ç½®** | SQLite3ã€cJSON | 2 | æœ¬åœ°æ•°æ®ã€JSON è§£æ |
| **ç³»ç»Ÿå·¥å…·ç±»åº“** | syslogã€POSIXã€chrono | 3 | æ—¥å¿—ã€æ–‡ä»¶ç³»ç»Ÿã€æ—¶é—´ |
| **åˆè®¡** | | **12** | **æ•°é‡å…‹åˆ¶ï¼Œæˆç†Ÿå¯æ§** |

---

## äºŒã€é€åº“æ¸…å• + æœ€ä½³å®è·µ + é¿å‘æŒ‡å—

---

### 1ï¸âƒ£ C++ æ ‡å‡†åº“ï¼ˆlibstdc++ï¼‰

#### æ¶‰åŠç»„ä»¶

- `<string> <vector> <map> <queue>`
- `<thread> <mutex> <condition_variable>`
- `<atomic>`
- `<chrono>`

#### ç”¨é€”

- å®¹å™¨ï¼ˆstringã€vectorã€mapã€queueï¼‰
- RAII èµ„æºç®¡ç†
- çº¿ç¨‹æŠ½è±¡ï¼ˆstd::threadï¼‰
- åŒæ­¥åŸè¯­ï¼ˆmutexã€condition_variableï¼‰

#### æœ€ä½³å®è·µ

1. **åªä½¿ç”¨ C++11 å­é›†**
   - ä¸ä½¿ç”¨ C++14/17/20 ç‰¹æ€§
   - ä¿æŒä¸ F133 å·¥å…·é“¾å…¼å®¹

2. **æ˜ç¡® STL ä»…ç”¨äº**ï¼š
   - å®¹å™¨ï¼ˆæ•°æ®å­˜å‚¨ï¼‰
   - RAIIï¼ˆèµ„æºç®¡ç†ï¼‰
   - çº¿ç¨‹æŠ½è±¡ï¼ˆstd::threadï¼‰

3. **ä½¿ç”¨ `std::unique_lock` + `condition_variable`**
   ```cpp
   std::unique_lock<std::mutex> lock(mtx_);
   cv_.wait(lock, [this]() {
       return !queue_.empty() || !running_.load();
   });
   ```

#### é¿å‘æŒ‡å—

- ğŸš« **ç¦æ­¢ä½¿ç”¨å¼‚å¸¸åšä¸šåŠ¡æµç¨‹**
  ```cpp
  // âŒ é”™è¯¯ï¼šç”¨å¼‚å¸¸åšä¸šåŠ¡æµç¨‹
  try {
      result = process();
  } catch (const Exception& e) {
      // é”™è¯¯ï¼å¼‚å¸¸åªç”¨äºå¼‚å¸¸æƒ…å†µ
  }
  ```

- ğŸš« **ç¦æ­¢ `std::async`**
  ```cpp
  // âŒ é”™è¯¯ï¼šä½¿ç”¨ std::async
  auto future = std::async(std::launch::async, []() {
      // é”™è¯¯ï¼ä½¿ç”¨å·²æœ‰çš„å·¥ä½œçº¿ç¨‹
  });
  ```

- ğŸš« **ç¦æ­¢è¿‡åº¦æ¨¡æ¿ / meta ç¼–ç¨‹**
  ```cpp
  // âŒ é”™è¯¯ï¼šè¿‡åº¦æ¨¡æ¿
  template<typename T, typename U, typename V>
  auto complex_template(T t, U u, V v) { ... }
  ```

- ğŸš« **ä¸ä¾èµ– STL çš„ allocator è¡Œä¸º**
  - ä½¿ç”¨é»˜è®¤ allocator
  - ä¸è‡ªå®šä¹‰ allocator

---

### 2ï¸âƒ£ çº¿ç¨‹åº“ï¼ˆstd::thread / pthreadï¼‰

#### æ¶‰åŠç»„ä»¶

- `std::thread`
- `std::mutex`
- `std::condition_variable`
- åº•å±‚ `pthread`ï¼ˆåº”ç”¨å±‚ä¸ç›´æ¥æ¥è§¦ï¼‰

#### ç”¨é€”

- çº¿ç¨‹åˆ›å»ºå’Œç®¡ç†
- çº¿ç¨‹åŒæ­¥ï¼ˆmutexã€condition_variableï¼‰
- çº¿ç¨‹é—´é€šä¿¡

#### æœ€ä½³å®è·µ

1. **åº”ç”¨å±‚åªæ¥è§¦ std::thread å°è£…**
   - ç¦æ­¢ç›´æ¥ä½¿ç”¨ `pthread_create`
   - é€šè¿‡ `std::thread` å°è£…

2. **çº¿ç¨‹å¸¸é©»ï¼Œä»»åŠ¡é©±åŠ¨**
   - çº¿ç¨‹ä¸é¢‘ç¹åˆ›å»º/é”€æ¯
   - é€šè¿‡ä»»åŠ¡é˜Ÿåˆ—é©±åŠ¨

3. **Singleton çº¿ç¨‹å®¿ä¸»**
   - çº¿ç¨‹å®¿ä¸»å¯¹è±¡æ˜¯ Singleton
   - ç”Ÿå‘½å‘¨æœŸä¸ App ä¸€è‡´

4. **æ˜¾å¼ `start / stop / join`**
   ```cpp
   void start() {
       worker_ = std::thread(&Worker::threadLoop, this);
   }
   
   void stop() {
       running_.store(false);
       cv_.notify_all();
       if (worker_.joinable()) {
           worker_.join();
       }
   }
   ```

#### é¿å‘æŒ‡å—

- ğŸš« **ç¦æ­¢ `detach`**
  ```cpp
  // âŒ é”™è¯¯ï¼šä½¿ç”¨ detach
  worker_.detach();  // é”™è¯¯ï¼ä¸å¯æ§
  ```

- ğŸš« **ç¦æ­¢ä¸šåŠ¡å±‚ç›´æ¥ pthread**
  ```cpp
  // âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ pthread
  pthread_create(&thread, NULL, func, NULL);  // é”™è¯¯ï¼
  ```

- ğŸš« **ç¦æ­¢çº¿ç¨‹æ„é€ å³å¯åŠ¨**
  ```cpp
  // âŒ é”™è¯¯ï¼šæ„é€ å‡½æ•°ä¸­å¯åŠ¨çº¿ç¨‹
  Worker() {
      worker_ = std::thread(&Worker::threadLoop, this);  // é”™è¯¯ï¼
  }
  ```

- ğŸš« **ç¦æ­¢ busy-loop + sleep**
  ```cpp
  // âŒ é”™è¯¯ï¼šbusy-loop
  while (running_) {
      doWork();
      usleep(1000);  // é”™è¯¯ï¼åº”è¯¥ç”¨ condition_variable
  }
  ```

---

### 3ï¸âƒ£ LVGLï¼ˆUI æ ¸å¿ƒåº“ï¼‰

#### ç”¨é€”

- UI æ¸²æŸ“
- äº‹ä»¶å›è°ƒ
- ç»„ä»¶ç®¡ç†

#### æœ€ä½³å®è·µï¼ˆå¿…é¡»å†™è¿›æ–‡æ¡£ï¼‰

1. **LVGL åªå…è®¸åœ¨ UI çº¿ç¨‹è°ƒç”¨**
   - æ‰€æœ‰ `lv_*` å‡½æ•°åªèƒ½åœ¨ UI çº¿ç¨‹è°ƒç”¨
   - å…¶ä»–çº¿ç¨‹é€šè¿‡ Event / Message é€šçŸ¥ UI çº¿ç¨‹

2. **UI æ›´æ–°é€šè¿‡ Event / Message**
   ```cpp
   // âœ… æ­£ç¡®ï¼šé€šè¿‡ Event æ›´æ–° UI
   void NetworkWorker::onResponseReceived(const Response& resp) {
       EventBus::getInstance().publish(Event{
           EventType::UPDATE_LABEL,
           resp.text
       });
   }
   ```

3. **Presenter ä¸ç›´æ¥æ“ä½œ lv_obj**
   - Presenter åªè´Ÿè´£ä¸šåŠ¡é€»è¾‘
   - UI æ“ä½œç”± UI å±‚è´Ÿè´£

4. **LVGL å›è°ƒåªåšè½»é€»è¾‘**
   ```cpp
   // âœ… æ­£ç¡®ï¼šå›è°ƒåªåšè½»é€»è¾‘
   void onButtonClick(lv_event_t* e) {
       // åªå‘é€äº‹ä»¶ï¼Œä¸åšé‡é€»è¾‘
       EventBus::getInstance().publish(Event{
           EventType::BUTTON_CLICK,
           button_id
       });
   }
   ```

5. **å®šæ—¶è°ƒç”¨ `lv_timer_handler`**
   ```cpp
   // UI ä¸»å¾ªç¯
   while (running_) {
       lv_timer_handler();  // å¿…é¡»å®šæœŸè°ƒç”¨
       usleep(5000);
   }
   ```

#### é¿å‘æŒ‡å—

- ğŸš« **ç¦æ­¢è·¨çº¿ç¨‹è®¿é—® lv_obj**
  ```cpp
  // âŒ é”™è¯¯ï¼šè·¨çº¿ç¨‹è®¿é—® lv_obj
  void NetworkWorker::updateUI() {
      lv_label_set_text(ui_label, "Updated");  // é”™è¯¯ï¼è·¨çº¿ç¨‹
  }
  ```

- ğŸš« **ç¦æ­¢åœ¨ UI å›è°ƒä¸­åš IO / ç½‘ç»œ**
  ```cpp
  // âŒ é”™è¯¯ï¼šå›è°ƒä¸­åš IO
  void onButtonClick(lv_event_t* e) {
      HttpService::get(url);  // é”™è¯¯ï¼é˜»å¡æ“ä½œ
  }
  ```

- ğŸš« **ç¦æ­¢åŠ¨æ€é¢‘ç¹åˆ›å»º/é”€æ¯ obj**
  ```cpp
  // âŒ é”™è¯¯ï¼šé¢‘ç¹åˆ›å»º/é”€æ¯
  void updateList() {
      lv_obj_del(old_obj);  // é”™è¯¯ï¼åº”è¯¥å¤ç”¨
      lv_obj_create(...);   // é”™è¯¯ï¼åº”è¯¥å¤ç”¨
  }
  ```

- ğŸš« **ç¦æ­¢åœ¨ UI çº¿ç¨‹ sleep**
  ```cpp
  // âŒ é”™è¯¯ï¼šUI çº¿ç¨‹ sleep
  void onButtonClick(lv_event_t* e) {
      std::this_thread::sleep_for(std::chrono::seconds(1));  // é”™è¯¯ï¼
  }
  ```

---

### 4ï¸âƒ£ libcurlï¼ˆHTTP / ç½‘ç»œï¼‰

#### ç”¨é€”

- REST API
- ä¸‹è½½
- å¿ƒè·³

#### æœ€ä½³å®è·µ

1. **`curl_global_init` åªè°ƒç”¨ä¸€æ¬¡**
   ```cpp
   // åœ¨ NetworkWorker::onThreadStart() ä¸­åˆå§‹åŒ–
   void NetworkWorker::onThreadStart() {
       curl_global_init(CURL_GLOBAL_ALL);  // åªè°ƒç”¨ä¸€æ¬¡
   }
   ```

2. **æ‰€æœ‰è¯·æ±‚åªåœ¨ Network Thread**
   - ç¦æ­¢åœ¨ UI çº¿ç¨‹è°ƒç”¨ libcurl
   - æ‰€æœ‰ HTTP è¯·æ±‚åœ¨ NetworkWorker ä¸­æ‰§è¡Œ

3. **æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ CURL handle**
   ```cpp
   void performHttpRequest(const std::string& url) {
       CURL* curl = curl_easy_init();  // æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ handle
       curl_easy_setopt(curl, CURLOPT_URL, url.c_str());
       curl_easy_perform(curl);
       curl_easy_cleanup(curl);
   }
   ```

4. **æ˜¾å¼è®¾ç½® timeoutã€retryã€fail-fast**
   ```cpp
   curl_easy_setopt(curl, CURLOPT_TIMEOUT, 10L);  // 10 ç§’è¶…æ—¶
   curl_easy_setopt(curl, CURLOPT_CONNECTTIMEOUT, 5L);  // 5 ç§’è¿æ¥è¶…æ—¶
   ```

#### é¿å‘æŒ‡å—

- ğŸš« **ç¦æ­¢è·¨çº¿ç¨‹å¤ç”¨ CURL***
  ```cpp
  // âŒ é”™è¯¯ï¼šè·¨çº¿ç¨‹å¤ç”¨
  static CURL* g_curl = curl_easy_init();  // é”™è¯¯ï¼çº¿ç¨‹ä¸å®‰å…¨
  ```

- ğŸš« **ç¦æ­¢ UI çº¿ç¨‹ç›´æ¥å‘è¯·æ±‚**
  ```cpp
  // âŒ é”™è¯¯ï¼šUI çº¿ç¨‹å‘è¯·æ±‚
  void onButtonClick() {
      curl_easy_perform(curl);  // é”™è¯¯ï¼é˜»å¡ UI
  }
  ```

- ğŸš« **ç¦æ­¢æ—  timeout**
  ```cpp
  // âŒ é”™è¯¯ï¼šæ—  timeout
  curl_easy_setopt(curl, CURLOPT_URL, url.c_str());
   // ç¼ºå°‘ timeout è®¾ç½®
  ```

- ğŸš« **ç¦æ­¢é˜»å¡ä¸»çº¿ç¨‹**
  ```cpp
  // âŒ é”™è¯¯ï¼šé˜»å¡ä¸»çº¿ç¨‹
   curl_easy_perform(curl);  // å¿…é¡»åœ¨å·¥ä½œçº¿ç¨‹ä¸­æ‰§è¡Œ
  ```

---

### 5ï¸âƒ£ WebSocketï¼ˆlibwebsocketsï¼‰

#### ç”¨é€”

- å®æ—¶çŠ¶æ€
- ç‚¹æ­Œæ§åˆ¶
- æœåŠ¡ç«¯æ¨é€

#### æœ€ä½³å®è·µ

1. **WebSocket è¿è¡Œåœ¨ Network Thread**
   - ä¸ UI è§£è€¦
   - é€šè¿‡ Event é€šçŸ¥ UI

2. **è‡ªåŠ¨é‡è¿æœ‰é€€é¿ç­–ç•¥**
   ```cpp
   void reconnect() {
       int delay = 1000 * (1 << retry_count);  // æŒ‡æ•°é€€é¿
       std::this_thread::sleep_for(std::chrono::milliseconds(delay));
       connect();
   }
   ```

3. **é€šè¿‡ Event é€šçŸ¥ UI**
   ```cpp
   void onMessageReceived(const std::string& msg) {
       EventBus::getInstance().publish(Event{
           EventType::WEBSOCKET_MESSAGE,
           msg
       });
   }
   ```

#### é¿å‘æŒ‡å—

- ğŸš« **ç¦æ­¢ UI çº¿ç¨‹ç»´æŠ¤è¿æ¥**
  ```cpp
  // âŒ é”™è¯¯ï¼šUI çº¿ç¨‹ç»´æŠ¤è¿æ¥
  void UISystem::initWebSocket() {
      websocket_connect();  // é”™è¯¯ï¼åº”è¯¥åœ¨ Network Thread
  }
  ```

- ğŸš« **ç¦æ­¢æ— é™é‡è¿**
  ```cpp
  // âŒ é”™è¯¯ï¼šæ— é™é‡è¿
   while (true) {
       connect();  // é”™è¯¯ï¼åº”è¯¥æœ‰æœ€å¤§é‡è¯•æ¬¡æ•°
   }
  ```

- ğŸš« **ç¦æ­¢åœ¨å›è°ƒä¸­åšé‡é€»è¾‘**
  ```cpp
  // âŒ é”™è¯¯ï¼šå›è°ƒä¸­åšé‡é€»è¾‘
  void onMessage(const std::string& msg) {
      processComplexLogic(msg);  // é”™è¯¯ï¼åº”è¯¥æŠ•é€’åˆ°å·¥ä½œçº¿ç¨‹
  }
  ```

---

### 6ï¸âƒ£ TPlayerï¼ˆå¤šåª’ä½“æ’­æ”¾ï¼‰

#### ç”¨é€”

- éŸ³è§†é¢‘æ’­æ”¾
- KTV æ ¸å¿ƒèƒ½åŠ›

#### æœ€ä½³å®è·µ

1. **Singleton Player Service**
   ```cpp
   class PlayerAdapter {
   public:
       static PlayerAdapter& instance() {
           static PlayerAdapter inst;
           return inst;
       }
   };
   ```

2. **ç‹¬ç«‹ Player Thread**
   - æ‰€æœ‰ TPlayer è°ƒç”¨åœ¨ Player Thread ä¸­æ‰§è¡Œ
   - ç¦æ­¢è·¨çº¿ç¨‹è°ƒç”¨

3. **ä¸¥æ ¼çŠ¶æ€æœºï¼ˆIdle / Preparing / Playing / Errorï¼‰**
   ```cpp
   enum class PlayerState {
       IDLE,
       PREPARING,
       PLAYING,
       PAUSED,
       ERROR
   };
   ```

4. **æ‰€æœ‰è°ƒç”¨ä¸²è¡ŒåŒ–**
   ```cpp
   void play(const std::string& url) {
       PlayerCmd cmd{PlayerCmdType::PLAY, url};
       cmd_queue_.enqueue(cmd);  // ä¸²è¡ŒåŒ–æ‰§è¡Œ
   }
   ```

#### é¿å‘æŒ‡å—

- ğŸš« **ç¦æ­¢å¤šå®ä¾‹ tplayer**
  ```cpp
  // âŒ é”™è¯¯ï¼šå¤šå®ä¾‹
  TPlayer* player1 = new TPlayer();
   TPlayer* player2 = new TPlayer();  // é”™è¯¯ï¼åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹
  ```

- ğŸš« **ç¦æ­¢å¹¶å‘è°ƒç”¨æ§åˆ¶æ¥å£**
  ```cpp
  // âŒ é”™è¯¯ï¼šå¹¶å‘è°ƒç”¨
   thread1: tplayer_play(url1);
   thread2: tplayer_play(url2);  // é”™è¯¯ï¼å¿…é¡»ä¸²è¡ŒåŒ–
  ```

- ğŸš« **ç¦æ­¢ UI çº¿ç¨‹ç›´æ¥è°ƒç”¨ tplayer**
  ```cpp
  // âŒ é”™è¯¯ï¼šUI çº¿ç¨‹ç›´æ¥è°ƒç”¨
  void onButtonClick() {
      tplayer_play(url);  // é”™è¯¯ï¼åº”è¯¥é€šè¿‡ PlayerAdapter
  }
  ```

- ğŸš« **ç¦æ­¢å¿½ç•¥ error å›è°ƒ**
  ```cpp
  // âœ… æ­£ç¡®ï¼šå¤„ç† error å›è°ƒ
  void onPlayerError(int error_code) {
      syslog(LOG_ERR, "[ktv][player] Error: %d", error_code);
      // ä¸ŠæŠ¥å¼‚å¸¸
      AppRuntime::instance().reportException(
          ExceptionType::PLAYER_HANG,
          error_code,
          "Player error"
      );
  }
  ```

---

### 7ï¸âƒ£ ALSA / éŸ³é¢‘æ¥å£

#### ç”¨é€”

- éŸ³é¢‘è¾“å‡º
- éŸ³é‡æ§åˆ¶

#### æœ€ä½³å®è·µ

1. **ç»Ÿä¸€ Audio Manager å°è£…**
   ```cpp
   class AudioManager {
   public:
       static AudioManager& instance() {
           static AudioManager inst;
           return inst;
       }
       
       void setVolume(int volume);
       void mute(bool mute);
   };
   ```

2. **éŸ³é‡ / mute çŠ¶æ€é›†ä¸­ç®¡ç†**
   - æ‰€æœ‰éŸ³é‡æ“ä½œé€šè¿‡ AudioManager
   - çŠ¶æ€ç»Ÿä¸€ç®¡ç†

3. **ä¸ Player è§£è€¦**
   - AudioManager ç‹¬ç«‹äº PlayerAdapter
   - Player åªè´Ÿè´£æ’­æ”¾ï¼Œä¸è´Ÿè´£éŸ³é‡æ§åˆ¶

#### é¿å‘æŒ‡å—

- ğŸš« **ç¦æ­¢å¤šçº¿ç¨‹åŒæ—¶æ“ä½œéŸ³é¢‘è®¾å¤‡**
  ```cpp
  // âŒ é”™è¯¯ï¼šå¤šçº¿ç¨‹æ“ä½œ
   thread1: setVolume(50);
   thread2: setVolume(80);  // é”™è¯¯ï¼å¿…é¡»ä¸²è¡ŒåŒ–
  ```

- ğŸš« **ç¦æ­¢é¢‘ç¹ open / close**
  ```cpp
  // âŒ é”™è¯¯ï¼šé¢‘ç¹ open/close
   void playSound() {
       snd_pcm_open(...);  // é”™è¯¯ï¼åº”è¯¥ä¿æŒæ‰“å¼€
       snd_pcm_write(...);
       snd_pcm_close(...);
   }
  ```

- ğŸš« **ç¦æ­¢ç¡¬ç¼–ç éŸ³é¢‘å‚æ•°**
  ```cpp
  // âŒ é”™è¯¯ï¼šç¡¬ç¼–ç 
   snd_pcm_set_params(handle, SND_PCM_FORMAT_S16_LE, ...);  // åº”è¯¥ä»é…ç½®è¯»å–
  ```

---

### 8ï¸âƒ£ SQLite3ï¼ˆæœ¬åœ°æ•°æ®ï¼‰

#### ç”¨é€”

- ç‚¹æ­Œè®°å½•
- ç¼“å­˜
- é…ç½®æŒä¹…åŒ–

#### æœ€ä½³å®è·µ

1. **å•çº¿ç¨‹è®¿é—®ï¼ˆæˆ–ä¸“ç”¨ DB Threadï¼‰**
   ```cpp
   class HistoryService {
   private:
       std::thread db_thread_;  // ä¸“ç”¨ DB çº¿ç¨‹
       void dbThreadLoop() {
           // æ‰€æœ‰ SQLite æ“ä½œåœ¨è¿™ä¸ªçº¿ç¨‹ä¸­
       }
   };
   ```

2. **WAL æ¨¡å¼**
   ```sql
   PRAGMA journal_mode=WAL;
   ```

3. **æ‰€æœ‰ SQL é¢„ç¼–è¯‘**
   ```cpp
   sqlite3_prepare_v2(db, "SELECT * FROM history WHERE id = ?", -1, &stmt, NULL);
   sqlite3_bind_int(stmt, 1, id);
   sqlite3_step(stmt);
   ```

#### é¿å‘æŒ‡å—

- ğŸš« **ç¦æ­¢å¤šçº¿ç¨‹ç›´æ¥è®¿é—®åŒä¸€ DB**
  ```cpp
  // âŒ é”™è¯¯ï¼šå¤šçº¿ç¨‹è®¿é—®
   thread1: sqlite3_exec(db, "INSERT ...", ...);
   thread2: sqlite3_exec(db, "SELECT ...", ...);  // é”™è¯¯ï¼å¿…é¡»å•çº¿ç¨‹
  ```

- ğŸš« **ç¦æ­¢ UI çº¿ç¨‹æ“ä½œæ•°æ®åº“**
  ```cpp
  // âŒ é”™è¯¯ï¼šUI çº¿ç¨‹æ“ä½œæ•°æ®åº“
  void onButtonClick() {
      sqlite3_exec(db, "SELECT ...", ...);  // é”™è¯¯ï¼é˜»å¡ UI
  }
  ```

- ğŸš« **ç¦æ­¢é•¿äº‹åŠ¡**
  ```cpp
  // âŒ é”™è¯¯ï¼šé•¿äº‹åŠ¡
   sqlite3_exec(db, "BEGIN", ...);
   // ... é•¿æ—¶é—´æ“ä½œ ...
   sqlite3_exec(db, "COMMIT", ...);  // é”™è¯¯ï¼äº‹åŠ¡åº”è¯¥å°½å¯èƒ½çŸ­
  ```

- ğŸš« **ç¦æ­¢åŠ¨æ€æ‹¼ SQL**
  ```cpp
  // âŒ é”™è¯¯ï¼šåŠ¨æ€æ‹¼ SQL
   std::string sql = "SELECT * FROM history WHERE id = " + std::to_string(id);  // é”™è¯¯ï¼SQL æ³¨å…¥é£é™©
  ```

---

### 9ï¸âƒ£ cJSONï¼ˆJSON è§£æï¼‰

#### ç”¨é€”

- åè®®è§£æ
- é…ç½®æ–‡ä»¶

#### æœ€ä½³å®è·µ

1. **JSON åªåšæ•°æ®è½½ä½“**
   - è§£æåç«‹å³è½¬æ¢ä¸º struct
   - ä¸åœ¨ä¸šåŠ¡å±‚ä¼ é€’ JSON å­—ç¬¦ä¸²

2. **è§£æä¸ä¸šåŠ¡è§£è€¦**
   ```cpp
   // âœ… æ­£ç¡®ï¼šè§£æä¸ä¸šåŠ¡è§£è€¦
   SongList parseSongList(const std::string& json_str) {
       cJSON* root = cJSON_Parse(json_str.c_str());
       SongList list;
       // è§£æå¹¶è½¬æ¢ä¸º struct
       cJSON_Delete(root);
       return list;
   }
   ```

3. **æ ¡éªŒå­—æ®µå®Œæ•´æ€§**
   ```cpp
   if (!cJSON_HasObjectItem(root, "songs")) {
       syslog(LOG_ERR, "[ktv][json] Missing 'songs' field");
       return false;
   }
   ```

#### é¿å‘æŒ‡å—

- ğŸš« **ç¦æ­¢ UI çº¿ç¨‹åš JSON è§£æ**
  ```cpp
  // âŒ é”™è¯¯ï¼šUI çº¿ç¨‹è§£æ JSON
  void onButtonClick() {
      cJSON_Parse(json_str);  // é”™è¯¯ï¼é˜»å¡ UI
  }
  ```

- ğŸš« **ç¦æ­¢ä¿¡ä»»å¤–éƒ¨ JSON**
  ```cpp
  // âŒ é”™è¯¯ï¼šä¿¡ä»»å¤–éƒ¨ JSON
   cJSON* root = cJSON_Parse(external_json);
   // æ²¡æœ‰æ ¡éªŒå­—æ®µå®Œæ•´æ€§
  ```

- ğŸš« **ç¦æ­¢åœ¨çƒ­è·¯å¾„åå¤ parse**
  ```cpp
  // âŒ é”™è¯¯ï¼šçƒ­è·¯å¾„åå¤ parse
   while (running_) {
       cJSON_Parse(json_str);  // é”™è¯¯ï¼åº”è¯¥ç¼“å­˜è§£æç»“æœ
   }
  ```

---

### ğŸ”Ÿ æ–‡ä»¶ç³»ç»Ÿ APIï¼ˆPOSIXï¼‰

#### ç”¨é€”

- é…ç½®
- æ—¥å¿—
- ç¼“å­˜

#### æœ€ä½³å®è·µ

1. **æ‰€æœ‰è·¯å¾„é›†ä¸­ç®¡ç†**
   ```cpp
   class PathManager {
   public:
       static const char* CONFIG_PATH = "/opt/app/config/config.ini";
       static const char* LOG_PATH = "/var/log/ktvlv.log";
       static const char* CACHE_PATH = "/tmp/ktvlv_cache";
   };
   ```

2. **IO æ“ä½œæ”¾åœ¨ Worker Thread**
   - æ‰€æœ‰æ–‡ä»¶ IO åœ¨ NetworkWorker æˆ–ä¸“ç”¨ IO çº¿ç¨‹ä¸­æ‰§è¡Œ
   - ç¦æ­¢åœ¨ UI çº¿ç¨‹åšæ–‡ä»¶ IO

3. **å†™æ“ä½œå¯é™çº§**
   ```cpp
   int writeConfig(const std::string& content) {
       int ret = writeToFile(CONFIG_PATH, content);
       if (ret != 0) {
           // é™çº§ï¼šå†™å…¥ä¸´æ—¶æ–‡ä»¶
           writeToFile("/tmp/config_backup.ini", content);
       }
       return ret;
   }
   ```

#### é¿å‘æŒ‡å—

- ğŸš« **ç¦æ­¢ UI çº¿ç¨‹åšæ–‡ä»¶ IO**
  ```cpp
  // âŒ é”™è¯¯ï¼šUI çº¿ç¨‹åšæ–‡ä»¶ IO
  void onButtonClick() {
      FILE* f = fopen("/opt/app/config.ini", "r");  // é”™è¯¯ï¼é˜»å¡ UI
  }
  ```

- ğŸš« **ç¦æ­¢å‡è®¾ç£ç›˜æ°¸è¿œå¯å†™**
  ```cpp
  // âŒ é”™è¯¯ï¼šå‡è®¾ç£ç›˜å¯å†™
   FILE* f = fopen(path, "w");
   fwrite(data, 1, size, f);  // æ²¡æœ‰æ£€æŸ¥è¿”å›å€¼
  ```

- ğŸš« **ç¦æ­¢é¢‘ç¹ sync**
  ```cpp
  // âŒ é”™è¯¯ï¼šé¢‘ç¹ sync
   while (running_) {
       fsync(fd);  // é”™è¯¯ï¼åº”è¯¥æ‰¹é‡å†™å…¥å sync
   }
  ```

---

### 1ï¸âƒ£1ï¸âƒ£ æ—¥å¿—åº“ï¼ˆsyslogï¼‰

#### ç”¨é€”

- è°ƒè¯•
- è¿ç»´
- æ’éšœ

#### æœ€ä½³å®è·µ

1. **æ—¥å¿—åˆ†çº§**
   ```cpp
   syslog(LOG_ERR, "[ktv][module] Error message");   // ERROR
   syslog(LOG_WARNING, "[ktv][module] Warning message");  // WARN
   syslog(LOG_INFO, "[ktv][module] Info message");    // INFO
   ```

2. **æ”¯æŒå¼‚æ­¥**
   - syslog æœ¬èº«æ˜¯å¼‚æ­¥çš„
   - ä¸é˜»å¡è°ƒç”¨çº¿ç¨‹

3. **å…³é”®è·¯å¾„æ—¥å¿—æœ€å°åŒ–**
   - ç¦æ­¢åœ¨é«˜é¢‘å¾ªç¯ä¸­æ‰“å° ERROR/WARN
   - ä½¿ç”¨è®¡æ•° + å®šæœŸä¸ŠæŠ¥

#### é¿å‘æŒ‡å—

- ğŸš« **ç¦æ­¢é«˜é¢‘å¾ªç¯æ‰“ ERROR**
  ```cpp
  // âŒ é”™è¯¯ï¼šé«˜é¢‘å¾ªç¯æ‰“ ERROR
   while (running_) {
       if (checkError()) {
           syslog(LOG_ERR, "[ktv] Error");  // é”™è¯¯ï¼
       }
   }
  ```

- ğŸš« **ç¦æ­¢ UI çº¿ç¨‹å¤§é‡æ—¥å¿—**
  ```cpp
  // âŒ é”™è¯¯ï¼šUI çº¿ç¨‹å¤§é‡æ—¥å¿—
   void onButtonClick() {
       syslog(LOG_INFO, "[ktv] Button clicked");  // å¯ä»¥ï¼Œä½†ä¸è¦å¤ªå¤š
   }
  ```

- ğŸš« **ç¦æ­¢ printf æ»¡å¤©é£**
  ```cpp
  // âŒ é”™è¯¯ï¼šä½¿ç”¨ printf
   printf("Debug: %s\n", msg);  // é”™è¯¯ï¼åº”è¯¥ç”¨ syslog
  ```

---

### 1ï¸âƒ£2ï¸âƒ£ å®šæ—¶ / æ—¶é—´åº“ï¼ˆchrono / timerfdï¼‰

#### ç”¨é€”

- å¿ƒè·³
- è¶…æ—¶
- ä»»åŠ¡è°ƒåº¦

#### æœ€ä½³å®è·µ

1. **ä½¿ç”¨ monotonic clock**
   ```cpp
   #include <time.h>
   struct timespec ts;
   clock_gettime(CLOCK_MONOTONIC, &ts);  // ä½¿ç”¨ monotonic clock
   ```

2. **å®šæ—¶é€»è¾‘é›†ä¸­ç®¡ç†**
   ```cpp
   class TimerManager {
   public:
       void scheduleTask(int delay_ms, std::function<void()> task);
   };
   ```

#### é¿å‘æŒ‡å—

- ğŸš« **ç¦æ­¢ç”¨ wall clock åšä¸šåŠ¡åˆ¤æ–­**
  ```cpp
  // âŒ é”™è¯¯ï¼šä½¿ç”¨ wall clock
   time_t now = time(nullptr);  // é”™è¯¯ï¼å—ç³»ç»Ÿæ—¶é—´è°ƒæ•´å½±å“
  ```

- ğŸš« **ç¦æ­¢ sleep é©±åŠ¨é€»è¾‘**
  ```cpp
  // âŒ é”™è¯¯ï¼šsleep é©±åŠ¨é€»è¾‘
   while (running_) {
       doWork();
       sleep(1);  // é”™è¯¯ï¼åº”è¯¥ç”¨ condition_variable
   }
  ```

---

## ä¸‰ã€åº“ â†’ çº¿ç¨‹ â†’ æ¨¡å—æ˜ å°„è¡¨

| åº“å | å…è®¸ä½¿ç”¨çš„çº¿ç¨‹ | ç¦æ­¢ä½¿ç”¨çš„çº¿ç¨‹ | å°è£…æ¨¡å— |
|------|--------------|--------------|---------|
| **std::thread** | æ‰€æœ‰çº¿ç¨‹ | - | ThreadBaseã€WorkerThread |
| **LVGL** | UI ä¸»çº¿ç¨‹ | æ‰€æœ‰å…¶ä»–çº¿ç¨‹ | UISystem |
| **libcurl** | NetworkWorker | UI çº¿ç¨‹ã€Player çº¿ç¨‹ | HttpService |
| **libwebsockets** | NetworkWorker | UI çº¿ç¨‹ã€Player çº¿ç¨‹ | WebSocketService |
| **TPlayer** | PlayerAdapter | UI çº¿ç¨‹ã€Network çº¿ç¨‹ | PlayerAdapter |
| **ALSA** | PlayerAdapter | UI çº¿ç¨‹ã€Network çº¿ç¨‹ | AudioManager |
| **SQLite3** | HistoryServiceï¼ˆä¸“ç”¨ DB çº¿ç¨‹ï¼‰ | UI çº¿ç¨‹ã€å…¶ä»–çº¿ç¨‹ | HistoryService |
| **cJSON** | NetworkWorker | UI çº¿ç¨‹ã€Player çº¿ç¨‹ | JsonHelper |
| **POSIX æ–‡ä»¶ IO** | NetworkWorkerã€ä¸“ç”¨ IO çº¿ç¨‹ | UI çº¿ç¨‹ | FileService |
| **syslog** | æ‰€æœ‰çº¿ç¨‹ | - | ç›´æ¥ä½¿ç”¨ |
| **chrono / timerfd** | æ‰€æœ‰çº¿ç¨‹ | - | TimerManager |

---

## å››ã€æ–°äºº Onboardingï¼šè¿™äº›åº“åƒä¸‡åˆ«ä¹±ç”¨

### ğŸš« ç»å¯¹ç¦æ­¢ï¼ˆè¿åå³é©³å›ï¼‰

1. **è·¨çº¿ç¨‹ä½¿ç”¨ LVGL**
   - âŒ åœ¨ NetworkWorker ä¸­è°ƒç”¨ `lv_label_set_text()`
   - âœ… é€šè¿‡ Event é€šçŸ¥ UI çº¿ç¨‹æ›´æ–°

2. **UI çº¿ç¨‹åšç½‘ç»œè¯·æ±‚**
   - âŒ åœ¨ UI å›è°ƒä¸­è°ƒç”¨ `curl_easy_perform()`
   - âœ… æŠ•é€’åˆ° NetworkWorker

3. **UI çº¿ç¨‹æ“ä½œæ•°æ®åº“**
   - âŒ åœ¨ UI å›è°ƒä¸­è°ƒç”¨ `sqlite3_exec()`
   - âœ… é€šè¿‡ HistoryService å¼‚æ­¥æ“ä½œ

4. **UI çº¿ç¨‹è§£æ JSON**
   - âŒ åœ¨ UI å›è°ƒä¸­è°ƒç”¨ `cJSON_Parse()`
   - âœ… åœ¨ NetworkWorker ä¸­è§£æ

5. **UI çº¿ç¨‹åšæ–‡ä»¶ IO**
   - âŒ åœ¨ UI å›è°ƒä¸­è°ƒç”¨ `fopen()`
   - âœ… åœ¨ NetworkWorker ä¸­æ‰§è¡Œ

6. **å¤šçº¿ç¨‹å¹¶å‘è°ƒç”¨ TPlayer**
   - âŒ å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ `tplayer_play()`
   - âœ… é€šè¿‡ PlayerAdapter ä¸²è¡ŒåŒ–

7. **ä½¿ç”¨ detach**
   - âŒ `thread.detach()`
   - âœ… æ˜¾å¼ `join()`

8. **ä½¿ç”¨ wall clock åšä¸šåŠ¡åˆ¤æ–­**
   - âŒ `time(nullptr)`
   - âœ… `clock_gettime(CLOCK_MONOTONIC, &ts)`

---

### âš ï¸ å¸¸è§é”™è¯¯æ¨¡å¼

| é”™è¯¯æ¨¡å¼ | æ­£ç¡®åšæ³• |
|---------|---------|
| UI å›è°ƒä¸­åšé˜»å¡æ“ä½œ | æŠ•é€’åˆ°å·¥ä½œçº¿ç¨‹ |
| é«˜é¢‘å¾ªç¯ä¸­æ‰“å° ERROR | è®¡æ•° + å®šæœŸä¸ŠæŠ¥ |
| åŠ¨æ€æ‹¼ SQL | ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥ |
| ä¿¡ä»»å¤–éƒ¨ JSON | æ ¡éªŒå­—æ®µå®Œæ•´æ€§ |
| é¢‘ç¹åˆ›å»º/é”€æ¯ lv_obj | å¤ç”¨å¯¹è±¡æ±  |
| æ—  timeout çš„ç½‘ç»œè¯·æ±‚ | æ˜¾å¼è®¾ç½® timeout |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [KTV_Appçº¿ç¨‹Singletonç¼–ç è§„èŒƒï¼ˆæœ€ç»ˆç‰ˆï¼‰.md](./KTV_Appçº¿ç¨‹Singletonç¼–ç è§„èŒƒï¼ˆæœ€ç»ˆç‰ˆï¼‰.md) â­â­â­ **å¿…è¯»**
- [å·¥ç¨‹è§„èŒƒç¡¬è§„åˆ™ï¼ˆé‡äº§çº§ï¼‰.md](./å·¥ç¨‹è§„èŒƒç¡¬è§„åˆ™ï¼ˆé‡äº§çº§ï¼‰.md) â­â­â­ **å¿…è¯»**
- [ä»£ç å®¡æŸ¥Checklist.md](../ä»£ç å®¡æŸ¥Checklist.md) â­â­â­ **å¿…è¯»**

---

**æœ€åæ›´æ–°**: 2025-12-30  
**ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ  
**çŠ¶æ€**: âœ… æ ¸å¿ƒæ–‡æ¡£ï¼ˆå·¥ç¨‹è§„èŒƒ - é‡äº§çº§ï¼‰

