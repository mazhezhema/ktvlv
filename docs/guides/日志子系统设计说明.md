# æ—¥å¿—å­ç³»ç»Ÿè®¾è®¡è¯´æ˜ï¼ˆF133/Tina Linuxï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
> **æœ€åæ›´æ–°**ï¼š2025-12-30  
> **çŠ¶æ€**ï¼šâœ… æ ¸å¿ƒæ–‡æ¡£  
> **é€‚ç”¨å¹³å°**ï¼šF133 / Tina Linuxï¼ˆBusyBox ä½“ç³»ï¼‰

---

## ğŸ¯ ä¸€å¥è¯ç»“è®ºï¼ˆå…ˆæ‹æ¿ï¼‰

> **syslog æ˜¯ F133 ä¸Šæœ€ç¨³å¦¥ã€æœ€æˆç†Ÿã€æœ€ä½ç»´æŠ¤æˆæœ¬çš„æ—¥å¿—æ–¹æ¡ˆã€‚**
> **å‰ææ˜¯ï¼šä½ åªç”¨å®ƒåš"è®°å½•"ï¼Œä¸è®©å®ƒèƒŒä¸šåŠ¡è´£ä»»ï¼Œä¸Šä¼ é€»è¾‘å®Œå…¨è§£è€¦ã€‚**

---

## ğŸ“‹ ç›®å½•

1. [F133/Tina Linux é‡Œçš„ syslog å…¨é“¾è·¯](#ä¸€-f133tina-linux-é‡Œçš„-syslog-å…¨é“¾è·¯)
2. [syslog åœ¨ F133 ä¸Š"åˆ°åº•æ˜¯å•¥"](#äºŒ-syslog-åœ¨-f133-ä¸Šåˆ°åº•æ˜¯å•¥)
3. [logread æ˜¯ä»€ä¹ˆ](#ä¸‰-logread-æ˜¯ä»€ä¹ˆ)
4. [syslog / logread åœ¨ KTV é¡¹ç›®é‡Œçš„"æ­£ç¡®åˆ†å·¥"](#å››-syslog--logread-åœ¨-ktv-é¡¹ç›®é‡Œçš„æ­£ç¡®åˆ†å·¥)
5. [LogUploadService è®¾è®¡](#äº”-loguploadservice-è®¾è®¡)
6. [ä¸ºä»€ä¹ˆ syslog æœ¬èº«ç»ä¸èƒ½å•ç‹¬çº¿ç¨‹](#å…­-ä¸ºä»€ä¹ˆ-syslog-æœ¬èº«ç»ä¸èƒ½å•ç‹¬çº¿ç¨‹)
7. [F133/Tina ä¸‹ syslog çš„æœ€ä½³å®è·µ](#ä¸ƒ-f133tina-ä¸‹-syslog-çš„æœ€ä½³å®è·µ)
8. [å¿…é¡»æå‰è§„é¿çš„ 10 ä¸ªå‘](#å…«-å¿…é¡»æå‰è§„é¿çš„-10-ä¸ªå‘)
9. [æ—¥å¿—è§„èŒƒï¼ˆtag / çº§åˆ« / ç¤ºä¾‹ï¼‰](#ä¹-æ—¥å¿—è§„èŒƒtag--çº§åˆ«--ç¤ºä¾‹)

---

## ä¸€ã€F133/Tina Linux é‡Œçš„ syslog å…¨é“¾è·¯

åœ¨ F133ï¼ˆTina Linuxï¼ŒBusyBox ä½“ç³»ï¼‰é‡Œï¼Œ**æ—¥å¿—ä¸æ˜¯ä¸€ä¸ª APIï¼Œè€Œæ˜¯ä¸€æ¡æµæ°´çº¿**ï¼š

```
[ä½ çš„ KTV App]
   |
   | syslog() / openlog()
   v
[/dev/log]  (UNIX domain socket)
   |
   v
[syslogd]  (å®ˆæŠ¤è¿›ç¨‹)
   |
   | ring buffer / å¯é€‰è½ç›˜
   v
[logread]  (è¯»å–å·¥å…·)
   |
   v
[ä½ è‡ªå·±çš„ LogUploadService / shell]
```

è¿™æ¡é“¾è·¯æ˜¯**ç³»ç»Ÿçº§è®¾æ–½**ï¼Œä¸æ˜¯ä½ è‡ªå·±æ‹¼çš„ã€‚

---

## äºŒã€syslog åœ¨ F133 ä¸Š"åˆ°åº•æ˜¯å•¥"

### 1ï¸âƒ£ syslog = æ ‡å‡†æ—¥å¿— APIï¼ˆä½ å”¯ä¸€è¯¥ç”¨çš„å…¥å£ï¼‰

åœ¨ä»£ç é‡Œï¼š

```c
#include <syslog.h>

openlog("ktv", LOG_PID | LOG_NDELAY, LOG_USER);
syslog(LOG_INFO, "player start song_id=%s", id);
closelog();
```

**è¿™ä¸€æ­¥åšäº†ä»€ä¹ˆï¼Ÿ**

* æŠŠæ—¥å¿—å†™åˆ° `/dev/log`
* **ä¸æ˜¯æ–‡ä»¶**
* **ä¸æ˜¯ä½ è‡ªå·±ç®¡ç† buffer**

ğŸ‘‰ **è¿™æ˜¯å…³é”®ï¼šsyslog ä¸å…³å¿ƒå­˜å“ªï¼Œåªè´Ÿè´£"æŠ•é€’"**

---

### 2ï¸âƒ£ `/dev/log` æ˜¯ä»€ä¹ˆï¼ˆä¸è¦ç¢°ï¼‰

* UNIX Domain Socket
* syslogd åœ¨ç›‘å¬
* åè®®å¤æ‚
* BusyBox ç§æœ‰å®ç°

âŒ **ä¸¥ç¦**

* è‡ªå·± open/read `/dev/log`
* è‡ªå·±å®ç° syslog client

---

### 3ï¸âƒ£ syslogdï¼ˆF133 ä¸Šçš„æ ¸å¿ƒè§’è‰²ï¼‰

#### syslogd æ˜¯ä»€ä¹ˆï¼Ÿ

* BusyBox æä¾›çš„å®ˆæŠ¤è¿›ç¨‹
* ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨æ‹‰èµ·
* æ¥æ”¶æ‰€æœ‰ syslog()

#### syslogd é»˜è®¤è¡Œä¸ºï¼ˆTina å¸¸è§ï¼‰

* **å†…å­˜ ring buffer**
* å¯é…ç½®ï¼š
  * æ˜¯å¦è½ç›˜
  * buffer å¤§å°
  * è¿‡æ»¤çº§åˆ«

ğŸ‘‰ **é‡ç‚¹**ï¼š

> **syslogd å·²ç»æ˜¯"ç‹¬ç«‹è¿›ç¨‹ + ç¼“å†² + ä¸²è¡Œå†™"**

ä½ å†æä¸€å±‚çº¿ç¨‹ï¼Œæ˜¯**é‡å¤è®¾è®¡**ã€‚

---

## ä¸‰ã€logread æ˜¯ä»€ä¹ˆ

### logread çš„çœŸå®è§’è‰²

> **logread = syslogd çš„"å®˜æ–¹æŸ¥è¯¢æ¥å£"**

å®ƒåšçš„äº‹ï¼š

* ä» syslogd çš„ ring buffer è¯»æ—¥å¿—
* æ ¼å¼åŒ–è¾“å‡º
* ä¸è§£æ socket
* ä¸å…³å¿ƒä½ ä¸šåŠ¡

ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºï¼š

> **syslogd çš„åªè¯» APIï¼Œåªæ˜¯è¡¨ç°å½¢å¼æ˜¯ CLI**

---

### logread åœ¨ F133 ä¸Šçš„å¸¸è§å½¢æ€

åœ¨ Tina / BusyBox é‡Œï¼š

```sh
logread                    # è¯»å–å½“å‰æ—¥å¿—
logread -f                 # ç±»ä¼¼ tail -fï¼ˆæ…ç”¨ï¼‰
logread | grep "[ktv]"     # è¿‡æ»¤ä½ çš„æ—¥å¿—
```

ç‰¹ç‚¹ï¼š

* **ä¸ä¿è¯å†å²**
* é‡å¯å³ä¸¢
* ä¸é€‚åˆé•¿æœŸå­˜æ¡£

ğŸ‘‰ è¿™æ­£ç¬¦åˆ **åµŒå…¥å¼è®¾å¤‡çš„ç°å®çº¦æŸ**

---

## å››ã€syslog / logread åœ¨ KTV é¡¹ç›®é‡Œçš„"æ­£ç¡®åˆ†å·¥"

è¿™æ˜¯é‡ç‚¹ï¼Œç›´æ¥ç»™ä½ **å®šç¨¿çº§å»ºè®®**ã€‚

---

### 1ï¸âƒ£ KTV Appï¼ˆä½ çš„ä»£ç ï¼‰åº”è¯¥æ€ä¹ˆåšï¼Ÿ

#### âœ… åªåšä¸€ä»¶äº‹ï¼š**æ‰“ç‚¹æ—¥å¿—**

```c
#include <syslog.h>

// å¯åŠ¨æ—¶ä¸€æ¬¡å³å¯
openlog("ktv", LOG_PID | LOG_NDELAY, LOG_USER);

// ä½¿ç”¨æ—¥å¿—
syslog(LOG_INFO, "[ktv][player] start song=%s", id);
syslog(LOG_ERR,  "[ktv][net] request failed code=%d", err);
syslog(LOG_WARNING, "[ktv][ui] page switch timeout");
```

**è§„èŒƒå»ºè®®**

* ç»Ÿä¸€ tagï¼š`[ktv][module]`
* ä¸æ‰“å¤§å¯¹è±¡
* ä¸æ‹¼ JSON
* ä¸é«˜é¢‘

âŒ ä¸åšï¼š

* æ–‡ä»¶å†™
* ä¸Šä¼ 
* çº¿ç¨‹ç®¡ç†

---

### 2ï¸âƒ£ syslogdï¼ˆç³»ç»Ÿï¼‰åšä»€ä¹ˆï¼Ÿ

* æ¥æ”¶
* æ’é˜Ÿ
* ç¼“å†²
* è¿‡æ»¤

ğŸ‘‰ **ä½ ä¿¡å®ƒå°±è¡Œ**

---

### 3ï¸âƒ£ LogUploadServiceï¼ˆä½ è¦å†™çš„ï¼‰åšä»€ä¹ˆï¼Ÿ

è¿™æ˜¯ä½ å”¯ä¸€"ä»‹å…¥"çš„åœ°æ–¹ã€‚

#### æ¨èèŒè´£

* è§¦å‘å¼æ‹‰å–æ—¥å¿—
* è¿‡æ»¤ `[ktv]`
* åˆå¹¶
* ä½é¢‘ä¸Šä¼ 

#### æ¨èå®ç°æ–¹å¼

```cpp
// LogUploadService::collectLogs()
FILE* fp = popen("logread", "r");
if (!fp) {
    syslog(LOG_ERR, "[ktv][log] logread failed");
    return false;
}

std::vector<std::string> logs;
char line[1024];
while (fgets(line, sizeof(line), fp)) {
    if (strstr(line, "[ktv]")) {
        logs.push_back(line);
    }
}
pclose(fp);

// åˆå¹¶å¹¶ä¸Šä¼ 
return uploadLogs(logs);
```

---

## äº”ã€LogUploadService è®¾è®¡

### 1ï¸âƒ£ æ˜¯å¦è¦çº¿ç¨‹ï¼Ÿ

#### æ˜ç¡®ç­”æ¡ˆï¼š**è¦ï¼Œè€Œä¸”å¿…é¡»ä½ä¼˜å…ˆçº§**

åŸå› ï¼š

* HTTP / TLS é˜»å¡
* DNS ä¸å¯æ§
* ç½‘ç»œçŠ¶æ€ä¸å¯æ§

#### ä½†æ³¨æ„åŒºåˆ†ï¼š

| è¡Œä¸º | æ˜¯å¦çº¿ç¨‹ |
|------|---------|
| syslog() | âŒ ç›´æ¥è°ƒç”¨ï¼ˆåŒæ­¥ï¼‰ |
| logread | âœ”ï¼ˆæœåŠ¡çº¿ç¨‹ï¼‰ |
| ä¸Šä¼  | âœ”ï¼ˆæœåŠ¡çº¿ç¨‹ï¼‰ |

---

### 2ï¸âƒ£ LogUploadService çº¿ç¨‹æ¨¡å‹

```cpp
// log_upload_service.h
#pragma once
#include <thread>
#include <atomic>
#include <string>
#include <functional>

class LogUploadService {
public:
    static LogUploadService& instance();
    
    // è§¦å‘ä¸Šä¼ ï¼ˆéé˜»å¡ï¼‰
    void triggerUpload();
    
    // å¯åŠ¨/åœæ­¢æœåŠ¡çº¿ç¨‹
    void start();
    void shutdown();
    
    // è®¾ç½®ä¸Šä¼ å›è°ƒï¼ˆå¯é€‰ï¼‰
    void setUploadCallback(std::function<bool(const std::string&)> cb);
    
private:
    LogUploadService();
    ~LogUploadService();
    LogUploadService(const LogUploadService&) = delete;
    LogUploadService& operator=(const LogUploadService&) = delete;
    
    void threadLoop();                    // æœåŠ¡çº¿ç¨‹ä¸»å¾ªç¯
    bool collectLogs(std::string& out);  // æ”¶é›†æ—¥å¿—
    bool uploadLogs(const std::string& logs); // ä¸Šä¼ æ—¥å¿—
    
    std::thread worker_;
    std::atomic<bool> running_{false};
    std::atomic<bool> pending_{false};
    std::function<bool(const std::string&)> upload_cb_;
};
```

---

### 3ï¸âƒ£ LogUploadService çŠ¶æ€æœº

```
[IDLE]  â†â†’  [COLLECTING]  â†’  [UPLOADING]  â†’  [IDLE]
  â†‘                              â†“
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [ERROR] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è¯´æ˜**ï¼š

* **IDLE**ï¼šç©ºé—²ï¼Œç­‰å¾…è§¦å‘
* **COLLECTING**ï¼šæ‰§è¡Œ `logread`ï¼Œæ”¶é›†æ—¥å¿—
* **UPLOADING**ï¼šHTTP ä¸Šä¼ ä¸­
* **ERROR**ï¼šå¤±è´¥ï¼Œç­‰å¾…é‡è¯•æˆ–ä¸‹æ¬¡è§¦å‘

---

### 4ï¸âƒ£ LogUploadService å®ç°ç¤ºä¾‹

```cpp
// log_upload_service.cpp
#include "log_upload_service.h"
#include <syslog.h>
#include <cstdio>
#include <cstring>
#include <sstream>

LogUploadService& LogUploadService::instance() {
    static LogUploadService inst;
    return inst;
}

LogUploadService::LogUploadService() {
    openlog("ktv", LOG_PID, LOG_USER);
}

LogUploadService::~LogUploadService() {
    shutdown();
    closelog();
}

void LogUploadService::start() {
    if (running_.exchange(true)) return;
    worker_ = std::thread([this]{
        threadLoop();
    });
    syslog(LOG_INFO, "[ktv][log] LogUploadService started");
}

void LogUploadService::shutdown() {
    if (!running_.exchange(false)) return;
    pending_ = true;  // å”¤é†’ç­‰å¾…
    if (worker_.joinable()) {
        worker_.join();
    }
    syslog(LOG_INFO, "[ktv][log] LogUploadService stopped");
}

void LogUploadService::triggerUpload() {
    pending_ = true;
    syslog(LOG_INFO, "[ktv][log] upload triggered");
}

void LogUploadService::threadLoop() {
    while (running_) {
        // ç­‰å¾…è§¦å‘
        while (running_ && !pending_) {
            std::this_thread::sleep_for(std::chrono::seconds(1));
        }
        
        if (!running_) break;
        pending_ = false;
        
        // æ”¶é›†æ—¥å¿—
        std::string logs;
        if (!collectLogs(logs)) {
            syslog(LOG_ERR, "[ktv][log] collect logs failed");
            continue;
        }
        
        if (logs.empty()) {
            syslog(LOG_INFO, "[ktv][log] no logs to upload");
            continue;
        }
        
        // ä¸Šä¼ æ—¥å¿—
        if (!uploadLogs(logs)) {
            syslog(LOG_ERR, "[ktv][log] upload logs failed");
            // å¯ä»¥åœ¨è¿™é‡Œå®ç°é‡è¯•é€»è¾‘
        } else {
            syslog(LOG_INFO, "[ktv][log] upload logs success");
        }
        
        // ä¸Šä¼ å®Œæˆåï¼Œç­‰å¾…ä¸‹æ¬¡è§¦å‘ï¼ˆä¸ç«‹å³é‡è¯•ï¼‰
        std::this_thread::sleep_for(std::chrono::seconds(5));
    }
}

bool LogUploadService::collectLogs(std::string& out) {
    FILE* fp = popen("logread", "r");
    if (!fp) {
        return false;
    }
    
    std::ostringstream oss;
    char line[1024];
    while (fgets(line, sizeof(line), fp)) {
        if (strstr(line, "[ktv]")) {
            oss << line;
        }
    }
    
    int ret = pclose(fp);
    if (ret != 0) {
        return false;
    }
    
    out = oss.str();
    return true;
}

bool LogUploadService::uploadLogs(const std::string& logs) {
    if (upload_cb_) {
        return upload_cb_(logs);
    }
    
    // é»˜è®¤å®ç°ï¼šä½¿ç”¨ HttpService
    // TODO: é›†æˆ HttpService
    // return HttpService::instance().post("/api/logs", logs);
    
    // ä¸´æ—¶ï¼šæ‰“å°åˆ°æ§åˆ¶å°
    printf("[LogUpload] Uploading %zu bytes\n", logs.size());
    return true;
}

void LogUploadService::setUploadCallback(std::function<bool(const std::string&)> cb) {
    upload_cb_ = std::move(cb);
}
```

---

## å…­ã€ä¸ºä»€ä¹ˆ syslog æœ¬èº«ç»ä¸èƒ½å•ç‹¬çº¿ç¨‹ï¼Ÿ

è¿™æ˜¯å¾ˆå¤šäººä¼šçŠ¯çš„é”™ã€‚

### âŒ é”™è¯¯æ¨¡å‹

```
ä¸šåŠ¡çº¿ç¨‹ â†’ log queue â†’ log thread â†’ syslog()
```

### ä¸ºä»€ä¹ˆé”™ï¼Ÿ

* syslogd å·²ç»æ˜¯é˜Ÿåˆ—
* ä½ åŠ çº¿ç¨‹ = å»¶è¿Ÿ + é¡ºåºé”™ä¹±
* å´©æºƒå‰æ—¥å¿—åè€Œæ²¡åˆ·è¿›å»

ğŸ‘‰ **syslog å°±æ˜¯"åŒæ­¥ç‚¹"**

---

### âœ… æ­£ç¡®æ¨¡å‹

```
ä¸šåŠ¡çº¿ç¨‹ â†’ syslog() â†’ syslogd (ç³»ç»Ÿè¿›ç¨‹)
```

**ç›´æ¥è°ƒç”¨ï¼Œä¸è¦åŒ…è£…çº¿ç¨‹ã€‚**

---

## ä¸ƒã€F133/Tina ä¸‹ syslog çš„æœ€ä½³å®è·µ

ä½ å¯ä»¥ç›´æ¥æŠ„èµ°ã€‚

---

### âœ… æœ€ä½³å®è·µ 1ï¼šç»Ÿä¸€ openlog

```c
// main.cpp å¯åŠ¨æ—¶
openlog("ktv", LOG_PID | LOG_NDELAY, LOG_USER);
```

å¯åŠ¨æ—¶ä¸€æ¬¡å³å¯ã€‚

---

### âœ… æœ€ä½³å®è·µ 2ï¼šæ¨¡å—åŒ– tag

```c
syslog(LOG_INFO, "[ktv][ui] page switch to home");
syslog(LOG_INFO, "[ktv][player] start song_id=%s", id);
syslog(LOG_ERR,  "[ktv][net] request failed code=%d", err);
syslog(LOG_WARNING, "[ktv][db] cache miss key=%s", key);
```

logread è¿‡æ»¤éå¸¸å¥½ç”¨ï¼š

```sh
logread | grep "[ktv][player]"  # åªçœ‹æ’­æ”¾å™¨æ—¥å¿—
logread | grep "[ktv][net]"     # åªçœ‹ç½‘ç»œæ—¥å¿—
```

---

### âœ… æœ€ä½³å®è·µ 3ï¼šæ§åˆ¶çº§åˆ«

| çº§åˆ« | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| **LOG_ERR** | å¿…ä¼  | æ’­æ”¾å¤±è´¥ã€ç½‘ç»œé”™è¯¯ |
| **LOG_WARNING** | æ¡ä»¶ä¼  | è¶…æ—¶ã€é‡è¯• |
| **LOG_INFO** | è°ƒè¯• | çŠ¶æ€åˆ‡æ¢ã€å…³é”®æ“ä½œ |
| **LOG_DEBUG** | ç”Ÿäº§å…³é—­ | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ |

---

### âœ… æœ€ä½³å®è·µ 4ï¼šæ—¥å¿—ä¸Šä¼ "æŒ‰éœ€"

è§¦å‘æ¡ä»¶ï¼š

* æ’­æ”¾å¤±è´¥
* è¿ç»­ç½‘ç»œé”™è¯¯
* ç”¨æˆ·åé¦ˆ
* è¿ç»´å‘½ä»¤

```cpp
// æ’­æ”¾å¤±è´¥æ—¶è§¦å‘ä¸Šä¼ 
void PlayerAdapter::onError(int code) {
    syslog(LOG_ERR, "[ktv][player] error code=%d", code);
    LogUploadService::instance().triggerUpload();
}
```

---

### âœ… æœ€ä½³å®è·µ 5ï¼šä¸è¦é•¿æœŸè½ç›˜

Flash å†™æ”¾å¤§ + å¯¿å‘½é—®é¢˜ã€‚

**Tina é…ç½®å»ºè®®**ï¼š

* syslogd åªä½¿ç”¨å†…å­˜ ring buffer
* ä¸é…ç½®æŒä¹…åŒ–å­˜å‚¨
* æ—¥å¿—ä¸Šä¼ åå³ä¸¢å¼ƒ

---

## å…«ã€å¿…é¡»æå‰è§„é¿çš„ 10 ä¸ªå‘

### âŒ å‘ 1ï¼šæŠŠ syslog å½“æ•°æ®åº“

å®ƒä¸æ˜¯æŒä¹…åŒ–ç³»ç»Ÿã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š

```c
// âŒ é”™è¯¯ï¼šç”¨ syslog å­˜å‚¨ä¸šåŠ¡æ•°æ®
syslog(LOG_INFO, "user_id=%d, song_id=%d, play_time=%d", ...);
```

**æ­£ç¡®åšæ³•**ï¼š

```c
// âœ… æ­£ç¡®ï¼šåªè®°å½•å…³é”®äº‹ä»¶
syslog(LOG_INFO, "[ktv][player] user play song_id=%d", song_id);
```

---

### âŒ å‘ 2ï¼šé«˜é¢‘æ‰“ log

UI tick / æ’­æ”¾å›è°ƒç¦æ­¢ã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š

```c
// âŒ é”™è¯¯ï¼šåœ¨ UI tick ä¸­æ‰“ log
void ui_tick() {
    syslog(LOG_DEBUG, "[ktv][ui] tick");  // ç¦æ­¢ï¼
}
```

**æ­£ç¡®åšæ³•**ï¼š

```c
// âœ… æ­£ç¡®ï¼šåªåœ¨å…³é”®äº‹ä»¶æ‰“ log
void onPageSwitch(const char* page) {
    syslog(LOG_INFO, "[ktv][ui] page switch to %s", page);
}
```

---

### âŒ å‘ 3ï¼šåœ¨éŸ³é¢‘çº¿ç¨‹æ‰“ log

ç›´æ¥å½±å“å®æ—¶æ€§ã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š

```c
// âŒ é”™è¯¯ï¼šåœ¨éŸ³é¢‘å›è°ƒä¸­æ‰“ log
void audio_callback(void* data, int len) {
    syslog(LOG_DEBUG, "[ktv][audio] callback len=%d", len);  // ç¦æ­¢ï¼
}
```

**æ­£ç¡®åšæ³•**ï¼š

```c
// âœ… æ­£ç¡®ï¼šéŸ³é¢‘çº¿ç¨‹ä¸æ‰“ logï¼Œæˆ–åªåœ¨é”™è¯¯æ—¶æ‰“
void audio_callback(void* data, int len) {
    // æ­£å¸¸æµç¨‹ä¸æ‰“ log
    if (error) {
        syslog(LOG_ERR, "[ktv][audio] error");  // åªåœ¨é”™è¯¯æ—¶
    }
}
```

---

### âŒ å‘ 4ï¼šå®æ—¶ä¸Šä¼ 

è¿™æ˜¯åŠŸè€— + ç¨³å®šæ€§åŒæ€ã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š

```c
// âŒ é”™è¯¯ï¼šæ¯æ¬¡æ‰“ log éƒ½ä¸Šä¼ 
void log_and_upload(const char* msg) {
    syslog(LOG_INFO, msg);
    LogUploadService::instance().triggerUpload();  // ç¦æ­¢ï¼
}
```

**æ­£ç¡®åšæ³•**ï¼š

```c
// âœ… æ­£ç¡®ï¼šæŒ‰éœ€è§¦å‘ä¸Šä¼ 
void onCriticalError() {
    syslog(LOG_ERR, "[ktv] critical error");
    LogUploadService::instance().triggerUpload();  // åªåœ¨å…³é”®é”™è¯¯æ—¶
}
```

---

### âŒ å‘ 5ï¼šlogread -f å¸¸é©»

CPU + ç”µæºæ€æ‰‹ã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š

```cpp
// âŒ é”™è¯¯ï¼šå¸¸é©» logread -f
void LogUploadService::threadLoop() {
    FILE* fp = popen("logread -f", "r");  // ç¦æ­¢ï¼
    // ...
}
```

**æ­£ç¡®åšæ³•**ï¼š

```cpp
// âœ… æ­£ç¡®ï¼šæŒ‰éœ€æ‰§è¡Œ logread
bool LogUploadService::collectLogs(std::string& out) {
    FILE* fp = popen("logread", "r");  // ä¸€æ¬¡æ€§è¯»å–
    // ...
}
```

---

### âŒ å‘ 6ï¼šæ—¥å¿—å¸¦ token / url

å®‰å…¨äº‹æ•…æºå¤´ã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š

```c
// âŒ é”™è¯¯ï¼šæ—¥å¿—åŒ…å«æ•æ„Ÿä¿¡æ¯
syslog(LOG_INFO, "[ktv][net] request url=%s, token=%s", url, token);
```

**æ­£ç¡®åšæ³•**ï¼š

```c
// âœ… æ­£ç¡®ï¼šæ—¥å¿—ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯
syslog(LOG_INFO, "[ktv][net] request endpoint=/api/songs");
```

---

### âŒ å‘ 7ï¼šç”Ÿäº§ç‰ˆæœ¬å¼€ DEBUG

å¿…å‡ºäº‹ã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š

```c
// âŒ é”™è¯¯ï¼šç”Ÿäº§ç‰ˆæœ¬æ‰“ DEBUG æ—¥å¿—
#ifdef DEBUG
    syslog(LOG_DEBUG, "[ktv] debug info");
#endif
```

**æ­£ç¡®åšæ³•**ï¼š

```c
// âœ… æ­£ç¡®ï¼šç”Ÿäº§ç‰ˆæœ¬å…³é—­ DEBUG
#if defined(DEBUG) && DEBUG_LEVEL >= 2
    syslog(LOG_DEBUG, "[ktv] debug info");
#endif
```

---

### âŒ å‘ 8ï¼šæ—¥å¿—æ ¼å¼éšæ„

åæœŸæ— æ³•è‡ªåŠ¨åˆ†æã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š

```c
// âŒ é”™è¯¯ï¼šæ ¼å¼ä¸ç»Ÿä¸€
syslog(LOG_INFO, "player start");
syslog(LOG_INFO, "[player] start");
syslog(LOG_INFO, "player: start");
```

**æ­£ç¡®åšæ³•**ï¼š

```c
// âœ… æ­£ç¡®ï¼šç»Ÿä¸€æ ¼å¼
syslog(LOG_INFO, "[ktv][player] start song_id=%s", id);
syslog(LOG_INFO, "[ktv][net] request endpoint=%s", endpoint);
```

---

### âŒ å‘ 9ï¼šä¾èµ–æ—¥å¿—æ¢å¤ä¸šåŠ¡

æ—¥å¿—åªç”¨äºè¯Šæ–­ã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š

```c
// âŒ é”™è¯¯ï¼šä»æ—¥å¿—æ¢å¤çŠ¶æ€
void restoreState() {
    FILE* fp = popen("logread | grep state", "r");
    // è§£ææ—¥å¿—æ¢å¤çŠ¶æ€  // ç¦æ­¢ï¼
}
```

**æ­£ç¡®åšæ³•**ï¼š

```c
// âœ… æ­£ç¡®ï¼šç”¨æ•°æ®åº“/é…ç½®æ–‡ä»¶æ¢å¤çŠ¶æ€
void restoreState() {
    // ä»æ•°æ®åº“æˆ–é…ç½®æ–‡ä»¶æ¢å¤
    ConfigService::instance().load();
}
```

---

### âŒ å‘ 10ï¼šè®¤ä¸º syslog "æ…¢"

99% çš„æ…¢æ˜¯ä½ ç”¨é”™ã€‚

**å¸¸è§è¯¯è§£**ï¼š

* "syslog ä¼šé˜»å¡"
* "syslog æ€§èƒ½å·®"

**äº‹å®**ï¼š

* syslog æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œéå¸¸å¿«
* æ…¢çš„æ˜¯ä½ çš„ç”¨æ³•ï¼ˆé«˜é¢‘ã€å¤§å¯¹è±¡ã€ç½‘ç»œä¸Šä¼ ï¼‰

---

## ä¹ã€æ—¥å¿—è§„èŒƒï¼ˆtag / çº§åˆ« / ç¤ºä¾‹ï¼‰

### 1ï¸âƒ£ Tag è§„èŒƒ

**æ ¼å¼**ï¼š`[ktv][module]`

**æ¨¡å—åˆ—è¡¨**ï¼š

| æ¨¡å— | Tag | è¯´æ˜ |
|------|-----|------|
| UI | `[ktv][ui]` | é¡µé¢åˆ‡æ¢ã€æ§ä»¶æ“ä½œ |
| æ’­æ”¾å™¨ | `[ktv][player]` | æ’­æ”¾ã€æš‚åœã€åˆ‡æ­Œ |
| ç½‘ç»œ | `[ktv][net]` | HTTP è¯·æ±‚ã€WebSocket |
| æ•°æ®åº“ | `[ktv][db]` | ç¼“å­˜ã€æŒä¹…åŒ– |
| æ—¥å¿— | `[ktv][log]` | æ—¥å¿—ä¸Šä¼ ã€æ”¶é›† |
| ç³»ç»Ÿ | `[ktv][sys]` | å¯åŠ¨ã€å…³é—­ã€é…ç½® |

---

### 2ï¸âƒ£ çº§åˆ«è§„èŒƒ

| çº§åˆ« | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| **LOG_ERR** | é”™è¯¯ï¼ˆå¿…ä¼ ï¼‰ | æ’­æ”¾å¤±è´¥ã€ç½‘ç»œé”™è¯¯ã€ç³»ç»Ÿå¼‚å¸¸ |
| **LOG_WARNING** | è­¦å‘Šï¼ˆæ¡ä»¶ä¼ ï¼‰ | è¶…æ—¶ã€é‡è¯•ã€é™çº§ |
| **LOG_INFO** | ä¿¡æ¯ï¼ˆè°ƒè¯•ï¼‰ | çŠ¶æ€åˆ‡æ¢ã€å…³é”®æ“ä½œ |
| **LOG_DEBUG** | è°ƒè¯•ï¼ˆç”Ÿäº§å…³é—­ï¼‰ | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ |

---

### 3ï¸âƒ£ ç¤ºä¾‹ä»£ç 

```c
// å¯åŠ¨æ—¶åˆå§‹åŒ–
openlog("ktv", LOG_PID | LOG_NDELAY, LOG_USER);

// UI å±‚
syslog(LOG_INFO, "[ktv][ui] page switch to home");
syslog(LOG_WARNING, "[ktv][ui] page switch timeout");

// æ’­æ”¾å™¨å±‚
syslog(LOG_INFO, "[ktv][player] start song_id=%s", song_id);
syslog(LOG_ERR, "[ktv][player] play failed code=%d", err_code);

// ç½‘ç»œå±‚
syslog(LOG_INFO, "[ktv][net] request endpoint=/api/songs");
syslog(LOG_ERR, "[ktv][net] request failed code=%d", http_code);

// æ—¥å¿—ä¸Šä¼ 
syslog(LOG_INFO, "[ktv][log] upload triggered");
syslog(LOG_ERR, "[ktv][log] upload failed");
```

---

## ğŸ¯ æ€»ç»“

### ä¸€å¥è¯ç»“è®ºï¼ˆå¯ç›´æ¥å®šç¨¿ï¼‰

> **syslog æ˜¯ F133 ä¸Šæœ€ç¨³å¦¥ã€æœ€æˆç†Ÿã€æœ€ä½ç»´æŠ¤æˆæœ¬çš„æ—¥å¿—æ–¹æ¡ˆã€‚**
> **å‰ææ˜¯ï¼šä½ åªç”¨å®ƒåš"è®°å½•"ï¼Œä¸è®©å®ƒèƒŒä¸šåŠ¡è´£ä»»ï¼Œä¸Šä¼ é€»è¾‘å®Œå…¨è§£è€¦ã€‚**

### æ¶æ„åŸåˆ™

1. âœ… **syslog ç›´æ¥è°ƒç”¨**ï¼šä¸è¦åŒ…è£…çº¿ç¨‹ï¼Œä¸è¦é˜Ÿåˆ—
2. âœ… **LogUploadService ç‹¬ç«‹çº¿ç¨‹**ï¼šä½ä¼˜å…ˆçº§ï¼ŒæŒ‰éœ€è§¦å‘
3. âœ… **æ—¥å¿—æ ¼å¼ç»Ÿä¸€**ï¼š`[ktv][module] message`
4. âœ… **çº§åˆ«æ§åˆ¶**ï¼šç”Ÿäº§å…³é—­ DEBUG
5. âœ… **ä¸Šä¼ æŒ‰éœ€**ï¼šåªåœ¨å…³é”®é”™è¯¯æ—¶è§¦å‘

### ç³»ç»Ÿè¾¹ç•Œ

```
KTV App â†’ syslog() â†’ syslogd â†’ logread â†’ LogUploadService â†’ HTTP
```

**å„å±‚èŒè´£æ¸…æ™°ï¼Œäº’ä¸å¹²æ‰°ã€‚**

---

**æœ€åæ›´æ–°**: 2025-12-30  
**çŠ¶æ€**: âœ… æ ¸å¿ƒæ–‡æ¡£ï¼Œæ—¥å¿—å­ç³»ç»Ÿè®¾è®¡è¯´æ˜


