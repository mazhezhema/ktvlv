# å·¥ç¨‹è§„èŒƒç¡¬è§„åˆ™ï¼ˆé‡äº§çº§ï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
> **æœ€åæ›´æ–°**ï¼š2025-12-30  
> **çŠ¶æ€**ï¼šâœ… æ ¸å¿ƒæ–‡æ¡£ï¼ˆå·¥ç¨‹è§„èŒƒ - ç¡¬è§„åˆ™ï¼‰  
> **é€‚ç”¨å¹³å°**ï¼šF133 / Tina Linux  
> **ç›®æ ‡**ï¼šå®šä¹‰é‡äº§çº§å·¥ç¨‹è§„èŒƒç¡¬è§„åˆ™ï¼Œé˜²æ­¢å›¢é˜Ÿå˜å¤§åå¤±æ§

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼ˆä¸€å¥è¯ï¼‰

> **è¿™äº›ä¸æ˜¯æŠ€æœ¯éš¾ç‚¹ï¼Œæ˜¯é˜²æ­¢å›¢é˜Ÿå˜å¤§åå¤±æ§çš„ç¡¬è§„åˆ™ã€‚**

---

## ğŸ“‹ ç›®å½•

1. [æ—¥å¿—åˆ†çº§è§„èŒƒ](#ä¸€-æ—¥å¿—åˆ†çº§è§„èŒƒ)
2. [è·¨çº¿ç¨‹UIæ›´æ–°è§„åˆ™](#äºŒ-è·¨çº¿ç¨‹uiæ›´æ–°è§„åˆ™)
3. [é…ç½®æ–‡ä»¶å¯å˜æ€§è¾¹ç•Œ](#ä¸‰-é…ç½®æ–‡ä»¶å¯å˜æ€§è¾¹ç•Œ)
4. [æ—¶é—´æºç»Ÿä¸€çº¦å®š](#å››-æ—¶é—´æºç»Ÿä¸€çº¦å®š)
5. [å¤–éƒ¨SDKéš”ç¦»å±‚å£°æ˜](#äº”-å¤–éƒ¨sdkéš”ç¦»å±‚å£°æ˜)
6. [æ˜ç¡®ç¦æ­¢é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰](#å…­-æ˜ç¡®ç¦æ­¢é¡¹é¿å‘æŒ‡å—)

---

## ä¸€ã€æ—¥å¿—åˆ†çº§è§„èŒƒ

### 4 çº§æ—¥å¿—åˆ†çº§

| çº§åˆ« | ç”¨é€” | ä¸ŠæŠ¥ç­–ç•¥ | æ‰“å°é¢‘ç‡é™åˆ¶ |
|------|------|---------|------------|
| **ERROR** | ç³»ç»Ÿé”™è¯¯ã€å¼‚å¸¸ | å¿…é¡»ä¸ŠæŠ¥ | ç¦æ­¢åœ¨é«˜é¢‘å¾ªç¯ä¸­æ‰“å° |
| **WARN** | è­¦å‘Šã€å¯èƒ½å½±å“ä½“éªŒ | å»ºè®®ä¸ŠæŠ¥ | ç¦æ­¢åœ¨é«˜é¢‘å¾ªç¯ä¸­æ‰“å° |
| **INFO** | ä¸šåŠ¡å…³é”®è·¯å¾„ | ä¸ä¸ŠæŠ¥ | å…è®¸åœ¨å…³é”®è·¯å¾„æ‰“å° |
| **DEBUG** | è°ƒè¯•ä¿¡æ¯ | ä¸ä¸ŠæŠ¥ | é»˜è®¤å…³é—­ï¼Œå¼€å‘æ—¶å¯ç”¨ |

### ç¡¬è§„åˆ™

> **ERROR / WARN æ—¥å¿—ç¦æ­¢åœ¨é«˜é¢‘å¾ªç¯ä¸­æ‰“å°**

**åŸå› **ï¼š
- é«˜é¢‘å¾ªç¯ä¸­æ‰“å°æ—¥å¿—ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜
- æ—¥å¿—æ–‡ä»¶å¿«é€Ÿå¢é•¿ï¼Œå ç”¨ç£ç›˜ç©ºé—´
- æ—¥å¿—ç³»ç»Ÿæˆä¸ºæ€§èƒ½ç“¶é¢ˆ

**æ­£ç¡®åšæ³•**ï¼š
```cpp
// âŒ é”™è¯¯ï¼šåœ¨é«˜é¢‘å¾ªç¯ä¸­æ‰“å° ERROR
void playerLoop() {
    while (running_) {
        if (checkError()) {
            syslog(LOG_ERR, "[ktv][player] Error detected");  // é”™è¯¯ï¼
        }
        processFrame();
    }
}

// âœ… æ­£ç¡®ï¼šé”™è¯¯è®¡æ•°ï¼Œå®šæœŸä¸ŠæŠ¥
void playerLoop() {
    int error_count = 0;
    while (running_) {
        if (checkError()) {
            error_count++;
            // ä¸ç«‹å³æ‰“å°ï¼Œè€Œæ˜¯è®¡æ•°
        }
        processFrame();
        
        // æ¯ 1000 æ¬¡å¾ªç¯æ£€æŸ¥ä¸€æ¬¡
        if (loop_count % 1000 == 0 && error_count > 0) {
            syslog(LOG_ERR, "[ktv][player] Error count: %d", error_count);
            error_count = 0;
        }
    }
}
```

---

## äºŒã€è·¨çº¿ç¨‹UIæ›´æ–°è§„åˆ™

### ç¡¬è§„åˆ™

> **UI åªèƒ½åœ¨ UI çº¿ç¨‹æ›´æ–°ï¼Œå…¶ä»–çº¿ç¨‹åªèƒ½é€šè¿‡ Event / Message é€šçŸ¥ã€‚**

**åŸå› **ï¼š
- LVGL ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
- è·¨çº¿ç¨‹ç›´æ¥æ›´æ–° UI ä¼šå¯¼è‡´å´©æºƒæˆ–æ•°æ®ç«äº‰
- å¿…é¡»é€šè¿‡äº‹ä»¶æœºåˆ¶ä¿è¯çº¿ç¨‹å®‰å…¨

**æ­£ç¡®åšæ³•**ï¼š
```cpp
// âŒ é”™è¯¯ï¼šè·¨çº¿ç¨‹ç›´æ¥æ›´æ–° UI
void NetworkWorker::onResponseReceived(const Response& resp) {
    // é”™è¯¯ï¼åœ¨é UI çº¿ç¨‹ç›´æ¥æ›´æ–° UI
    lv_label_set_text(ui_label, resp.text.c_str());
}

// âœ… æ­£ç¡®ï¼šé€šè¿‡ Event é€šçŸ¥ UI çº¿ç¨‹
void NetworkWorker::onResponseReceived(const Response& resp) {
    // å‘é€äº‹ä»¶åˆ° UI çº¿ç¨‹
    EventBus::getInstance().publish(Event{
        EventType::UPDATE_LABEL,
        resp.text
    });
}

// UI çº¿ç¨‹æ¶ˆè´¹äº‹ä»¶
void UISystem::onEvent(const Event& ev) {
    if (ev.type == EventType::UPDATE_LABEL) {
        // æ­£ç¡®ï¼åœ¨ UI çº¿ç¨‹æ›´æ–° UI
        lv_label_set_text(ui_label, ev.data.c_str());
    }
}
```

---

## ä¸‰ã€é…ç½®æ–‡ä»¶å¯å˜æ€§è¾¹ç•Œ

### ä¸‰ç±»é…ç½®

| é…ç½®ç±»å‹ | è¯»å–æ—¶æœº | å¯å˜æ€§ | å‡çº§è¦†ç›– | ç¤ºä¾‹ |
|---------|---------|--------|---------|------|
| **å¼€æœºè¯»ä¸€æ¬¡** | åº”ç”¨å¯åŠ¨æ—¶ | ä¸å¯å˜ | ä¸è¦†ç›– | è®¾å¤‡åºåˆ—å·ã€MACåœ°å€ |
| **è¿è¡ŒæœŸå¯å˜** | åº”ç”¨è¿è¡Œæ—¶ | å¯å˜ | ä¸è¦†ç›– | éŸ³é‡è®¾ç½®ã€æ’­æ”¾æ¨¡å¼ |
| **å‡çº§è¦†ç›–** | åº”ç”¨å¯åŠ¨æ—¶ | å¯å˜ | è¦†ç›– | æœåŠ¡å™¨åœ°å€ã€åŠŸèƒ½å¼€å…³ |

### ç¡¬è§„åˆ™

> **å¿…é¡»æ˜ç¡®æ¯ç±»é…ç½®çš„è¯»å–æ—¶æœºã€å¯å˜æ€§å’Œå‡çº§è¦†ç›–ç­–ç•¥**

**å®ç°ç¤ºä¾‹**ï¼š
```cpp
class Config {
public:
    // å¼€æœºè¯»ä¸€æ¬¡ï¼ˆä¸å¯å˜ï¼‰
    struct BootConfig {
        std::string device_serial;
        std::string mac_address;
    } boot_config;

    // è¿è¡ŒæœŸå¯å˜ï¼ˆä¸è¦†ç›–ï¼‰
    struct RuntimeConfig {
        int volume;
        bool play_mode;
    } runtime_config;

    // å‡çº§è¦†ç›–ï¼ˆå¯å˜ï¼‰
    struct UpgradeConfig {
        std::string server_url;
        bool feature_enabled;
    } upgrade_config;

    void load() {
        // åŠ è½½å¼€æœºé…ç½®ï¼ˆåªè¯»ä¸€æ¬¡ï¼‰
        loadBootConfig();

        // åŠ è½½è¿è¡ŒæœŸé…ç½®ï¼ˆå¯ä¿®æ”¹ï¼‰
        loadRuntimeConfig();

        // åŠ è½½å‡çº§é…ç½®ï¼ˆå‡çº§æ—¶è¦†ç›–ï¼‰
        loadUpgradeConfig();
    }

    void saveRuntimeConfig() {
        // åªä¿å­˜è¿è¡ŒæœŸé…ç½®
        saveToFile("runtime.conf", runtime_config);
    }
};
```

---

## å››ã€æ—¶é—´æºç»Ÿä¸€çº¦å®š

### ç¡¬è§„åˆ™

> **æ‰€æœ‰ä¸šåŠ¡æ—¶é—´ç»Ÿä¸€ä½¿ç”¨ monotonic clockï¼Œç¦æ­¢ç›´æ¥ä½¿ç”¨ wall clock å‚ä¸ä¸šåŠ¡åˆ¤æ–­ã€‚**

**åŸå› **ï¼š
- Wall clock å¯èƒ½è¢«ç³»ç»Ÿæ—¶é—´è°ƒæ•´å½±å“ï¼ˆNTP åŒæ­¥ã€æ‰‹åŠ¨è°ƒæ•´ï¼‰
- Monotonic clock ä¸å—ç³»ç»Ÿæ—¶é—´è°ƒæ•´å½±å“ï¼Œé€‚åˆä¸šåŠ¡åˆ¤æ–­
- KTV åœºæ™¯ä¸­ï¼Œæ’­æ”¾è¿›åº¦ã€è¶…æ—¶åˆ¤æ–­ç­‰å¿…é¡»ä½¿ç”¨ monotonic clock

**æ­£ç¡®åšæ³•**ï¼š
```cpp
#include <time.h>
#include <sys/time.h>

// âŒ é”™è¯¯ï¼šä½¿ç”¨ wall clock
void checkTimeout() {
    time_t now = time(nullptr);  // é”™è¯¯ï¼wall clock
    if (now - start_time > TIMEOUT) {
        // å¦‚æœç³»ç»Ÿæ—¶é—´è¢«è°ƒæ•´ï¼Œè¿™é‡Œä¼šå‡ºé”™
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ monotonic clock
void checkTimeout() {
    struct timespec ts;
    clock_gettime(CLOCK_MONOTONIC, &ts);  // æ­£ç¡®ï¼monotonic clock
    int64_t now_ms = ts.tv_sec * 1000 + ts.tv_nsec / 1000000;
    if (now_ms - start_time_ms > TIMEOUT_MS) {
        // ä¸å—ç³»ç»Ÿæ—¶é—´è°ƒæ•´å½±å“
    }
}
```

---

## äº”ã€å¤–éƒ¨SDKéš”ç¦»å±‚å£°æ˜

### ç¡¬è§„åˆ™

> **ä¸‰æ–¹åº“å¿…é¡»é€šè¿‡ Adapter å±‚è®¿é—®ï¼Œç¦æ­¢ä¸šåŠ¡å±‚ç›´æ¥è°ƒç”¨ç¬¬ä¸‰æ–¹ APIã€‚**

**åŸå› **ï¼š
- é˜²æ­¢åæœŸæŠ€æœ¯å€ºçˆ†ç‚¸
- ä¾¿äºæ›¿æ¢ç¬¬ä¸‰æ–¹åº“
- ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**å½“å‰ç¬¬ä¸‰æ–¹åº“**ï¼š
- TPlayerï¼ˆå…¨å¿—å®˜æ–¹æ’­æ”¾å™¨ SDKï¼‰
- libcurlï¼ˆHTTP å®¢æˆ·ç«¯ï¼‰
- cJSONï¼ˆJSON è§£æï¼‰

**æ­£ç¡®åšæ³•**ï¼š
```cpp
// âŒ é”™è¯¯ï¼šä¸šåŠ¡å±‚ç›´æ¥è°ƒç”¨ç¬¬ä¸‰æ–¹ API
void PlayController::play(const std::string& url) {
    tplayer_play(url.c_str());  // é”™è¯¯ï¼ç›´æ¥è°ƒç”¨ TPlayer API
}

// âœ… æ­£ç¡®ï¼šé€šè¿‡ Adapter å±‚è®¿é—®
void PlayController::play(const std::string& url) {
    PlayerAdapter::instance().play(url);  // æ­£ç¡®ï¼é€šè¿‡ Adapter
}

// Adapter å±‚å°è£…ç¬¬ä¸‰æ–¹ API
class PlayerAdapter {
public:
    void play(const std::string& url) {
        syslog(LOG_INFO, "[ktv][player] Playing: %s", url.c_str());
        int ret = tplayer_play(url.c_str());  // åœ¨ Adapter å±‚è°ƒç”¨
        if (ret != 0) {
            syslog(LOG_ERR, "[ktv][player] Play failed: %d", ret);
            // ç»Ÿä¸€é”™è¯¯å¤„ç†
        }
    }
};
```

---

## å…­ã€æ˜ç¡®ç¦æ­¢é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰

### ğŸš« ç¦æ­¢åœ¨å›è°ƒä¸­åšé˜»å¡æ“ä½œ

```cpp
// âŒ é”™è¯¯ï¼šåœ¨å›è°ƒä¸­åšé˜»å¡æ“ä½œ
void onButtonClick() {
    HttpService::instance().get(url);  // é”™è¯¯ï¼é˜»å¡æ“ä½œ
}

// âœ… æ­£ç¡®ï¼šå¼‚æ­¥å¤„ç†
void onButtonClick() {
    NetworkWorker::instance().post([url]() {
        HttpService::instance().get(url);
    });
}
```

### ğŸš« ç¦æ­¢åœ¨ UI çº¿ç¨‹è®¿é—®ç½‘ç»œ / IO

```cpp
// âŒ é”™è¯¯ï¼šåœ¨ UI çº¿ç¨‹è®¿é—®ç½‘ç»œ
void onButtonClick() {
    auto response = HttpService::instance().get(url);  // é”™è¯¯ï¼
}

// âœ… æ­£ç¡®ï¼šæŠ•é€’åˆ°å·¥ä½œçº¿ç¨‹
void onButtonClick() {
    NetworkWorker::instance().post([url]() {
        auto response = HttpService::instance().get(url);
        // é€šè¿‡ Event å›ä¼ ç»“æœ
    });
}
```

### ğŸš« ç¦æ­¢åœ¨ææ„å‡½æ•°ä¸­é˜»å¡ç­‰å¾…å¤–éƒ¨èµ„æº

```cpp
// âŒ é”™è¯¯ï¼šåœ¨ææ„å‡½æ•°ä¸­é˜»å¡ç­‰å¾…
~NetworkWorker() {
    curl_easy_cleanup(handle_);  // å¦‚æœ handle_ æ­£åœ¨ä½¿ç”¨ï¼Œå¯èƒ½é˜»å¡
}

// âœ… æ­£ç¡®ï¼šåœ¨ stop() ä¸­æ¸…ç†
void stop() {
    running_.store(false);
    // ç­‰å¾…å½“å‰è¯·æ±‚å®Œæˆ
    waitForCurrentRequest();
    curl_easy_cleanup(handle_);
}
```

### ğŸš« ç¦æ­¢æ¨¡å—é—´ç›¸äº’æŒæœ‰è£¸æŒ‡é’ˆ

```cpp
// âŒ é”™è¯¯ï¼šæ¨¡å—é—´ç›¸äº’æŒæœ‰è£¸æŒ‡é’ˆ
class NetworkWorker {
    PlayerAdapter* player_;  // é”™è¯¯ï¼è£¸æŒ‡é’ˆ
};

// âœ… æ­£ç¡®ï¼šé€šè¿‡ Singleton è®¿é—®
class NetworkWorker {
    void notifyPlayer() {
        PlayerAdapter::instance().onNetworkEvent();  // æ­£ç¡®ï¼é€šè¿‡ Singleton
    }
};
```

### ğŸš« ç¦æ­¢éšå¼å¯åŠ¨åå°çº¿ç¨‹

```cpp
// âŒ é”™è¯¯ï¼šéšå¼å¯åŠ¨åå°çº¿ç¨‹
void HttpService::get(const std::string& url) {
    std::thread([url]() {
        // é”™è¯¯ï¼éšå¼åˆ›å»ºçº¿ç¨‹
        performHttpRequest(url);
    }).detach();
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å·²æœ‰çš„å·¥ä½œçº¿ç¨‹
void HttpService::get(const std::string& url) {
    NetworkWorker::instance().post([url]() {
        // æ­£ç¡®ï¼ä½¿ç”¨å·²æœ‰çš„å·¥ä½œçº¿ç¨‹
        performHttpRequest(url);
    });
}
```

### ğŸš« ç¦æ­¢ç”¨ sleep ä½œä¸ºåŒæ­¥æ‰‹æ®µ

```cpp
// âŒ é”™è¯¯ï¼šç”¨ sleep ä½œä¸ºåŒæ­¥æ‰‹æ®µ
void waitForResponse() {
    while (!response_received_) {
        std::this_thread::sleep_for(std::chrono::milliseconds(100));  // é”™è¯¯ï¼
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ condition_variable
void waitForResponse() {
    std::unique_lock<std::mutex> lock(mtx_);
    cv_.wait(lock, [this]() {
        return response_received_;
    });
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [KTV_Appçº¿ç¨‹Singletonç¼–ç è§„èŒƒï¼ˆæœ€ç»ˆç‰ˆï¼‰.md](./KTV_Appçº¿ç¨‹Singletonç¼–ç è§„èŒƒï¼ˆæœ€ç»ˆç‰ˆï¼‰.md) â­â­â­ **å¿…è¯»**
- [ä»£ç å®¡æŸ¥Checklist.md](../ä»£ç å®¡æŸ¥Checklist.md) â­â­â­ **å¿…è¯»**
- [åº”ç”¨å¯åŠ¨é˜¶æ®µåˆ’åˆ†ä¸é€€å‡ºåŸåˆ™.md](../architecture/åº”ç”¨å¯åŠ¨é˜¶æ®µåˆ’åˆ†ä¸é€€å‡ºåŸåˆ™.md) â­â­â­ **å¿…è¯»**

---

**æœ€åæ›´æ–°**: 2025-12-30  
**ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ  
**çŠ¶æ€**: âœ… æ ¸å¿ƒæ–‡æ¡£ï¼ˆå·¥ç¨‹è§„èŒƒ - ç¡¬è§„åˆ™ï¼‰

